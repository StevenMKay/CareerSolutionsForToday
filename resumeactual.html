<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Resume Analyzer - Career Solutions for Today</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="site.css">
  <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/StevenMKay/CareerSolutionsForToday/24f41fc0ba84fa65c8b2fad5155b6b32c824486e/icons/CareerIcon.png" media="(prefers-color-scheme: dark)">
  <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/StevenMKay/CareerSolutionsForToday/b26be6501f1cd10eb39e1257de10c6d856ca6996/icons/Career%20Icon%20Blue.png" media="(prefers-color-scheme: light)">
  <style>
    /* Resume page specific styles */
    .resume-container {
      max-width: 1200px;
      margin: 110px auto 0 auto;
      padding: 30px 20px 60px 20px;
    }

    .resume-header {
      text-align: center;
      margin-bottom: 40px;
    }

    .resume-header h1 {
      color: white;
      font-size: 2.5em;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .resume-header p {
      color: white;
      font-size: 1.2em;
      opacity: 0.9;
    }

    .upload-section {
      background: rgba(255,255,255,0.15);
      border-radius: 18px;
      box-shadow: 0 2px 18px rgba(0,0,0,0.13);
      padding: 40px;
      margin-bottom: 30px;
      -webkit-backdrop-filter: blur(12px);
      backdrop-filter: blur(12px);
      color: white;
    }

    .upload-methods {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-bottom: 30px;
    }

    .upload-method {
      background: rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 30px;
      text-align: center;
      border: 2px dashed rgba(255,255,255,0.3);
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .upload-method:hover {
      border-color: rgba(255,255,255,0.6);
      background: rgba(255,255,255,0.2);
    }
    .upload-method.success {
      border-color: #4caf50;
      background: rgba(76, 175, 80, 0.2);
      box-shadow: 0 0 20px rgba(76, 175, 80, 0.3);
    }

    .upload-method.success h3 {
      color: #4caf50;
    }

    .upload-method h3 {
      color: white;
      margin-bottom: 15px;
      font-size: 1.3em;
    }

    .file-upload {
      position: relative;
      display: inline-block;
      width: 100%;
    }

    .file-upload input[type=file] {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }

    .upload-btn {
      background: #0b4f6c;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      transition: background 0.3s;
      width: 100%;
    }

    .upload-btn:hover {
      background: #0a4460;
    }

    .drag-drop-area {
      border: 2px dashed rgba(255,255,255,0.4);
      border-radius: 12px;
      padding: 40px;
      text-align: center;
      margin: 20px 0;
      transition: all 0.3s ease;
    }

    .drag-drop-area.dragover {
      border-color: #0b4f6c;
      background: rgba(11,79,108,0.1);
    }

    .drag-drop-area.success {
      border-color: #4caf50;
      background: rgba(76, 175, 80, 0.2);
      box-shadow: 0 0 20px rgba(76, 175, 80, 0.3);
    }

    /* Enhanced drag feedback */
    .drag-drop-area.drag-active {
      border-color: #2196f3;
      background: rgba(33, 150, 243, 0.15);
      box-shadow: 0 0 30px rgba(33, 150, 243, 0.4);
      transform: scale(1.02);
      transition: all 0.2s ease;
    }

    .drag-drop-area.drag-active::before {
      content: 'üìÑ Drop your resume here!';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(33, 150, 243, 0.9);
      color: white;
      padding: 15px 25px;
      border-radius: 8px;
      font-weight: bold;
      font-size: 16px;
      z-index: 10;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      animation: pulse 1.5s infinite;
    }

    .drag-drop-area.drag-active::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      border: 3px dashed #2196f3;
      border-radius: 12px;
      animation: dashMove 2s linear infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: translate(-50%, -50%) scale(1); }
      50% { transform: translate(-50%, -50%) scale(1.05); }
    }

    @keyframes dashMove {
      0% { border-dash-offset: 0; }
      100% { border-dash-offset: 20px; }
    }

    /* Body drag overlay */
    body.dragging::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(33, 150, 243, 0.1);
      z-index: 5;
      pointer-events: none;
    }

    .text-input-section {
      grid-column: 1 / -1;
    }

    .resume-textarea {
      width: 100%;
      min-height: 200px;
      padding: 15px;
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 8px;
      background: rgba(255,255,255,0.1);
      color: white;
      font-size: 14px;
      font-family: 'Segoe UI', sans-serif;
      resize: vertical;
    }

    .resume-textarea::placeholder {
      color: rgba(255,255,255,0.7);
    }

    .resume-textarea.success {
      border-color: #4caf50;
      background: rgba(76, 175, 80, 0.15);
      box-shadow: 0 0 15px rgba(76, 175, 80, 0.3);
    }

    .visually-hidden {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      border: 0;
    }

    .section-title {
      color: white;
      text-align: center;
      margin-bottom: 30px;
    }

    .section-title.tight {
      margin-bottom: 20px;
    }

    .section-subtext {
      text-align: center;
      margin-bottom: 30px;
      color: rgba(255,255,255,0.85);
    }

    .collapsible {
      text-align: left;
    }

    .collapsible-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .collapsible-header p {
      margin: 6px 0 0;
      color: rgba(255,255,255,0.8);
    }

    .collapsible-toggle {
      margin-top: 10px;
      background: rgba(255,255,255,0.15);
      border: 1px solid rgba(255,255,255,0.3);
      color: white;
      padding: 10px 16px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .collapsible-toggle:hover {
      background: rgba(255,255,255,0.25);
    }

    .collapsible-content {
      display: none;
      margin-top: 15px;
    }

    .collapsible.open .collapsible-content {
      display: block;
    }

    .collapsible-content[hidden] {
      display: none !important;
    }

    .resume-textarea.collapsible-target {
      min-height: 200px;
    }

    .job-description-textarea {
      min-height: 150px;
    }

    .analyze-btn {
      background: linear-gradient(45deg, #0b4f6c, #1976d2);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 18px;
      font-weight: bold;
      margin-top: 20px;
      transition: all 0.3s ease;
      display: block;
      margin: 20px auto 0 auto;
    }

    .analyze-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(11,79,108,0.4);
    }

    .analyze-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .feedback-section {
      background: rgba(255,255,255,0.15);
      border-radius: 18px;
      box-shadow: 0 2px 18px rgba(0,0,0,0.13);
      padding: 40px;
      margin-bottom: 30px;
      -webkit-backdrop-filter: blur(12px);
      backdrop-filter: blur(12px);
      color: white;
      display: none;
    }

    .feedback-section.show {
      display: block;
      animation: fadeIn 0.5s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .feedback-category {
      margin-bottom: 25px;
      padding: 20px;
      background: rgba(255,255,255,0.1);
      border-radius: 12px;
      border-left: 4px solid #1976d2;
    }

    .score-explanation {
      margin: 8px 0 12px;
      font-style: italic;
      color: rgba(255,255,255,0.85);
    }

    .positive-examples {
      margin-bottom: 12px;
    }

    .positive-examples strong {
      display: block;
      margin-bottom: 6px;
      color: rgba(255,255,255,0.95);
    }

    .positive-examples ul {
      margin: 0;
      padding-left: 20px;
      color: rgba(255,255,255,0.92);
    }

    .feedback-category h3 {
      color: white;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .feedback-category.good {
      border-left-color: #4caf50;
    }

    .feedback-category.warning {
      border-left-color: #ff9800;
    }

    .feedback-category.critical {
      border-left-color: #f44336;
    }

    .status-icon {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: inline-block;
    }

    .status-icon.good { background: #4caf50; }
    .status-icon.warning { background: #ff9800; }
    .status-icon.critical { background: #f44336; }

    .overall-score-card {
      text-align: center;
      margin-bottom: 30px;
    }

    .overall-score-title {
      color: white;
      font-size: 2em;
      margin-bottom: 10px;
    }

    .job-match-indicator {
      color: #7cf29d;
      margin-bottom: 10px;
    }

    .score-bar {
      width: 100%;
      background: rgba(255,255,255,0.2);
      border-radius: 10px;
      height: 20px;
      margin: 0 auto;
      max-width: 400px;
      overflow: hidden;
    }

    .score-bar-fill {
      height: 100%;
      border-radius: 10px;
      background: linear-gradient(90deg, #4caf50, #2196f3);
      width: 0;
      transition: width 0.5s ease;
    }

    .category-feedback {
      margin-bottom: 15px;
      color: rgba(255,255,255,0.85);
    }

    .suggestions-list {
      margin-top: 10px;
      padding-left: 20px;
    }

    .company-insights, .extra-insights {
      margin-top: 30px;
      padding: 25px;
      border-radius: 16px;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.15);
      opacity: 1 !important;
      transform: none !important;
      transition: none !important;
    }

    .extra-insights {
      background: rgba(18,60,120,0.4);
      border-color: rgba(66,165,245,0.5);
      box-shadow: 0 10px 30px rgba(15,76,129,0.25);
    }

    .company-insights h3, .extra-insights h3 {
      margin-top: 0;
      margin-bottom: 15px;
      color: white;
    }

    .company-insight-card {
      margin-bottom: 15px;
      padding: 15px;
      border-radius: 12px;
      background: rgba(11,79,108,0.2);
      border-left: 4px solid #42a5f5;
    }

    .company-insight-card p {
      margin: 8px 0;
      color: rgba(255,255,255,0.9);
    }

    .insight-action {
      margin-top: 4px;
    }

    .insight-action strong {
      color: #bbdefb;
    }

    .insight-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.9em;
      margin-top: 8px;
      color: #8ec5ff;
      text-decoration: none;
    }

    .insight-link:hover {
      text-decoration: underline;
    }

    .extra-insight-card {
      margin-bottom: 15px;
      padding: 15px;
      border-radius: 12px;
      background: rgba(33,150,243,0.12);
      border-left: 4px solid #64b5f6;
    }

    .extra-insight-card.status-good { border-left-color: #81d4fa; }
    .extra-insight-card.status-warning { border-left-color: #4fc3f7; }
    .extra-insight-card.status-critical { border-left-color: #29b6f6; }

    .extra-insight-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }

    .extra-insight-header h4 {
      margin: 0;
      color: white;
    }

    .insight-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.85em;
      padding: 4px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,0.15);
      margin-bottom: 8px;
    }

    .status-dot {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      border: 2px solid rgba(255,255,255,0.35);
      margin-bottom: 10px;
    }

    .status-dot.good { background: #a5d6ff; }
    .status-dot.warning { background: #8ec5ff; }
    .status-dot.critical { background: #5da7ff; }

    .extra-insight-card ul {
      margin: 10px 0 0 20px;
    }

    .download-section {
      background: rgba(255,255,255,0.15);
      border-radius: 18px;
      box-shadow: 0 2px 18px rgba(0,0,0,0.13);
      padding: 40px;
      -webkit-backdrop-filter: blur(12px);
      backdrop-filter: blur(12px);
      color: white;
    }

    .templates-cta {
      text-align: center;
      margin-top: 25px;
    }

    .template-link {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      background: linear-gradient(45deg, #0b4f6c, #42a5f5);
      color: white;
      padding: 14px 28px;
      border-radius: 999px;
      text-decoration: none;
      font-weight: 600;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .template-link:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 18px rgba(11,79,108,0.35);
    }

    .progress-bar {
      width: 100%;
      height: 4px;
      background: rgba(255,255,255,0.2);
      border-radius: 2px;
      margin: 20px 0;
      overflow: hidden;
      display: none;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #0b4f6c, #1976d2);
      width: 0%;
      transition: width 0.3s ease;
    }

    @media (max-width: 768px) {
      .upload-methods {
        grid-template-columns: 1fr;
        gap: 20px;
      }

      .resume-container {
        padding: 20px 15px;
      }

      .upload-section, .feedback-section, .download-section {
        padding: 25px;
      }

      .resume-header h1 {
        font-size: 2em;
      }

      .text-input-section {
        grid-column: 1 / -1;
      }
    }
  </style>
</head>

<body>
  <nav class="navbar">
    <div class="nav-logo">Career Solutions for Today</div>
    <ul class="nav-links" id="navLinks">
      <li><a href="index.html">Home</a></li>
      <li><a href="Learn.html" class="learn-underline">Learning Resources</a></li>
      <!--
      <li class="dropdown" id="toolsDropdown">
        <span class="dropdown-toggle" id="toolsToggle">Tools</span>
        <ul class="dropdown-menu" id="toolsDropdownMenu">
          <li><a href="businesscase.html" target="_blank">Business Case Calculator</a></li>
          <li><a href="amortization.html" target="_blank">Amortization Calculator</a></li>
          <li><a href="Signature Builder.html" target="_blank">Email Signature Builder</a></li>
          <li><a href="Excel.html" target="_blank">Excel Simulations</a></li>
          <li><a href="shortcuts.html" target="_blank">Shortcuts</a></li>
        </ul>
      </li>
      -->
      <!-- <li><a href="practice.html">Practice</a></li> -->
      <li><a href="codeplayground.html">Code Playground</a></li>
      <li><a href="products.html">Products</a></li>
      <li><a href="contact-form.html">Contact Me</a></li>
      <li><a href="AboutMe.html" class="about-underline">About Me</a></li>
    </ul>
    <div class="hamburger" onclick="document.querySelector('.nav-links').classList.toggle('active')">
      <div></div>
      <div></div>
      <div></div>
    </div>
  </nav>

  <div class="resume-container">
    <div class="resume-header">
      <h1>AI-Powered Resume Analyzer</h1>
      <p>Upload your resume and get instant feedback to land your dream job</p>
    </div>

    <div class="upload-section">
      <h2 class="section-title">Upload Your Resume</h2>
      
      <div class="upload-methods">
        <div class="upload-method">
          <h3>üìÑ Upload File</h3>
          <p>Upload your resume in PDF, DOC, or DOCX format</p>
          <div class="file-upload">
            <label class="visually-hidden" for="fileInput">Select your resume file to upload</label>
            <input type="file" id="fileInput" accept=".pdf,.doc,.docx" />
            <button class="upload-btn">Choose File</button>
          </div>
        </div>

        <div class="upload-method" id="dragDropArea">
          <h3>üéØ Drag & Drop</h3>
          <p>Drag your resume file here for quick upload</p>
          <div class="drag-drop-area">
            <p>Drop your file here</p>
          </div>
        </div>

        <div class="text-input-section upload-method collapsible" id="resumeTextSection">
          <div class="collapsible-header">
            <div>
              <h3>üìù Copy & Paste Resume</h3>
              <p>Paste your resume text directly into the box below</p>
            </div>
            <button type="button" class="collapsible-toggle" data-target="resumeTextContent" aria-expanded="false">
              Show Text Input
            </button>
          </div>
          <div class="collapsible-content" id="resumeTextContent" hidden>
            <textarea 
              class="resume-textarea collapsible-target" 
              id="resumeText" 
              placeholder="Paste your resume text here...&#10;&#10;Include all sections: Contact info, Summary, Experience, Education, Skills, etc."
            ></textarea>
          </div>
        </div>

        <div class="text-input-section upload-method">
          <h3>üéØ Job Description (Optional)</h3>
          <p>Paste the job description you're applying for to get targeted feedback</p>
          <textarea 
            class="resume-textarea job-description-textarea" 
            id="jobDescriptionText" 
            placeholder="Paste the job description here (optional)...&#10;&#10;Include: Job title, requirements, responsibilities, preferred skills, etc.&#10;&#10;This helps tailor the analysis to match what employers are looking for!"
          ></textarea>
        </div>
      </div>

      <div class="progress-bar" id="progressBar">
        <div class="progress-fill" id="progressFill"></div>
      </div>

      <button class="analyze-btn" id="analyzeBtn" disabled>
        üîç Analyze My Resume
      </button>
    </div>

    <div class="feedback-section" id="feedbackSection">
      <h2 class="section-title">Resume Analysis Results</h2>
      <div id="feedbackContent"></div>
    </div>

    <div class="download-section" id="downloadSection">
      <h2 class="section-title tight">Continue With Premium Templates</h2>
      <p class="section-subtext">Turn these insights into a recruiter-ready document using the curated resume templates inside Career Members.</p>

      <div class="templates-cta">
        <a class="template-link" href="CareerMembers.html#resume-templates" target="_blank" rel="noopener">
          Visit Career Members Resume Templates
        </a>
      </div>
    </div>
  </div>

  <script src="js/backgrounds.js"></script>
  <script src="js/universalSidebar.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  
  <script>
    let resumeData = null;
    let analysisResults = null;

    /**
     * LLM integration configuration
     * 1. Point `BACKEND_URL` to the secured API route that calls your LLM provider.
     * 2. Keep API keys/server-side logic out of this file‚Äîonly send plain resume/job description text from the browser.
     */
    const CONFIG = {
      BACKEND_URL: 'https://resume-analyzer-backend-stevens-projects-4a20c66c.vercel.app/api/analyze',
      FALLBACK_TO_MOCK_ON_FAILURE: false
    };

    if (window.pdfjsLib) {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    }

    // üí∞ Usage tracking (hidden but still functional)
    const MONTHLY_BUDGET_LIMIT = 20.00;
    const COST_PER_ANALYSIS = 0.01;

    function getJobDescriptionValue() {
      const jobDescriptionInput = document.getElementById('jobDescriptionText');
      return jobDescriptionInput ? jobDescriptionInput.value.trim() : '';
    }
    
    // Hidden usage tracking functions (no UI display)
    function getUsageData() {
      const currentMonth = new Date().toISOString().slice(0, 7);
      const stored = localStorage.getItem('resumeAnalyzer_usage');
      
      if (!stored) {
        return { month: currentMonth, count: 0, cost: 0 };
      }
      
      const data = JSON.parse(stored);
      
      if (data.month !== currentMonth) {
        return { month: currentMonth, count: 0, cost: 0 };
      }
      
      return data;
    }
    
    function updateUsageData() {
      const currentMonth = new Date().toISOString().slice(0, 7);
      const usage = getUsageData();
      
      usage.month = currentMonth;
      usage.count += 1;
      usage.cost += COST_PER_ANALYSIS;
      
      localStorage.setItem('resumeAnalyzer_usage', JSON.stringify(usage));
      
      // Log usage for admin tracking (hidden from users)
      console.log(`Usage Update: ${usage.count} analyses, $${usage.cost.toFixed(2)} cost this month`);
      
      return usage;
    }
    
    function checkBudgetLimit() {
      const usage = getUsageData();
      return usage.cost < MONTHLY_BUDGET_LIMIT;
    }

    // File upload handling
    document.getElementById('fileInput').addEventListener('change', handleFileUpload);
    
    // Drag and drop handling
    const dragDropArea = document.getElementById('dragDropArea');
    const dragDropContainer = dragDropArea.querySelector('.drag-drop-area');
    
    // Enhanced drag and drop event listeners
    dragDropArea.addEventListener('dragover', handleDragOver);
    dragDropArea.addEventListener('drop', handleFileDrop);
    dragDropArea.addEventListener('dragleave', handleDragLeave);
    dragDropArea.addEventListener('dragenter', handleDragEnter);

    // Global drag detection for full-page overlay
    let dragCounter = 0;
    document.addEventListener('dragenter', function(e) {
      e.preventDefault();
      dragCounter++;
      if (dragCounter === 1) {
        document.body.classList.add('dragging');
      }
    });

    document.addEventListener('dragleave', function(e) {
      e.preventDefault();
      dragCounter--;
      if (dragCounter === 0) {
        document.body.classList.remove('dragging');
      }
    });

    document.addEventListener('drop', function(e) {
      e.preventDefault();
      dragCounter = 0;
      document.body.classList.remove('dragging');
    });

    // Text input handling
    document.getElementById('resumeText').addEventListener('input', handleTextInput);
    document.getElementById('resumeText').addEventListener('paste', handleTextPaste);

    // Analyze button
    document.getElementById('analyzeBtn').addEventListener('click', analyzeResume);

    // Utility function to clear success states
    function clearSuccessStates(except = []) {
      if (!except.includes('file')) {
        // Clear file upload success
        const fileUploadMethod = document.querySelector('.upload-method:first-child');
        fileUploadMethod.classList.remove('success');
      }
      
      if (!except.includes('dragdrop')) {
        // Clear drag-drop success
        const dragDropMethod = document.getElementById('dragDropArea');
        const dragDropContainer = dragDropMethod.querySelector('.drag-drop-area');
        dragDropMethod.classList.remove('success');
        dragDropContainer.classList.remove('success');
      }
      
      if (!except.includes('textarea')) {
        // Clear textarea success
        const textareas = document.querySelectorAll('.resume-textarea');
        textareas.forEach(textarea => {
          textarea.classList.remove('success');
          textarea.closest('.upload-method').classList.remove('success');
        });
      }
    }

    // Handle paste events in text areas
    function handleTextPaste(event) {
      const textarea = event.target;
      
      // Use setTimeout to get the pasted content after it's been inserted
      setTimeout(() => {
        const text = textarea.value.trim();
        if (text.length > 50) {
          // Clear other success states when pasting
          clearSuccessStates(['textarea']);
          
          // Add success state to this textarea and its parent
          textarea.classList.add('success');
          textarea.closest('.upload-method').classList.add('success');
          
          resumeData = { type: 'text', content: text };
          document.getElementById('analyzeBtn').disabled = false;
        }
      }, 10);
    }

    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (file) {
        // Clear any existing success states
        clearSuccessStates();
        
        // Add success state to the file upload method
        const fileUploadMethod = document.querySelector('.upload-method:first-child');
        fileUploadMethod.classList.add('success');
        
        processFile(file);
      }
    }

    function handleDragEnter(event) {
      event.preventDefault();
      event.stopPropagation();
      dragDropContainer.classList.add('drag-active');
    }

    function handleDragOver(event) {
      event.preventDefault();
      event.stopPropagation();
      dragDropContainer.classList.add('drag-active');
    }

    function handleDragLeave(event) {
      event.preventDefault();
      event.stopPropagation();
      
      // Only remove drag-active if we're leaving the actual drag area
      if (!dragDropArea.contains(event.relatedTarget)) {
        dragDropContainer.classList.remove('drag-active');
      }
    }

    function handleFileDrop(event) {
      event.preventDefault();
      event.stopPropagation();
      
      // Remove all drag states
      dragDropContainer.classList.remove('dragover', 'drag-active');
      document.body.classList.remove('dragging');
      dragCounter = 0;
      
      const files = event.dataTransfer.files;
      if (files.length > 0) {
        // Clear any existing success states
        clearSuccessStates();
        
        // Add success state to drag-drop area
        dragDropArea.classList.add('success');
        dragDropContainer.classList.add('success');
        
        processFile(files[0]);
      }
    }

    function handleTextInput(event) {
      const text = event.target.value.trim();
      const textarea = event.target;
      
      if (text.length > 50) {
        // Clear other success states when typing in text area
        clearSuccessStates(['textarea']);
        
        // Add success state to this textarea and its parent
        textarea.classList.add('success');
        textarea.closest('.upload-method').classList.add('success');
        
        resumeData = { type: 'text', content: text };
        document.getElementById('analyzeBtn').disabled = false;
      } else {
        // Remove success state if text is too short
        textarea.classList.remove('success');
        textarea.closest('.upload-method').classList.remove('success');
        document.getElementById('analyzeBtn').disabled = true;
      }
    }

    async function processFile(file) {
      const allowedTypes = ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
      
      if (!allowedTypes.includes(file.type)) {
        alert('Please upload a PDF, DOC, or DOCX file.');
        return;
      }

      // Show progress bar
      const progressBar = document.getElementById('progressBar');
      const progressFill = document.getElementById('progressFill');
      progressBar.style.display = 'block';

      try {
        let extractedText = '';

        if (file.type === 'application/pdf') {
          extractedText = await extractTextFromPDF(file);
        } else if (file.type.includes('word') || file.type.includes('document')) {
          extractedText = await extractTextFromWord(file);
        }

        // Simulate progress
        let progress = 0;
        const interval = setInterval(() => {
          progress += 10;
          progressFill.style.width = progress + '%';
          
          if (progress >= 100) {
            clearInterval(interval);
            setTimeout(() => {
              progressBar.style.display = 'none';
              progressFill.style.width = '0%';
              
              if (extractedText.trim().length > 50) {
                resumeData = { type: 'file', content: extractedText, filename: file.name };
                document.getElementById('analyzeBtn').disabled = false;
                alert(`File "${file.name}" processed successfully! ${extractedText.length} characters extracted. Click "Analyze My Resume" to continue.`);
              } else {
                alert('Could not extract enough text from the file. Please try a different file or use copy/paste method.');
              }
            }, 500);
          }
        }, 200);

      } catch (error) {
        progressBar.style.display = 'none';
        alert('Error processing file: ' + error.message);
      }
    }

    async function extractTextFromPDF(file) {
      if (!window.pdfjsLib) {
        throw new Error('PDF parser not available. Please refresh and try again.');
      }

      const arrayBuffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
      let text = '';

      for (let pageNumber = 1; pageNumber <= pdf.numPages; pageNumber++) {
        const page = await pdf.getPage(pageNumber);
        const content = await page.getTextContent();
        const pageText = content.items
          .map(item => ('str' in item ? item.str : item.text) || '')
          .join(' ');
        text += pageText + '\n';
      }

      return text.trim();
    }

    async function extractTextFromWord(file) {
      const arrayBuffer = await file.arrayBuffer();
      const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
      return result.value;
    }

    async function analyzeResume() {
      if (!resumeData) {
        alert('Please upload a resume or paste resume text first.');
        return;
      }

      // Check budget limit (hidden tracking)
      if (!checkBudgetLimit()) {
        const usage = getUsageData();
        alert(`üí∞ Monthly analysis limit reached!\n\nPlease try again next month. This protects against unexpected usage costs.`);
        return;
      }

      // Get job description (optional)
      const jobDescription = document.getElementById('jobDescriptionText').value.trim();

      // Show analyzing state
      const analyzeBtn = document.getElementById('analyzeBtn');
      analyzeBtn.textContent = jobDescription ? 
        'üîÑ Analyzing Resume vs Job Description...' : 
        'üîÑ Analyzing Resume...';
      analyzeBtn.disabled = true;

      try {
        const analysis = await performAIResumeAnalysis(resumeData.content, jobDescription);
        
        // Update usage tracking (hidden)
        updateUsageData();
        
        displayAnalysisResults(analysis, !!jobDescription);
        
        // Scroll to results
        document.getElementById('feedbackSection').scrollIntoView({ behavior: 'smooth' });
      } catch (error) {
        console.error('Analysis error details:', error);
        
        let errorMessage = 'Error analyzing resume: ' + error.message;
        
        // Provide more specific error messages
        if (error.message.includes('Failed to fetch')) {
          errorMessage = 'Unable to connect to the analysis service. This could be due to:\n\n' +
                       '‚Ä¢ Network connectivity issues\n' +
                       '‚Ä¢ The backend service being temporarily unavailable\n' +
                       '‚Ä¢ CORS or firewall restrictions\n\n' +
                       'A mock analysis will be shown for testing purposes.';
        } else if (error.message.includes('parse')) {
          errorMessage = 'The server response could not be processed:\n\n' + error.message + 
                       '\n\nPlease check the browser console for more details.';
        }
        
        alert(errorMessage + '\n\nNo usage counted for failed attempts.');
      } finally {
        analyzeBtn.textContent = 'üîç Analyze My Resume';
        analyzeBtn.disabled = false;
      }
    }

    async function performAIResumeAnalysis(resumeText, jobDescription = '') {
      try {
        console.log('=== ANALYSIS DEBUG INFO ===');
        console.log('Backend URL:', CONFIG.BACKEND_URL);
        console.log('Resume text length:', resumeText.length);
        console.log('Resume text preview:', resumeText.substring(0, 200) + '...');
        console.log('Job description length:', jobDescription.length);
        
        const requestBody = {
          resumeText: resumeText,
          jobDescription: jobDescription
        };
        
        console.log('Request body:', JSON.stringify(requestBody, null, 2));
        
        const response = await fetch(CONFIG.BACKEND_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(requestBody)
        });

        console.log('Response status:', response.status);
        console.log('Response statusText:', response.statusText);
        console.log('Response headers:', [...response.headers.entries()]);

        const responseText = await response.text();
        console.log('Raw response text:', responseText);

        if (!response.ok) {
          let errorMessage = `HTTP ${response.status}: ${response.statusText}`;
          try {
            const errorData = JSON.parse(responseText);
            console.log('Parsed error data:', errorData);
            errorMessage = errorData.message || errorMessage;
          } catch (e) {
            console.log('Could not parse error response as JSON:', e);
            errorMessage = responseText || errorMessage;
          }
          
          // If it's the "Failed to parse AI analysis results" error, provide a workaround
          if (errorMessage.includes('Failed to parse AI analysis results')) {
            console.log('Backend AI parsing failed, using mock response for demonstration...');
            return useDemoFallback('Backend AI parsing failed.');
          }
          
          throw new Error(`Backend Error: ${errorMessage}`);
        }
        
        let data;
        try {
          data = JSON.parse(responseText);
          console.log('Successfully parsed response:', data);
        } catch (parseError) {
          console.error('JSON parse error:', parseError);
          console.log('Using mock response due to parse error...');
          return useDemoFallback('Server response could not be parsed.');
        }
        
        if (!data.success) {
          console.log('Server returned success=false:', data);
          if (data.message && data.message.includes('Failed to parse AI analysis results')) {
            console.log('AI parsing failed on server, using mock response...');
            return useDemoFallback('AI parsing failed on server.');
          }
          throw new Error(`Analysis failed: ${data.message || 'Unknown error'}`);
        }

        if (!data.analysis) {
          console.log('No analysis data in response:', data);
          return useDemoFallback('API returned no analysis payload.');
        }

        console.log('Analysis successful:', data.analysis);
        return data.analysis;
        
      } catch (error) {
        console.error('=== ANALYSIS ERROR ===');
        console.error('Error type:', error.constructor.name);
        console.error('Error message:', error.message);
        console.error('Error stack:', error.stack);
        
        // If it's a network error, provide mock response
        if (error.message.includes('Failed to fetch') || error.message.includes('network') || error.name === 'TypeError') {
          console.log('Network error detected, evaluating fallback...');
          return useDemoFallback('Network connection to BACKEND_URL failed.');
        }
        
        throw error;
      }
    }

    // Mock response for testing when backend is unavailable
    function getMockAnalysisResponse() {
      return {
        overallScore: 78,
        categories: [
          {
            name: "Contact Information",
            score: 85,
            status: "good",
            feedback: "Contact information is complete and professional.",
            suggestions: []
          },
          {
            name: "Professional Summary",
            score: 72,
            status: "warning", 
            feedback: "Summary is present but could be more compelling.",
            suggestions: ["Add specific achievements with metrics", "Tailor summary to target role"]
          },
          {
            name: "Work Experience",
            score: 80,
            status: "good",
            feedback: "Good work experience with relevant positions.",
            suggestions: ["Add more quantified results", "Use stronger action verbs"]
          },
          {
            name: "Skills Section",
            score: 75,
            status: "warning",
            feedback: "Skills are listed but could be better organized.",
            suggestions: ["Group skills into categories", "Add proficiency levels"]
          },
          {
            name: "Education",
            score: 90,
            status: "good", 
            feedback: "Education section is well formatted.",
            suggestions: []
          }
        ],
        companyInsights: [
          {
            source: "resume",
            insight: "Mentions Fortune 100 clients, signaling enterprise credibility.",
            action: "Name the flagship client in the summary to reinforce scale."
          }
        ],
        extraInsights: [
          {
            title: "ATS Readiness",
            status: "warning",
            details: "Important role keywords are buried in lengthy bullets.",
            tips: ["Break bullets into tighter statements", "Add a keyword line under Skills"]
          },
          {
            title: "Storytelling",
            status: "warning",
            details: "Summary glosses over leadership scope even though later bullets cite team size.",
            tips: ["Mention team size and budget in opening paragraph", "Surface the most impressive metric near the top"]
          }
        ]
      };
    }

    function useDemoFallback(reason = 'LLM response unavailable.') {
      if (!CONFIG.FALLBACK_TO_MOCK_ON_FAILURE) {
        throw new Error(reason);
      }
      alert('Demo response loaded. For full functionality, integrate an LLM.\n\nDetails: ' + reason);
      return getMockAnalysisResponse();
    }

    function displayAnalysisResults(analysis, hasJobDescription = false) {
      analysisResults = analysis;
      
      const feedbackContent = document.getElementById('feedbackContent');
      const safeScore = Math.max(0, Math.min(100, Number(analysis.overallScore) || 0));
      const categories = Array.isArray(analysis.categories) ? analysis.categories : [];
      
      let html = `
        <div class="overall-score-card">
          <h3 class="overall-score-title">Overall Score: ${safeScore}/100</h3>
          ${hasJobDescription ? '<p class="job-match-indicator">‚úÖ Analyzed against job description</p>' : ''}
          <div class="score-bar">
            <div class="score-bar-fill" data-score="${safeScore}"></div>
          </div>
        </div>
      `;

      html += categories.map(renderFeedbackCategory).join('');
      html += renderCompanyInsights(analysis.companyInsights);
      html += renderExtraInsights(analysis.extraInsights);

      feedbackContent.innerHTML = html;
      animateScoreBars(feedbackContent);
      pruneEmptyInsightSections(feedbackContent);
      document.getElementById('feedbackSection').classList.add('show');
      document.getElementById('downloadSection').classList.add('show');
    }

    function renderFeedbackCategory(category) {
      const safeStatus = ['good', 'warning', 'critical'].includes(category.status) ? category.status : 'warning';
      const suggestions = Array.isArray(category.suggestions) ? category.suggestions : [];
      const safeName = category.name || category.title || category.section || category.category || category.label || 'Category';
      const safeScore = typeof category.score === 'number' ? category.score : '‚Äî';
      const scoreExplanation = typeof category.scoreExplanation === 'string' ? category.scoreExplanation : '';
      const positiveExamples = Array.isArray(category.positiveExamples)
        ? category.positiveExamples.filter(example => typeof example === 'string' && example.trim().length > 0)
        : [];

      return `
        <div class="feedback-category ${safeStatus}">
          <h3>
            <span class="status-icon ${safeStatus}"></span>
            ${safeName} (${safeScore}/100)
          </h3>
          <p class="category-feedback">${category.feedback || 'Analysis unavailable for this section.'}</p>
          ${scoreExplanation ? `<p class="score-explanation">${scoreExplanation}</p>` : ''}
          ${positiveExamples.length ? `
            <div class="positive-examples">
              <strong>What recruiters will like:</strong>
              <ul>
                ${positiveExamples.map(example => `<li>${example}</li>`).join('')}
              </ul>
            </div>
          ` : ''}
          ${suggestions.length > 0 ? `
            <div>
              <strong>Suggestions for improvement:</strong>
              <ul class="suggestions-list">
                ${suggestions.map(suggestion => `<li>${suggestion}</li>`).join('')}
              </ul>
            </div>
          ` : ''}
        </div>
      `;
    }

    function renderCompanyInsights(insights = []) {
      if (!Array.isArray(insights) || insights.length === 0) {
        return '';
      }

      const cleanedInsights = insights
        .map(item => ({
          source: item?.source || 'resume',
          insight: (item?.insight || '').trim(),
          action: (item?.action || '').trim(),
          link: (item?.link || item?.url || item?.sourceLink || '').trim()
        }))
        .filter(item => item.insight.length > 0 || item.action.length > 0 || item.link.length > 0);

      if (cleanedInsights.length === 0) {
        return '';
      }

      const insightCards = cleanedInsights.map(insight => `
        <div class="company-insight-card">
          <span class="insight-pill">${formatInsightSource(insight.source)}</span>
          <p>${insight.insight || 'Company insight unavailable.'}</p>
          ${insight.action ? `<p class="insight-action"><strong>Action:</strong> ${insight.action}</p>` : ''}
          ${insight.link ? `<a class="insight-link" href="${insight.link}" target="_blank" rel="noopener">üîó Source reference</a>` : ''}
        </div>
      `).join('');

      return `
        <section class="company-insights">
          <h3>Company & Industry Intel</h3>
          ${insightCards}
        </section>
      `;
    }

    function renderExtraInsights(extraInsights = []) {
      if (!Array.isArray(extraInsights) || extraInsights.length === 0) {
        return '';
      }

      const cleanedExtras = extraInsights
        .map(item => ({
          title: (item?.title || '').trim(),
          status: item?.status,
          details: (item?.details || '').trim(),
          tips: Array.isArray(item?.tips) ? item.tips.filter(tip => typeof tip === 'string' && tip.trim().length > 0) : []
        }))
        .filter(item => item.title.length > 0 || item.details.length > 0 || item.tips.length > 0);

      if (cleanedExtras.length === 0) {
        return '';
      }

      const statusLabelMap = {
        good: 'Momentum insight',
        warning: 'Focus opportunity',
        critical: 'Priority opportunity'
      };

      const cards = cleanedExtras.map(insight => {
        const safeStatus = ['good', 'warning', 'critical'].includes(insight.status) ? insight.status : 'warning';
        const statusLabel = statusLabelMap[safeStatus] || 'Insight focus';
        const tipsList = insight.tips.length
          ? `<ul>${insight.tips.map(tip => `<li>${tip}</li>`).join('')}</ul>`
          : '';

        return `
          <div class="extra-insight-card status-${safeStatus}">
            <div class="extra-insight-header">
              <h4>${insight.title || 'Additional Insight'}</h4>
              <span class="status-dot ${safeStatus}" title="${statusLabel}" aria-label="${statusLabel}"></span>
            </div>
            <p>${insight.details || 'No additional details provided.'}</p>
            ${tipsList}
          </div>
        `;
      }).join('');

      return `
        <section class="extra-insights">
          <h3>Additional Insight Themes</h3>
          ${cards}
        </section>
      `;
    }

    function formatInsightSource(source = 'resume') {
      if (source === 'jobDescription') {
        return 'From job description';
      }
      return 'From resume';
    }

    function animateScoreBars(root) {
      const fills = root.querySelectorAll('.score-bar-fill');
      fills.forEach(fill => {
        const score = Number(fill.dataset.score) || 0;
        requestAnimationFrame(() => {
          fill.style.width = `${score}%`;
        });
      });
    }

    function pruneEmptyInsightSections(root) {
      const companySections = root.querySelectorAll('.company-insights');
      companySections.forEach(section => {
        if (!section.querySelector('.company-insight-card')) {
          section.remove();
        }
      });

      const extraSections = root.querySelectorAll('.extra-insights');
      extraSections.forEach(section => {
        if (!section.querySelector('.extra-insight-card')) {
          section.remove();
        }
      });
    }

    function initCollapsibleSections() {
      const toggles = document.querySelectorAll('.collapsible-toggle');
      toggles.forEach(toggle => {
        const targetId = toggle.dataset.target;
        const target = document.getElementById(targetId);
        const container = toggle.closest('.collapsible');
        if (!target || !container) {
          return;
        }

        toggle.setAttribute('aria-controls', targetId);
        const textarea = target.querySelector('textarea');
        const hasPrefilledValue = textarea && textarea.value.trim().length > 0;

        if (hasPrefilledValue) {
          container.classList.add('open');
          target.removeAttribute('hidden');
          toggle.setAttribute('aria-expanded', 'true');
          toggle.textContent = 'Hide Text Input';
        } else {
          container.classList.remove('open');
          target.setAttribute('hidden', '');
          toggle.setAttribute('aria-expanded', 'false');
          toggle.textContent = 'Show Text Input';
        }

        toggle.addEventListener('click', () => {
          const isOpen = container.classList.toggle('open');
          toggle.setAttribute('aria-expanded', String(isOpen));
          toggle.textContent = isOpen ? 'Hide Text Input' : 'Show Text Input';
          if (isOpen) {
            target.removeAttribute('hidden');
          } else {
            target.setAttribute('hidden', '');
          }
        });
      });
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      initCollapsibleSections();
      console.log('Resume Analyzer page loaded');
    });
  </script>
</body>
</html>
