<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>Resume Analyzer – Career Solutions for Today</title>

  <!-- KEEPING ALL ORIGINAL STYLES EXACTLY AS YOU REQUIRED -->
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #0b0f19;
      color: #ffffff;
      margin: 0;
      padding: 0;
    }

    h1, h2, h3 {
      margin: 0;
      padding: 0;
    }

    .container {
      max-width: 900px;
      margin: auto;
      padding: 20px;
    }

    .upload-box {
      background: #161b26;
      border: 2px dashed #3f485a;
      padding: 35px;
      text-align: center;
      border-radius: 12px;
      cursor: pointer;
      transition: 0.2s ease-in-out;
    }

    .upload-box:hover {
      border-color: #4f92ff;
      background-color: #1a2233;
    }

    .upload-box.dragging {
      border-color: #4f92ff;
      background-color: #203455;
      transform: scale(1.02);
    }

    .toggle-section {
      cursor: pointer;
      padding: 15px;
      background-color: #161b26;
      border-radius: 8px;
      margin-top: 20px;
      user-select: none;
    }

    .toggle-section:hover {
      background-color: #1c2538;
    }

    .toggle-content {
      max-height: 0;
      overflow: hidden;
      opacity: 0;
      transition: max-height 0.35s ease, opacity 0.35s ease;
      margin-top: 5px;
    }

    .toggle-content.open {
      max-height: 500px;
      opacity: 1;
    }

    textarea {
      width: 100%;
      border-radius: 8px;
      border: 1px solid #3f485a;
      padding: 12px;
      background-color: #1b2233;
      color: white;
      resize: vertical;
    }

    .hidden {
      display: none;
    }

    .progress-bar {
      width: 100%;
      background: #1b2233;
      height: 8px;
      border-radius: 6px;
      margin-top: 18px;
      overflow: hidden;
      display: none;
    }

    .progress-inner {
      height: 100%;
      width: 0%;
      background-color: #4f92ff;
      transition: width 0.3s linear;
    }

    .result-section {
      background: #161b26;
      padding: 22px;
      margin-top: 28px;
      border-radius: 12px;
      border: 1px solid #3f485a;
    }

    .keyword-highlight {
      background-color: rgba(79, 146, 255, 0.22);
      padding: 1px 4px;
      border-radius: 3px;
    }
  </style>
</head>

<body>
  <div class="container">

    <h1 style="text-align:center; margin-bottom:20px;">
      Resume Analyzer
    </h1>

    <!-- RESUME UPLOAD BOX -->
    <div id="resumeUploadBox" class="upload-box">
      <h3>Click or Drag Your Resume Here</h3>
      <p>PDF, DOCX, or Text</p>
      <input id="resumeFileInput" type="file" accept=".pdf,.docx,.txt" style="display:none;">
    </div>

    <!-- JOB DESCRIPTION SECTION -->
    <div class="toggle-section" id="toggleJobInput">
      <strong>+ Add Job Description (optional)</strong>
    </div>

    <div class="toggle-content" id="jobInputContent">
      <textarea id="jobDescriptionInput" rows="6" placeholder="Paste the job description here..."></textarea>
    </div>

    <!-- PROGRESS BAR -->
    <div class="progress-bar" id="progressBar">
      <div class="progress-inner" id="progressInner"></div>
    </div>

    <!-- ANALYZE BUTTON -->
    <button id="analyzeButton" style="
        margin-top:20px;
        width:100%;
        padding:14px;
        border:none;
        background-color:#4f92ff;
        color:white;
        font-size:18px;
        border-radius:8px;
        cursor:pointer;
      ">
      Analyze Resume
    </button>
    <!-- RESULTS SECTION -->
    <div id="resultsContainer" class="result-section hidden">

      <h2 style="margin-bottom:15px;">Analysis Results</h2>

      <!-- SCORE DISPLAY -->
      <div id="overallScoreContainer" style="
          font-size:32px;
          font-weight:bold;
          margin-bottom:20px;
          text-align:center;
        ">
        Overall Score: <span id="overallScoreValue">--</span>/100
      </div>

      <!-- CRITICAL KEYWORDS -->
      <div id="criticalKeywordSection" style="
          margin-top:25px;
          padding:15px;
          background:#1b2233;
          border-radius:10px;
          border:1px solid #2d3547;
        ">
        <h3>Top Critical Keywords</h3>
        <p style="opacity:0.85; margin-top:6px;">
          These are the most important skill, leadership, and operational keywords identified from the resume & job posting.
        </p>
        <div id="criticalKeywordList" style="
            display:flex;
            flex-wrap:wrap;
            gap:8px;
            margin-top:15px;
          ">
        </div>
      </div>

      <!-- ATS SIGNALS -->
      <div id="atsSignalSection" style="
          margin-top:28px;
          padding:15px;
          background:#1b2233;
          border-radius:10px;
          border:1px solid #2d3547;
        ">
        <h3>ATS Signals</h3>
        <ul id="atsSignalList" style="margin-top:12px; line-height:1.6;"></ul>
      </div>

      <!-- CATEGORIES (Experience, Skills, etc.) -->
      <div id="categoryResults" style="
          margin-top:30px;
        ">
      </div>

      <!-- EXTRA INSIGHTS (Skill Gaps, Strengths, etc.) -->
      <div id="extraInsights" style="
          margin-top:30px;
        ">
      </div>

      <!-- HIGHLIGHTED TEXT RESULT -->
      <div id="highlightedResumeSection" style="
          margin-top:35px;
          padding:15px;
          background:#1b2233;
          border:1px solid #2d3547;
          border-radius:10px;
        ">
        <h3>Highlighted Resume Content</h3>
        <p style="opacity:0.85; margin-top:6px;">Keywords detected in your resume are highlighted for visibility.</p>

        <div id="highlightedResumeOutput" style="
            margin-top:15px;
            white-space:pre-wrap;
            font-family:Arial, sans-serif;
            line-height:1.55;
          ">
        </div>
      </div>

    </div> <!-- end resultsContainer -->

  </div> <!-- end container -->
  <!-- =========================
       SCRIPT LOGIC (UPDATED)
  ========================== -->
  <script>

    // ============================
    // DOM ELEMENTS
    // ============================
    const uploadBox = document.getElementById("resumeUploadBox");
    const fileInput = document.getElementById("resumeFileInput");
    const analyzeButton = document.getElementById("analyzeButton");
    const progressBar = document.getElementById("progressBar");
    const progressInner = document.getElementById("progressInner");

    const resultsContainer = document.getElementById("resultsContainer");
    const overallScoreValue = document.getElementById("overallScoreValue");

    const criticalKeywordList = document.getElementById("criticalKeywordList");
    const atsSignalList = document.getElementById("atsSignalList");
    const categoryResults = document.getElementById("categoryResults");
    const extraInsights = document.getElementById("extraInsights");

    const highlightedResumeOutput = document.getElementById("highlightedResumeOutput");

    const toggleJobInput = document.getElementById("toggleJobInput");
    const jobInputContent = document.getElementById("jobInputContent");
    const jobDescriptionInput = document.getElementById("jobDescriptionInput");


    // ============================
    // JOB SECTION TOGGLE
    // ============================
    toggleJobInput.addEventListener("click", () => {
      const isOpen = jobInputContent.classList.toggle("open");
      toggleJobInput.innerHTML = isOpen
        ? "<strong>- Hide Job Description</strong>"
        : "<strong>+ Add Job Description (optional)</strong>";
    });


    // ============================
    // DRAG & DROP UPLOAD
    // ============================
    uploadBox.addEventListener("click", () => fileInput.click());

    uploadBox.addEventListener("dragover", e => {
      e.preventDefault();
      uploadBox.classList.add("dragging");
    });

    uploadBox.addEventListener("dragleave", () => {
      uploadBox.classList.remove("dragging");
    });

    uploadBox.addEventListener("drop", e => {
      e.preventDefault();
      uploadBox.classList.remove("dragging");
      if (e.dataTransfer.files.length > 0) {
        fileInput.files = e.dataTransfer.files;
      }
    });


    // ============================
    // FILE READING HELPERS
    // ============================
    async function extractTextFromFile(file) {
      const name = file.name.toLowerCase();

      if (name.endsWith(".txt")) {
        return file.text();
      }

      if (name.endsWith(".pdf")) {
        return extractTextFromPdf(file);
      }

      if (name.endsWith(".docx")) {
        return extractTextFromDocx(file);
      }

      throw new Error("Unsupported file type");
    }

    async function extractTextFromPdf(file) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = () => {
          // Fallback extraction
          resolve("PDF uploaded — extracting text via backend…");
        };
        reader.readAsArrayBuffer(file);
      });
    }

    async function extractTextFromDocx(file) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = () => {
          resolve("DOCX uploaded — extracting text via backend…");
        };
        reader.readAsArrayBuffer(file);
      });
    }


    // ============================
    // PROGRESS BAR HANDLER
    // ============================
    function startProgress() {
      progressBar.style.display = "block";
      progressInner.style.width = "0%";

      setTimeout(() => {
        progressInner.style.width = "40%";
      }, 100);

      setTimeout(() => {
        progressInner.style.width = "75%";
      }, 600);
    }

    function finishProgress() {
      progressInner.style.width = "100%";
      setTimeout(() => {
        progressBar.style.display = "none";
        progressInner.style.width = "0%";
      }, 600);
    }


    // ============================
    // MAIN ANALYZE LOGIC
    // ============================
    analyzeButton.addEventListener("click", async () => {
      const file = fileInput.files[0];
      const jobDescription = jobDescriptionInput.value.trim();

      if (!file) {
        alert("Please upload a resume file first.");
        return;
      }

      const resumeText = await extractTextFromFile(file);

      startProgress();

      try {
        const response = await fetch("/api/analyze", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            resumeText,
            jobDescription
          })
        });

        const data = await response.json();
        finishProgress();

        if (!data.success) {
          alert("Analysis failed: " + (data.error || "Unknown error"));
          return;
        }

        populateResults(data.analysis, resumeText, data);
        scrollToResults();

      } catch (error) {
        finishProgress();
        alert("Something went wrong analyzing your resume.");
        console.error(error);
      }
    });


    // ============================
    // POPULATE RESULTS UI
    // ============================
    function populateResults(analysis, resumeText, fullResponse) {
      resultsContainer.classList.remove("hidden");

      // Score
      overallScoreValue.textContent = analysis.overallScore || "--";

      // Critical keywords
      criticalKeywordList.innerHTML = "";
      analysis.criticalKeywords.forEach(kw => {
        const chip = document.createElement("span");
        chip.textContent = kw;
        chip.style.padding = "6px 10px";
        chip.style.background = "#23304a";
        chip.style.borderRadius = "6px";
        chip.style.fontSize = "14px";
        criticalKeywordList.appendChild(chip);
      });

      // ATS Signals
      atsSignalList.innerHTML = "";
      const ats = analysis.atsSignals || {};
      Object.entries(ats).forEach(([key, val]) => {
        if (Array.isArray(val)) return;
        const li = document.createElement("li");
        li.textContent = `${formatAtsKey(key)}: ${val}`;
        atsSignalList.appendChild(li);
      });

      // ATS Warnings
      if (analysis.atsWarnings && analysis.atsWarnings.length > 0) {
        const wHeader = document.createElement("h4");
        wHeader.textContent = "ATS Warnings";
        wHeader.style.marginTop = "12px";
        atsSignalList.appendChild(wHeader);

        analysis.atsWarnings.forEach(w => {
          const li = document.createElement("li");
          li.style.color = "#ffb951";
          li.textContent = "⚠ " + w;
          atsSignalList.appendChild(li);
        });
      }

      // Categories
      categoryResults.innerHTML = "";
      analysis.categories.forEach(cat => {
        const block = document.createElement("div");
        block.style.padding = "15px";
        block.style.border = "1px solid #2d3547";
        block.style.borderRadius = "8px";
        block.style.marginBottom = "18px";
        block.style.background = "#1b2233";

        block.innerHTML = `
            <h3>${cat.name}</h3>
            <p><strong>Status:</strong> ${cat.status}</p>
            <p><strong>Score:</strong> ${cat.score}</p>
            <p style="opacity:0.9;">${cat.feedback}</p>
            <ul>${cat.suggestions.map(s => `<li>${s}</li>`).join("")}</ul>
        `;

        categoryResults.appendChild(block);
      });

      // Extra Insights
      extraInsights.innerHTML = "";
      analysis.extraInsights.forEach(ins => {
        const card = document.createElement("div");
        card.style.padding = "15px";
        card.style.border = "1px solid #2d3547";
        card.style.borderRadius = "8px";
        card.style.marginBottom = "18px";
        card.style.background = "#1b2233";

        card.innerHTML = `
          <h3>${ins.title}</h3>
          <p style="opacity:0.9;">${ins.details}</p>
          <ul>${ins.tips.map(t => `<li>${t}</li>`).join("")}</ul>
        `;

        extraInsights.appendChild(card);
      });

      // Highlight resume content
      highlightedResumeOutput.innerHTML = applyResumeHighlights(
        resumeText,
        analysis.highlightKeywords || []
      );
    }


    // ============================
    // HELPER — Format ATS keys
    // ============================
    function formatAtsKey(key) {
      return key
        .replace(/([A-Z])/g, " $1")
        .replace(/_/g, " ")
        .replace(/\b\w/g, c => c.toUpperCase());
    }


    // ============================
    // HIGHLIGHTING ENGINE
    // ============================
    function applyResumeHighlights(text, keywords) {
      if (!keywords || keywords.length === 0) return text;

      let highlighted = text;

      keywords.forEach(kw => {
        const regex = new RegExp(escapeRegex(kw), "gi");
        highlighted = highlighted.replace(regex, match =>
          `<span class="keyword-highlight">${match}</span>`
        );
      });

      return highlighted;
    }

    function escapeRegex(str) {
      return str.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
    }


    // ============================
    // SCROLL TO RESULTS
    // ============================
    function scrollToResults() {
      setTimeout(() => {
        resultsContainer.scrollIntoView({ behavior: "smooth" });
      }, 300);
    }

  </script>

</body>
</html>
