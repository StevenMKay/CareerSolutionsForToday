<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Resume Analyzer - Career Solutions for Today</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="site.css">
  <style>
    /* Resume page specific styles */
    .resume-container {
      max-width: 1200px;
      margin: 110px auto 0 auto;
      padding: 30px 20px 60px 20px;
    }

    .resume-header {
      text-align: center;
      margin-bottom: 40px;
    }

    .resume-header h1 {
      color: white;
      font-size: 2.5em;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .resume-header p {
      color: white;
      font-size: 1.2em;
      opacity: 0.9;
    }

    .upload-section {
      background: rgba(255,255,255,0.15);
      border-radius: 18px;
      box-shadow: 0 2px 18px rgba(0,0,0,0.13);
      padding: 40px;
      margin-bottom: 30px;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      color: white;
    }

    .upload-methods {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-bottom: 30px;
    }

    .upload-method {
      background: rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 30px;
      text-align: center;
      border: 2px dashed rgba(255,255,255,0.3);
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .upload-method:hover {
      border-color: rgba(255,255,255,0.6);
      background: rgba(255,255,255,0.2);
    }
    .upload-method.success {
      border-color: #4caf50;
      background: rgba(76, 175, 80, 0.2);
      box-shadow: 0 0 20px rgba(76, 175, 80, 0.3);
    }

    .upload-method.success h3 {
      color: #4caf50;
    }

    .upload-method h3 {
      color: white;
      margin-bottom: 15px;
      font-size: 1.3em;
    }

    .file-upload {
      position: relative;
      display: inline-block;
      width: 100%;
    }

    .file-upload input[type=file] {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }

    .upload-btn {
      background: #0b4f6c;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      transition: background 0.3s;
      width: 100%;
    }

    .upload-btn:hover {
      background: #0a4460;
    }

    .drag-drop-area {
      border: 2px dashed rgba(255,255,255,0.4);
      border-radius: 12px;
      padding: 40px;
      text-align: center;
      margin: 20px 0;
      transition: all 0.3s ease;
    }

    .drag-drop-area.dragover {
      border-color: #0b4f6c;
      background: rgba(11,79,108,0.1);
    }

    .drag-drop-area.success {
      border-color: #4caf50;
      background: rgba(76, 175, 80, 0.2);
      box-shadow: 0 0 20px rgba(76, 175, 80, 0.3);
    }

    /* Enhanced drag feedback */
    .drag-drop-area.drag-active {
      border-color: #2196f3;
      background: rgba(33, 150, 243, 0.15);
      box-shadow: 0 0 30px rgba(33, 150, 243, 0.4);
      transform: scale(1.02);
      transition: all 0.2s ease;
    }

    .drag-drop-area.drag-active::before {
      content: 'üìÑ Drop your resume here!';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(33, 150, 243, 0.9);
      color: white;
      padding: 15px 25px;
      border-radius: 8px;
      font-weight: bold;
      font-size: 16px;
      z-index: 10;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      animation: pulse 1.5s infinite;
    }

    .drag-drop-area.drag-active::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      border: 3px dashed #2196f3;
      border-radius: 12px;
      animation: dashMove 2s linear infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: translate(-50%, -50%) scale(1); }
      50% { transform: translate(-50%, -50%) scale(1.05); }
    }

    @keyframes dashMove {
      0% { border-dash-offset: 0; }
      100% { border-dash-offset: 20px; }
    }

    /* Body drag overlay */
    body.dragging::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(33, 150, 243, 0.1);
      z-index: 5;
      pointer-events: none;
    }

    /* Beautiful completion modal */
    .completion-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .completion-modal.show {
      opacity: 1;
      visibility: visible;
    }

    .completion-modal-content {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 20px;
      padding: 40px;
      text-align: center;
      color: white;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      transform: scale(0.7) translateY(50px);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .completion-modal.show .completion-modal-content {
      transform: scale(1) translateY(0);
    }

    .completion-modal-content::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
      animation: shimmer 3s ease-in-out infinite;
    }

    @keyframes shimmer {
      0%, 100% { transform: rotate(0deg); }
      50% { transform: rotate(180deg); }
    }

    .completion-icon {
      font-size: 4em;
      margin-bottom: 20px;
      animation: bounce 1s ease-in-out infinite alternate;
    }

    @keyframes bounce {
      0% { transform: translateY(0); }
      100% { transform: translateY(-10px); }
    }

    .completion-title {
      font-size: 2.2em;
      font-weight: bold;
      margin-bottom: 15px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    .completion-message {
      font-size: 1.2em;
      margin-bottom: 25px;
      opacity: 0.9;
      line-height: 1.4;
    }

    .completion-score {
      font-size: 3em;
      font-weight: bold;
      margin: 20px 0;
      text-shadow: 0 3px 6px rgba(0,0,0,0.3);
      animation: glow 2s ease-in-out infinite alternate;
    }

    @keyframes glow {
      0% { text-shadow: 0 3px 6px rgba(0,0,0,0.3), 0 0 20px rgba(255,255,255,0.2); }
      100% { text-shadow: 0 3px 6px rgba(0,0,0,0.3), 0 0 30px rgba(255,255,255,0.4); }
    }

    .completion-close-btn {
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid rgba(255, 255, 255, 0.3);
      color: white;
      padding: 12px 30px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .completion-close-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      border-color: rgba(255, 255, 255, 0.5);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }

    .text-input-section {
      grid-column: 1 / -1;
    }

    .resume-textarea {
      width: 100%;
      min-height: 200px;
      padding: 15px;
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 8px;
      background: rgba(255,255,255,0.1);
      color: white;
      font-size: 14px;
      font-family: 'Segoe UI', sans-serif;
      resize: vertical;
    }

    .resume-textarea::placeholder {
      color: rgba(255,255,255,0.7);
    }

    .resume-textarea.success {
      border-color: #4caf50;
      background: rgba(76, 175, 80, 0.15);
      box-shadow: 0 0 15px rgba(76, 175, 80, 0.3);
    }

    .analyze-btn {
      background: linear-gradient(45deg, #0b4f6c, #1976d2);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 18px;
      font-weight: bold;
      margin-top: 20px;
      transition: all 0.3s ease;
      display: block;
      margin: 20px auto 0 auto;
    }

    .analyze-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(11,79,108,0.4);
    }

    .analyze-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .feedback-section {
      background: rgba(255,255,255,0.15);
      border-radius: 18px;
      box-shadow: 0 2px 18px rgba(0,0,0,0.13);
      padding: 40px;
      margin-bottom: 30px;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      color: white;
      display: none;
    }

    .feedback-section.show {
      display: block;
      animation: fadeIn 0.5s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .feedback-category {
      margin-bottom: 25px;
      padding: 20px;
      background: rgba(255,255,255,0.1);
      border-radius: 12px;
      border-left: 4px solid #1976d2;
    }

    .feedback-category h3 {
      color: white;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .feedback-category.good {
      border-left-color: #4caf50;
    }

    .feedback-category.warning {
      border-left-color: #ff9800;
    }

    .feedback-category.critical {
      border-left-color: #f44336;
    }

    .status-icon {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: inline-block;
    }

    .status-icon.good { background: #4caf50; }
    .status-icon.warning { background: #ff9800; }
    .status-icon.critical { background: #f44336; }

    .download-section {
      background: rgba(255,255,255,0.15);
      border-radius: 18px;
      box-shadow: 0 2px 18px rgba(0,0,0,0.13);
      padding: 40px;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      color: white;
      display: none;
    }

    .download-section.show {
      display: block;
      animation: fadeIn 0.5s ease-in;
    }

    .download-options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .download-option {
      background: rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 25px;
      text-align: center;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .download-option:hover {
      background: rgba(255,255,255,0.2);
      transform: translateY(-3px);
      box-shadow: 0 5px 20px rgba(0,0,0,0.2);
    }

    .download-option h4 {
      color: white;
      margin-bottom: 10px;
      font-size: 1.2em;
    }

    .download-option p {
      color: rgba(255,255,255,0.8);
      font-size: 0.9em;
      margin-bottom: 15px;
    }

    .download-btn {
      background: #0b4f6c;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.3s;
    }

    .download-btn:hover {
      background: #0a4460;
    }

    .progress-bar {
      width: 100%;
      height: 4px;
      background: rgba(255,255,255,0.2);
      border-radius: 2px;
      margin: 20px 0;
      overflow: hidden;
      display: none;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #0b4f6c, #1976d2);
      width: 0%;
      transition: width 0.3s ease;
    }

    @media (max-width: 768px) {
      .upload-methods {
        grid-template-columns: 1fr;
        gap: 20px;
      }

      .resume-container {
        padding: 20px 15px;
      }

      .upload-section, .feedback-section, .download-section {
        padding: 25px;
      }

      .resume-header h1 {
        font-size: 2em;
      }

      .text-input-section {
        grid-column: 1 / -1;
      }
    }
  </style>
</head>

<body>
  <nav class="navbar">
    <ul class="nav-links" id="navLinks">
       <li><a href="index.html">Home</a></li>
    <li><a href="Videos.html">Videos</a></li>
    <li><a href="Templates.html">Templates</a></li>
    <li><a href="Learn.html" class="learn-underline">Learn</a></li>
    <li><a href="resume.html" class="resume-underline">Resume</a></li>
    <li><a href="AboutMe.html" class="about-underline">About Me</a></li>
    </ul>
    <div class="nav-logo">Career Solutions for Today</div>
    <div class="hamburger" id="hamburgerBtn" aria-label="Open navigation" tabindex="0">
      <span></span>
      <span></span>
      <span></span>
    </div>
  </nav>

  <div class="resume-container">
    <div class="resume-header">
      <h1>AI-Powered Resume Analyzer</h1>
      <p>Upload your resume and get instant feedback to land your dream job</p>
    </div>

    <div class="upload-section">
      <h2 style="color: white; text-align: center; margin-bottom: 30px;">Upload Your Resume</h2>
      
      <div class="upload-methods">
        <div class="upload-method">
          <h3>üìÑ Upload File</h3>
          <p>Upload your resume in PDF, DOC, or DOCX format</p>
          <div class="file-upload">
            <input type="file" id="fileInput" accept=".pdf,.doc,.docx" />
            <button class="upload-btn">Choose File</button>
          </div>
        </div>

        <div class="upload-method" id="dragDropArea">
          <h3>üéØ Drag & Drop</h3>
          <p>Drag your resume file here for quick upload</p>
          <div class="drag-drop-area">
            <p>Drop your file here</p>
          </div>
        </div>

        <div class="text-input-section upload-method">
          <h3>üìù Copy & Paste Resume</h3>
          <p>Paste your resume text directly into the box below</p>
          <textarea 
            class="resume-textarea" 
            id="resumeText" 
            placeholder="Paste your resume text here...&#10;&#10;Include all sections: Contact info, Summary, Experience, Education, Skills, etc."
          ></textarea>
        </div>

        <div class="text-input-section upload-method">
          <h3>üéØ Job Description (Optional)</h3>
          <p>Paste the job description you're applying for to get targeted feedback</p>
          <textarea 
            class="resume-textarea" 
            id="jobDescriptionText" 
            style="min-height: 150px;"
            placeholder="Paste the job description here (optional)...&#10;&#10;Include: Job title, requirements, responsibilities, preferred skills, etc.&#10;&#10;This helps tailor the analysis to match what employers are looking for!"
          ></textarea>
        </div>
      </div>

      <div class="progress-bar" id="progressBar">
        <div class="progress-fill" id="progressFill"></div>
      </div>

      <button class="analyze-btn" id="analyzeBtn" disabled>
        üîç Analyze My Resume
      </button>
    </div>

    <div class="feedback-section" id="feedbackSection">
      <h2 style="color: white; text-align: center; margin-bottom: 30px;">Resume Analysis Results</h2>
      <div id="feedbackContent"></div>
    </div>

    <div class="download-section" id="downloadSection">
      <h2 style="color: white; text-align: center; margin-bottom: 20px;">Download Improved Resume</h2>
      <p style="text-align: center; margin-bottom: 30px;">Choose your preferred resume template and download the improved version</p>
      
      <div class="download-options">
        <div class="download-option" onclick="downloadResume('modern')">
          <h4>üé® Modern Resume</h4>
          <p>Contemporary design with color accents and modern layout. Perfect for creative and tech roles.</p>
          <button class="download-btn">Download Modern (.docx)</button>
        </div>

        <div class="download-option" onclick="downloadResume('classic')">
          <h4>üìã Classic Resume</h4>
          <p>Traditional black and white format. Ideal for conservative industries and formal positions.</p>
          <button class="download-btn">Download Classic (.docx)</button>
        </div>

        <div class="download-option" onclick="downloadResume('original')">
          <h4>üîÑ Same Format</h4>
          <p>Keep your original format but with improved content based on our suggestions.</p>
          <button class="download-btn">Download Improved (.docx)</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Beautiful completion modal -->
  <div class="completion-modal" id="completionModal">
    <div class="completion-modal-content">
      <div class="completion-icon">üéâ</div>
      <div class="completion-title">Analysis Complete!</div>
      <div class="completion-message">Your resume has been thoroughly analyzed and scored.</div>
      <div class="completion-score" id="completionScore">85/100</div>
      <div class="completion-message">Ready to download your improved resume!</div>
      <button class="completion-close-btn" onclick="closeCompletionModal()">View Results</button>
    </div>
  </div>

  <script src="js/backgrounds.js"></script>
  <script src="js/universalSidebar.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  
  <script>
    let resumeData = null;
    let analysisResults = null;

    // üîí Backend URL (API key is safely stored on server)
    const BACKEND_URL = 'https://resume-analyzer-backend-pi.vercel.app/api/analyze';

    // üí∞ Usage tracking (hidden but still functional)
    const MONTHLY_BUDGET_LIMIT = 20.00;
    const COST_PER_ANALYSIS = 0.01;
    
    // Hidden usage tracking functions (no UI display)
    function getUsageData() {
      const currentMonth = new Date().toISOString().slice(0, 7);
      const stored = localStorage.getItem('resumeAnalyzer_usage');
      
      if (!stored) {
        return { month: currentMonth, count: 0, cost: 0 };
      }
      
      const data = JSON.parse(stored);
      
      if (data.month !== currentMonth) {
        return { month: currentMonth, count: 0, cost: 0 };
      }
      
      return data;
    }
    
    function updateUsageData() {
      const currentMonth = new Date().toISOString().slice(0, 7);
      const usage = getUsageData();
      
      usage.month = currentMonth;
      usage.count += 1;
      usage.cost += COST_PER_ANALYSIS;
      
      localStorage.setItem('resumeAnalyzer_usage', JSON.stringify(usage));
      
      // Log usage for admin tracking (hidden from users)
      console.log(`Usage Update: ${usage.count} analyses, $${usage.cost.toFixed(2)} cost this month`);
      
      return usage;
    }
    
    function checkBudgetLimit() {
      const usage = getUsageData();
      return usage.cost < MONTHLY_BUDGET_LIMIT;
    }

    // File upload handling
    document.getElementById('fileInput').addEventListener('change', handleFileUpload);
    
    // Drag and drop handling
    const dragDropArea = document.getElementById('dragDropArea');
    const dragDropContainer = dragDropArea.querySelector('.drag-drop-area');
    
    // Enhanced drag and drop event listeners
    dragDropArea.addEventListener('dragover', handleDragOver);
    dragDropArea.addEventListener('drop', handleFileDrop);
    dragDropArea.addEventListener('dragleave', handleDragLeave);
    dragDropArea.addEventListener('dragenter', handleDragEnter);

    // Global drag detection for full-page overlay
    let dragCounter = 0;
    document.addEventListener('dragenter', function(e) {
      e.preventDefault();
      dragCounter++;
      if (dragCounter === 1) {
        document.body.classList.add('dragging');
      }
    });

    document.addEventListener('dragleave', function(e) {
      e.preventDefault();
      dragCounter--;
      if (dragCounter === 0) {
        document.body.classList.remove('dragging');
      }
    });

    document.addEventListener('drop', function(e) {
      e.preventDefault();
      dragCounter = 0;
      document.body.classList.remove('dragging');
    });

    // Text input handling
    document.getElementById('resumeText').addEventListener('input', handleTextInput);
    document.getElementById('resumeText').addEventListener('paste', handleTextPaste);

    // Analyze button
    document.getElementById('analyzeBtn').addEventListener('click', analyzeResume);

    // Utility function to clear success states
    function clearSuccessStates(except = []) {
      if (!except.includes('file')) {
        // Clear file upload success
        const fileUploadMethod = document.querySelector('.upload-method:first-child');
        fileUploadMethod.classList.remove('success');
      }
      
      if (!except.includes('dragdrop')) {
        // Clear drag-drop success
        const dragDropMethod = document.getElementById('dragDropArea');
        const dragDropContainer = dragDropMethod.querySelector('.drag-drop-area');
        dragDropMethod.classList.remove('success');
        dragDropContainer.classList.remove('success');
      }
      
      if (!except.includes('textarea')) {
        // Clear textarea success
        const textareas = document.querySelectorAll('.resume-textarea');
        textareas.forEach(textarea => {
          textarea.classList.remove('success');
          textarea.closest('.upload-method').classList.remove('success');
        });
      }
    }

    // Handle paste events in text areas
    function handleTextPaste(event) {
      const textarea = event.target;
      
      // Use setTimeout to get the pasted content after it's been inserted
      setTimeout(() => {
        const text = textarea.value.trim();
        if (text.length > 50) {
          // Clear other success states when pasting
          clearSuccessStates(['textarea']);
          
          // Add success state to this textarea and its parent
          textarea.classList.add('success');
          textarea.closest('.upload-method').classList.add('success');
          
          resumeData = { type: 'text', content: text };
          document.getElementById('analyzeBtn').disabled = false;
        }
      }, 10);
    }

    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (file) {
        // Clear any existing success states
        clearSuccessStates();
        
        // Add success state to the file upload method
        const fileUploadMethod = document.querySelector('.upload-method:first-child');
        fileUploadMethod.classList.add('success');
        
        processFile(file);
      }
    }

    function handleDragEnter(event) {
      event.preventDefault();
      event.stopPropagation();
      dragDropContainer.classList.add('drag-active');
    }

    function handleDragOver(event) {
      event.preventDefault();
      event.stopPropagation();
      dragDropContainer.classList.add('drag-active');
    }

    function handleDragLeave(event) {
      event.preventDefault();
      event.stopPropagation();
      
      // Only remove drag-active if we're leaving the actual drag area
      if (!dragDropArea.contains(event.relatedTarget)) {
        dragDropContainer.classList.remove('drag-active');
      }
    }

    function handleFileDrop(event) {
      event.preventDefault();
      event.stopPropagation();
      
      // Remove all drag states
      dragDropContainer.classList.remove('dragover', 'drag-active');
      document.body.classList.remove('dragging');
      dragCounter = 0;
      
      const files = event.dataTransfer.files;
      if (files.length > 0) {
        // Clear any existing success states
        clearSuccessStates();
        
        // Add success state to drag-drop area
        dragDropArea.classList.add('success');
        dragDropContainer.classList.add('success');
        
        processFile(files[0]);
      }
    }

    function handleTextInput(event) {
      const text = event.target.value.trim();
      const textarea = event.target;
      
      if (text.length > 50) {
        // Clear other success states when typing in text area
        clearSuccessStates(['textarea']);
        
        // Add success state to this textarea and its parent
        textarea.classList.add('success');
        textarea.closest('.upload-method').classList.add('success');
        
        resumeData = { type: 'text', content: text };
        document.getElementById('analyzeBtn').disabled = false;
      } else {
        // Remove success state if text is too short
        textarea.classList.remove('success');
        textarea.closest('.upload-method').classList.remove('success');
        document.getElementById('analyzeBtn').disabled = true;
      }
    }

    async function processFile(file) {
      const allowedTypes = ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
      
      if (!allowedTypes.includes(file.type)) {
        alert('Please upload a PDF, DOC, or DOCX file.');
        return;
      }

      // Show progress bar
      const progressBar = document.getElementById('progressBar');
      const progressFill = document.getElementById('progressFill');
      progressBar.style.display = 'block';

      try {
        let extractedText = '';

        if (file.type === 'application/pdf') {
          extractedText = await extractTextFromPDF(file);
        } else if (file.type.includes('word') || file.type.includes('document')) {
          extractedText = await extractTextFromWord(file);
        }

        // Simulate progress
        let progress = 0;
        const interval = setInterval(() => {
          progress += 10;
          progressFill.style.width = progress + '%';
          
          if (progress >= 100) {
            clearInterval(interval);
            setTimeout(() => {
              progressBar.style.display = 'none';
              progressFill.style.width = '0%';
              
              if (extractedText.trim().length > 50) {
                resumeData = { type: 'file', content: extractedText, filename: file.name };
                document.getElementById('analyzeBtn').disabled = false;
                alert(`File "${file.name}" processed successfully! ${extractedText.length} characters extracted. Click "Analyze My Resume" to continue.`);
              } else {
                alert('Could not extract enough text from the file. Please try a different file or use copy/paste method.');
              }
            }, 500);
          }
        }, 200);

      } catch (error) {
        progressBar.style.display = 'none';
        alert('Error processing file: ' + error.message);
      }
    }

    async function extractTextFromPDF(file) {
      const arrayBuffer = await file.arrayBuffer();
      const pdf = await PDFLib.PDFDocument.load(arrayBuffer);
      const pages = pdf.getPages();
      
      let text = '';
      // Note: PDFLib doesn't extract text directly, this is a simplified version
      // In a real app, you'd use pdf-parse or similar library
      text = "PDF text extraction requires server-side processing. Please copy and paste your resume text instead, or upload a Word document.";
      return text;
    }

    async function extractTextFromWord(file) {
      const arrayBuffer = await file.arrayBuffer();
      const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
      return result.value;
    }

    async function analyzeResume() {
      if (!resumeData) {
        alert('Please upload a resume or paste resume text first.');
        return;
      }

      // Check budget limit (hidden tracking)
      if (!checkBudgetLimit()) {
        const usage = getUsageData();
        alert(`üí∞ Monthly analysis limit reached!\n\nPlease try again next month. This protects against unexpected usage costs.`);
        return;
      }

      // Get job description (optional)
      const jobDescription = document.getElementById('jobDescriptionText').value.trim();

      // Show analyzing state
      const analyzeBtn = document.getElementById('analyzeBtn');
      analyzeBtn.textContent = jobDescription ? 
        'üîÑ Analyzing Resume vs Job Description...' : 
        'üîÑ Analyzing Resume...';
      analyzeBtn.disabled = true;

      try {
        const analysis = await performAIResumeAnalysis(resumeData.content, jobDescription);
        
        // Update usage tracking (hidden)
        updateUsageData();
        
        displayAnalysisResults(analysis, !!jobDescription);
        
        // Scroll to results
        document.getElementById('feedbackSection').scrollIntoView({ behavior: 'smooth' });
      } catch (error) {
        console.error('Analysis error details:', error);
        
        let errorMessage = 'Error analyzing resume: ' + error.message;
        
        // Provide more specific error messages
        if (error.message.includes('Failed to fetch')) {
          errorMessage = 'Unable to connect to the analysis service. This could be due to:\n\n' +
                       '‚Ä¢ Network connectivity issues\n' +
                       '‚Ä¢ The backend service being temporarily unavailable\n' +
                       '‚Ä¢ CORS or firewall restrictions\n\n' +
                       'A mock analysis will be shown for testing purposes.';
        } else if (error.message.includes('parse')) {
          errorMessage = 'The server response could not be processed:\n\n' + error.message + 
                       '\n\nPlease check the browser console for more details.';
        }
        
        alert(errorMessage + '\n\nNo usage counted for failed attempts.');
      } finally {
        analyzeBtn.textContent = 'üîç Analyze My Resume';
        analyzeBtn.disabled = false;
      }
    }

    async function performAIResumeAnalysis(resumeText, jobDescription = '') {
      try {
        console.log('=== ANALYSIS DEBUG INFO ===');
        console.log('Backend URL:', BACKEND_URL);
        console.log('Resume text length:', resumeText.length);
        console.log('Resume text preview:', resumeText.substring(0, 200) + '...');
        console.log('Job description length:', jobDescription.length);
        
        const requestBody = {
          resumeText: resumeText,
          jobDescription: jobDescription
        };
        
        console.log('Request body:', JSON.stringify(requestBody, null, 2));
        
        const response = await fetch(BACKEND_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(requestBody)
        });

        console.log('Response status:', response.status);
        console.log('Response statusText:', response.statusText);
        console.log('Response headers:', [...response.headers.entries()]);

        const responseText = await response.text();
        console.log('Raw response text:', responseText);

        if (!response.ok) {
          let errorMessage = `HTTP ${response.status}: ${response.statusText}`;
          try {
            const errorData = JSON.parse(responseText);
            console.log('Parsed error data:', errorData);
            errorMessage = errorData.message || errorMessage;
          } catch (e) {
            console.log('Could not parse error response as JSON:', e);
            errorMessage = responseText || errorMessage;
          }
          
          // If it's the "Failed to parse AI analysis results" error, provide a workaround
          if (errorMessage.includes('Failed to parse AI analysis results')) {
            console.log('Backend AI parsing failed, using mock response for demonstration...');
            alert('The backend AI service is currently having issues parsing the resume. Using a demo response to show the interface functionality.');
            return getMockAnalysisResponse();
          }
          
          throw new Error(`Backend Error: ${errorMessage}`);
        }
        
        let data;
        try {
          data = JSON.parse(responseText);
          console.log('Successfully parsed response:', data);
        } catch (parseError) {
          console.error('JSON parse error:', parseError);
          console.log('Using mock response due to parse error...');
          alert('Server response could not be parsed. Using demo response to show interface functionality.');
          return getMockAnalysisResponse();
        }
        
        if (!data.success) {
          console.log('Server returned success=false:', data);
          if (data.message && data.message.includes('Failed to parse AI analysis results')) {
            console.log('AI parsing failed on server, using mock response...');
            alert('The AI analysis service is temporarily having issues. Using a demo response to show the interface functionality.');
            return getMockAnalysisResponse();
          }
          throw new Error(`Analysis failed: ${data.message || 'Unknown error'}`);
        }

        if (!data.analysis) {
          console.log('No analysis data in response:', data);
          alert('No analysis data received. Using demo response to show interface functionality.');
          return getMockAnalysisResponse();
        }

        console.log('Analysis successful:', data.analysis);
        return data.analysis;
        
      } catch (error) {
        console.error('=== ANALYSIS ERROR ===');
        console.error('Error type:', error.constructor.name);
        console.error('Error message:', error.message);
        console.error('Error stack:', error.stack);
        
        // If it's a network error, provide mock response
        if (error.message.includes('Failed to fetch') || error.message.includes('network') || error.name === 'TypeError') {
          console.log('Network error detected, providing mock response...');
          alert('Unable to connect to analysis service. Using demo response to show interface functionality.');
          return getMockAnalysisResponse();
        }
        
        throw error;
      }
    }

    // Mock response for testing when backend is unavailable
    function getMockAnalysisResponse() {
      return {
        overallScore: 78,
        categories: [
          {
            name: "Contact Information",
            score: 85,
            status: "good",
            feedback: "Contact information is complete and professional.",
            suggestions: []
          },
          {
            name: "Professional Summary",
            score: 72,
            status: "warning", 
            feedback: "Summary is present but could be more compelling.",
            suggestions: ["Add specific achievements with metrics", "Tailor summary to target role"]
          },
          {
            name: "Work Experience",
            score: 80,
            status: "good",
            feedback: "Good work experience with relevant positions.",
            suggestions: ["Add more quantified results", "Use stronger action verbs"]
          },
          {
            name: "Skills Section",
            score: 75,
            status: "warning",
            feedback: "Skills are listed but could be better organized.",
            suggestions: ["Group skills into categories", "Add proficiency levels"]
          },
          {
            name: "Education",
            score: 90,
            status: "good", 
            feedback: "Education section is well formatted.",
            suggestions: []
          }
        ]
      };
    }

    function displayAnalysisResults(analysis, hasJobDescription = false) {
      analysisResults = analysis;
      
      // Show the beautiful completion modal first
      showCompletionModal(analysis.overallScore);
      
      const feedbackContent = document.getElementById('feedbackContent');
      const overallScore = analysis.overallScore;
      
      let html = `
        <div style="text-align: center; margin-bottom: 30px;">
          <h3 style="color: white; font-size: 2em; margin-bottom: 10px;">Overall Score: ${overallScore}/100</h3>
          ${hasJobDescription ? '<p style="color: #00ff00; margin-bottom: 10px;">‚úÖ Analyzed against job description</p>' : ''}
          <div style="width: 100%; background: rgba(255,255,255,0.2); border-radius: 10px; height: 20px; margin: 0 auto; max-width: 400px;">
            <div style="width: ${overallScore}%; background: linear-gradient(90deg, #4caf50, #2196f3); height: 100%; border-radius: 10px; transition: width 0.5s ease;"></div>
          </div>
        </div>
      `;

      analysis.categories.forEach(category => {
        html += `
          <div class="feedback-category ${category.status}">
            <h3>
              <span class="status-icon ${category.status}"></span>
              ${category.name} (${category.score}/100)
            </h3>
            <p style="margin-bottom: 15px;">${category.feedback}</p>
            ${category.suggestions.length > 0 ? `
              <div>
                <strong>Suggestions for improvement:</strong>
                <ul style="margin-top: 10px; padding-left: 20px;">
                  ${category.suggestions.map(suggestion => `<li>${suggestion}</li>`).join('')}
                </ul>
              </div>
            ` : ''}
          </div>
        `;
      });

      feedbackContent.innerHTML = html;
      document.getElementById('feedbackSection').classList.add('show');
      document.getElementById('downloadSection').classList.add('show');
    }

    // Show the beautiful completion modal
    function showCompletionModal(score) {
      const modal = document.getElementById('completionModal');
      const scoreElement = document.getElementById('completionScore');
      
      scoreElement.textContent = `${score}/100`;
      modal.classList.add('show');
      
      // Auto-close after 4 seconds or wait for user click
      setTimeout(() => {
        if (modal.classList.contains('show')) {
          closeCompletionModal();
        }
      }, 4000);
    }

    // Close the completion modal
    function closeCompletionModal() {
      const modal = document.getElementById('completionModal');
      modal.classList.remove('show');
      
      // Scroll to results after modal closes
      setTimeout(() => {
        document.getElementById('feedbackSection').scrollIntoView({ behavior: 'smooth' });
      }, 300);
    }

    function downloadResume(type) {
      if (!analysisResults || !resumeData) {
        alert('Please analyze your resume first.');
        return;
      }

      // Show preparation state
      const option = event.target.closest('.download-option');
      const originalText = option.querySelector('.download-btn').textContent;
      
      option.querySelector('.download-btn').textContent = 'Generating Document...';
      option.querySelector('.download-btn').disabled = true;

      // Generate and download the document
      setTimeout(() => {
        try {
          let filename, blob;
          
          // Create HTML document that Word can open perfectly
          const htmlContent = generateHTMLDocument(type, resumeData.content, analysisResults);
          filename = `improved_resume_${type}_${Date.now()}.doc`;
          
          // Create HTML blob with proper Word headers
          blob = new Blob([htmlContent], { 
            type: 'application/msword' 
          });
          
          // Use built-in download functionality
          downloadFile(blob, filename);
          
          // Show success message
          alert(`‚úÖ ${type.charAt(0).toUpperCase() + type.slice(1)} resume downloaded successfully!\n\nFile: ${filename}\n\nThe document will open in Microsoft Word with proper formatting and includes your analysis results.`);
          
        } catch (error) {
          console.error('Error generating document:', error);
          
          // Fallback to text download
          const fallbackContent = createFallbackDocument(type, resumeData.content, analysisResults);
          const blob = new Blob([fallbackContent], { type: 'text/plain' });
          const filename = `improved_resume_${type}_${Date.now()}.txt`;
          downloadFile(blob, filename);
          
          alert(`‚ö†Ô∏è Document generation encountered an issue.\n\nA text version has been downloaded instead: ${filename}\n\nYou can copy the content into Microsoft Word and format it manually.`);
        } finally {
          option.querySelector('.download-btn').textContent = originalText;
          option.querySelector('.download-btn').disabled = false;
        }
      }, 500);
    }

    // Simple file download function
    function downloadFile(blob, filename) {
      // Check if saveAs is available (FileSaver.js)
      if (typeof saveAs !== 'undefined') {
        saveAs(blob, filename);
        return;
      }
      
      // Fallback to native browser download
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.style.display = 'none';
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);
    }

    // Generate HTML document that Word can open perfectly
    function generateHTMLDocument(template, resumeText, analysis) {
      const sections = parseResumeText(resumeText);
      
      // Create HTML document with Word-compatible styling
      let html = `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>${sections.name || 'Resume'} - ${template.charAt(0).toUpperCase() + template.slice(1)} Format</title>
    <style>
        body { 
            font-family: 'Times New Roman', Times, serif; 
            margin: 1in; 
            line-height: 1.4; 
            color: #000;
        }
        .header { 
            text-align: center; 
            margin-bottom: 20px; 
        }
        .name { 
            font-size: 24px; 
            font-weight: bold; 
            ${template === 'modern' ? 'color: #0B4F6C;' : ''}
            ${template === 'classic' ? 'text-decoration: underline;' : ''}
            margin-bottom: 10px; 
        }
        .contact { 
            font-size: 14px; 
            margin-bottom: 20px; 
        }
        .section-header { 
            font-size: 16px; 
            font-weight: bold; 
            ${template === 'modern' ? 'color: #0B4F6C;' : ''}
            ${template === 'classic' ? 'text-decoration: underline;' : ''}
            margin-top: 20px; 
            margin-bottom: 10px; 
            text-transform: uppercase;
        }
        .section-content { 
            margin-bottom: 15px; 
            text-align: justify;
        }
        .analysis-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #ccc;
        }
        .analysis-header {
            font-size: 14px;
            font-weight: bold;
            color: #666;
            margin-bottom: 10px;
        }
        .score {
            font-weight: bold;
            font-size: 16px;
        }
        .category {
            margin-bottom: 10px;
        }
        .suggestions {
            margin-left: 20px;
            font-style: italic;
        }
        ul {
            padding-left: 20px;
        }
        li {
            margin-bottom: 3px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="name">${sections.name || 'Your Name'}</div>
        <div class="contact">${sections.contact || 'your.email@example.com | (555) 123-4567'}</div>
    </div>

    <div class="section-header">Professional Summary</div>
    <div class="section-content">
        ${sections.summary || 'Professional summary highlighting key achievements and skills relevant to your target role.'}
    </div>

    <div class="section-header">Professional Experience</div>
    <div class="section-content">
        ${formatText(sections.experience || 'Your work experience details here.')}
    </div>

    <div class="section-header">${template === 'modern' ? 'Core Skills' : 'Skills'}</div>
    <div class="section-content">
        ${formatText(sections.skills || 'List your key skills and competencies here.')}
    </div>

    <div class="section-header">Education</div>
    <div class="section-content">
        ${formatText(sections.education || 'Your education details here.')}
    </div>

    <div class="analysis-section">
        <div class="analysis-header">RESUME ANALYSIS RESULTS</div>
        <div class="score">Overall Score: ${analysis.overallScore}/100</div>
        
        ${analysis.categories.map(category => `
            <div class="category">
                <strong>${category.name}: ${category.score}/100</strong><br>
                ${category.feedback}
                ${category.suggestions.length > 0 ? `
                    <div class="suggestions">
                        <strong>Suggestions:</strong>
                        <ul>
                            ${category.suggestions.map(suggestion => `<li>${suggestion}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}
            </div>
        `).join('')}
    </div>
</body>
</html>`;

      return html;
    }

    // Format text with line breaks and basic formatting
    function formatText(text) {
      return text
        .replace(/\n/g, '<br>')
        .replace(/‚Ä¢/g, '&bull;')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    }

    // Parse resume text into sections
    function parseResumeText(text) {
      const sections = {
        name: '',
        contact: '',
        summary: '',
        experience: '',
        education: '',
        skills: '',
        other: ''
      };

      const lines = text.split('\n').map(line => line.trim()).filter(line => line);
      let currentSection = 'other';
      
      // Try to identify the name (usually first line or first substantial line)
      if (lines.length > 0) {
        sections.name = lines[0];
      }

      for (let i = 0; i < lines.length; i++) {
        const line = lines[i].toLowerCase();
        
        // Identify sections
        if (line.includes('experience') || line.includes('employment') || line.includes('work history')) {
          currentSection = 'experience';
          continue;
        } else if (line.includes('education') || line.includes('academic')) {
          currentSection = 'education';
          continue;
        } else if (line.includes('skills') || line.includes('competencies') || line.includes('technical')) {
          currentSection = 'skills';
          continue;
        } else if (line.includes('summary') || line.includes('profile') || line.includes('objective')) {
          currentSection = 'summary';
          continue;
        } else if (line.includes('@') || line.includes('phone') || line.includes('email') || line.includes('linkedin')) {
          currentSection = 'contact';
        }

        // Add line to current section
        if (currentSection !== 'other' && i > 0) { // Skip name line
          sections[currentSection] += lines[i] + '\n';
        }
      }

      return sections;
    }

    // Create fallback text document when Word generation fails
    function createFallbackDocument(template, resumeText, analysis) {
      const sections = parseResumeText(resumeText);
      const templateName = template.charAt(0).toUpperCase() + template.slice(1);
      
      let content = `${templateName.toUpperCase()} RESUME\n`;
      content += `${'='.repeat(50)}\n\n`;
      
      content += `${sections.name || 'Your Name'}\n`;
      content += `${'-'.repeat(30)}\n`;
      content += `${sections.contact || 'your.email@example.com | (555) 123-4567'}\n\n`;
      
      content += `PROFESSIONAL SUMMARY\n`;
      content += `${'-'.repeat(30)}\n`;
      content += `${sections.summary || 'Professional summary highlighting key achievements and skills.'}\n\n`;
      
      content += `PROFESSIONAL EXPERIENCE\n`;
      content += `${'-'.repeat(30)}\n`;
      content += `${sections.experience || 'Your work experience details here.'}\n\n`;
      
      content += `SKILLS\n`;
      content += `${'-'.repeat(30)}\n`;
      content += `${sections.skills || 'List your key skills here.'}\n\n`;
      
      content += `EDUCATION\n`;
      content += `${'-'.repeat(30)}\n`;
      content += `${sections.education || 'Your education details here.'}\n\n`;
      
      content += `RESUME ANALYSIS RESULTS\n`;
      content += `${'='.repeat(50)}\n`;
      content += `Overall Score: ${analysis.overallScore}/100\n\n`;
      
      analysis.categories.forEach(category => {
        content += `${category.name}: ${category.score}/100\n`;
        content += `Feedback: ${category.feedback}\n`;
        if (category.suggestions.length > 0) {
          content += `Suggestions:\n`;
          category.suggestions.forEach(suggestion => {
            content += `  ‚Ä¢ ${suggestion}\n`;
          });
        }
        content += `\n`;
      });
      
      content += `\nInstructions:\n`;
      content += `1. Copy this content into Microsoft Word\n`;
      content += `2. Format the headings and sections as needed\n`;
      content += `3. Apply your preferred fonts and spacing\n`;
      content += `4. Save as a .docx file\n`;
      
      return content;
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      // Any initialization code here
      console.log('Resume Analyzer page loaded');
    });
  </script>
</body>
</html>
