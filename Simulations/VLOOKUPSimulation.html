
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel VLOOKUP Master Training</title>
    
    <style>
        /* ===== GLOBAL RESET & BASE STYLES ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box; /* Ensures padding/border included in element width/height */
            /* Disable spell-check globally to prevent red underlines in Excel cells */
            -webkit-spellcheck: false;
            -moz-spellcheck: false;
            spellcheck: false;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; /* Windows/Office-like font */
            background: #f0f0f0; /* Light gray background like Excel */
            color: #000;
            overflow: hidden; /* Prevent scrollbars on main window */
            /* Additional spell-check removal for body */
            -webkit-spellcheck: false;
            -moz-spellcheck: false;
            spellcheck: false;
        }

        /* Global removal of all text decorations and spell-check */
        * {
            -webkit-spellcheck: false;
            -moz-spellcheck: false;
            spellcheck: false;
            /* Force remove any browser-applied text decorations */
            -webkit-text-decoration-line: none !important;
            -webkit-text-decoration-style: none !important;
            -webkit-text-decoration-color: transparent !important;
            text-decoration: none !important;
        }

        /* Extra protection for contenteditable elements */
        *[contenteditable] {
            -webkit-spellcheck: false;
            -moz-spellcheck: false;
            spellcheck: false;
            -webkit-text-decoration-line: none !important;
            text-decoration: none !important;
        }

        /* ===== EXCEL WINDOW HEADER ===== */
        /* Simulates the actual Excel window title bar */
        .excel-window-header {
            background: linear-gradient(to bottom, #4a4a4a, #2d2d30); /* Dark gradient like Excel */
            color: #ffffff;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between; /* Title left, controls right */
            font-size: 12px;
            border-bottom: 2px solid #1a1a1a;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2); /* Subtle shadow */
        }

        .window-title {
            display: flex;
            align-items: center;
            gap: 10px; /* Space between icon and text */
        }

        /* Green Excel icon simulation */
        .excel-icon {
            width: 18px;
            height: 18px;
            background: linear-gradient(135deg, #107c41, #0e6b37); /* Excel green */
            border-radius: 3px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        .window-controls {
            display: flex;
            gap: 1px; /* Tight spacing between minimize/maximize/close */
        }

        /* Window control buttons (minimize, maximize, close) */
        .control-btn {
            width: 46px;
            height: 29px;
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .control-btn:hover {
            background: rgba(255,255,255,0.1); /* Light highlight on hover */
        }

        /* ===== EXCEL RIBBON INTERFACE ===== */
        /* Main ribbon container */
        .excel-ribbon {
            background: linear-gradient(to bottom, #4a4a4a, #2d2d30);
            color: #ffffff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Ribbon tabs (File, Home, Insert, etc.) */
        .ribbon-tabs {
            background: linear-gradient(to bottom, #4a4a4a, #3a3a3a);
            display: flex;
            border-bottom: 1px solid #3e3e42;
        }

        .ribbon-tab {
            padding: 10px 18px;
            cursor: pointer;
            font-size: 11px;
            border-bottom: 2px solid transparent; /* Hidden border for active state */
            color: #cccccc;
            transition: all 0.2s;
        }

        .ribbon-tab:hover {
            background: rgba(255,255,255,0.05);
            color: #ffffff;
        }

        /* Active tab styling (Home tab) */
        .ribbon-tab.active {
            background: linear-gradient(to bottom, #484848, #404040);
            color: #ffffff;
            border-bottom-color: #0078d4; /* Blue accent line */
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Ribbon content area with tool groups */
        .ribbon-content {
            background: linear-gradient(to bottom, #525252, #424242);
            padding: 8px 16px;
            display: flex;
            gap: 16px;
            align-items: center;
            min-height: 100px;
            border-bottom: 2px solid #2d2d30;
        }

        /* Individual tool groups within ribbon */
        .ribbon-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 12px;
            border-right: 1px solid rgba(255,255,255,0.1); /* Separator between groups */
            min-height: 84px;
            justify-content: center;
            color: #e0e0e0;
            font-size: 11px;
        }

        /* ===== FORMULA BAR ===== */
        /* Container for name box, fx button, and formula bar */
        .formula-bar-container {
            background: linear-gradient(to bottom, #f8f8f8, #f0f0f0);
            border-bottom: 2px solid #d0d0d0;
            display: flex;
            align-items: center;
            padding: 4px 8px;
            gap: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        /* Shows current cell address (e.g., A1, E2) */
        .name-box {
            width: 80px;
            height: 24px;
            border: 1px solid #c0c0c0;
            background: white;
            font-size: 11px;
            text-align: center;
            line-height: 22px;
            font-family: Calibri, sans-serif; /* Excel's default font */
            border-radius: 2px;
            font-weight: 600;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
        }

        /* Function button (fx) for inserting functions */
        .fx-icon {
            width: 24px;
            height: 24px;
            background: linear-gradient(to bottom, #f8f8f8, #e8e8e8);
            border: 1px solid #c0c0c0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 2px;
            color: #333;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .fx-icon:hover {
            background: linear-gradient(to bottom, #e8e8e8, #d8d8d8);
        }

        /* Main formula input bar */
        .formula-bar {
            flex: 1; /* Takes remaining space */
            height: 24px;
            border: 1px solid #c0c0c0;
            background: white;
            font-size: 11px;
            padding: 4px 8px;
            font-family: Calibri, sans-serif;
            outline: none;
            border-radius: 2px;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
        }

        .formula-bar:focus {
            border-color: #0078d4; /* Blue border when focused */
            box-shadow: 0 0 0 2px rgba(0,120,212,0.2);
        }

        /* ===== EXCEL GRID ===== */
        /* Main container for the Excel spreadsheet grid */
        .excel-grid-container {
            background: white;
            height: calc(100vh - 200px); /* Full height minus header/ribbon/formula bar */
            overflow: auto; /* Allow scrolling for large grids */
            position: relative;
            border-top: 1px solid #d0d0d0;
        }

        /* Table element for the grid */
        .excel-grid {
            border-collapse: separate; /* Allows individual cell borders */
            border-spacing: 0;
            background: white;
        }

        /* Column headers (A, B, C, etc.) and row headers (1, 2, 3, etc.) */
        .col-header, .row-header {
            background: linear-gradient(to bottom, #f8f8f8, #e8e8e8);
            border: 1px solid #c0c0c0;
            text-align: center;
            font-size: 11px;
            font-family: Calibri, sans-serif;
            font-weight: 500;
            color: #333;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.7); /* Subtle inner highlight */
        }

        .col-header:hover, .row-header:hover {
            background: linear-gradient(to bottom, #e8e8e8, #d8d8d8);
        }

        /* Column header specific sizing */
        .col-header {
            width: 84px; /* Standard Excel column width */
            height: 24px;
            line-height: 22px;
        }

        /* Row header specific sizing */
        .row-header {
            width: 44px; /* Narrower for row numbers */
            height: 24px;
            line-height: 22px;
        }

        /* ===== EXCEL CELLS - MAIN FUNCTIONALITY ===== */
        /* Individual Excel cells - most important styling */
        .excel-cell {
            border: 1px solid #d0d0d0; /* Light gray border */
            width: 84px;
            height: 24px;
            padding: 2px 6px;
            font-size: 11px;
            font-family: Calibri, sans-serif;
            background: white;
            cursor: cell; /* Crosshair cursor like Excel */
            outline: none;
            line-height: 20px;
            vertical-align: middle;
            position: relative;
            transition: all 0.15s ease;
            user-select: text; /* Allow text selection */
            overflow: hidden;
            /* Critical: Remove all spell-check and grammar underlining */
            -webkit-spellcheck: false;
            -moz-spellcheck: false;
            spellcheck: false;
            -webkit-text-decoration-line: none !important;
            -webkit-text-decoration-style: none !important;
            -webkit-text-decoration-color: transparent !important;
            text-decoration: none !important;
        }

        /* Extra protection for editable cells */
        .excel-cell[contenteditable="true"] {
            -webkit-spellcheck: false;
            -moz-spellcheck: false;
            spellcheck: false;
            -webkit-text-decoration-line: none !important;
            text-decoration: none !important;
            text-decoration-line: none !important;
            text-decoration-style: none !important;
            text-decoration-color: transparent !important;
        }

        .excel-cell[contenteditable="true"]:focus {
            -webkit-text-decoration-line: none !important;
            text-decoration: none !important;
            outline: none;
        }

        /* Force remove any browser-applied decorations */
        .excel-cell * {
            text-decoration: none !important;
            -webkit-text-decoration-line: none !important;
        }

        /* Cell hover effect */
        .excel-cell:hover {
            background: #f8f9fa;
            border-color: #a0a0a0;
        }

        /* Selected cell styling (blue border like Excel) */
        .excel-cell.selected {
            border: 2px solid #0078d4 !important;
            background: white !important;
            box-shadow: 0 0 0 1px #0078d4 inset, 0 0 12px rgba(0,120,212,0.25) !important;
            z-index: 10; /* Above other cells */
        }

        /* Cell being edited styling */
        .excel-cell.editing {
            border: 2px solid #0078d4;
            background: white;
            z-index: 15; /* Above selected cells */
            cursor: text;
        }

        /* Highlighted cell for training instructions */
        .excel-cell.highlighted {
            background: #fff3cd !important; /* Yellow background */
            border-color: #ffc107 !important;
            animation: pulse 2s infinite; /* Gentle pulsing animation */
            box-shadow: 0 0 15px rgba(255,193,7,0.5) !important;
        }

        /* Cells highlighted as part of a range (A2:B6) */
        .excel-cell.range-highlighted {
            background: #e3f2fd !important; /* Light blue */
            border-color: #2196f3 !important;
            box-shadow: 0 0 10px rgba(33,150,243,0.4) !important;
            animation: rangeGlow 1.5s infinite;
        }

        /* Cells highlighted for lookup operations */
        .excel-cell.lookup-highlighted {
            background: #f3e5f5 !important; /* Light purple */
            border-color: #9c27b0 !important;
            box-shadow: 0 0 10px rgba(156,39,176,0.4) !important;
            animation: lookupGlow 1.5s infinite;
        }

        /* ===== ANIMATIONS FOR VISUAL FEEDBACK ===== */
        /* Gentle pulsing for highlighted cells */
        @keyframes pulse {
            0%, 100% { 
                background: #fff3cd;
                transform: scale(1);
            }
            50% { 
                background: #ffeb3b;
                transform: scale(1.01); /* Very subtle scale change */
            }
        }

        /* Glow effect for range selections */
        @keyframes rangeGlow {
            0%, 100% { 
                background: #e3f2fd;
                border-color: #2196f3;
            }
            50% { 
                background: #bbdefb;
                border-color: #1976d2;
            }
        }

        /* Glow effect for lookup references */
        @keyframes lookupGlow {
            0%, 100% { 
                background: #f3e5f5;
                border-color: #9c27b0;
            }
            50% { 
                background: #e1bee7;
                border-color: #7b1fa2;
            }
        }

        /* Cells containing formulas get special styling */
        .has-formula {
            font-weight: 600;
            background: linear-gradient(135deg, #e8f5e9, #c8e6c9) !important; /* Green gradient */
            color: #1b5e20;
            text-align: center;
            animation: resultGlow 0.8s ease-out; /* Highlight when result appears */
        }

        /* Animation when formula result is calculated */
        @keyframes resultGlow {
            0% { 
                background: #ffeb3b; /* Start with bright yellow */
                transform: scale(1.05);
                box-shadow: 0 0 20px rgba(255,235,59,0.6);
            }
            100% { 
                background: linear-gradient(135deg, #e8f5e9, #c8e6c9); /* End with green */
                transform: scale(1);
            }
        }

        /* ===== TRAINING PANEL - RIGHT SIDEBAR ===== */
        /* Main training panel container */
        .training-panel {
            position: fixed;
            right: 0;
            top: 0;
            width: 480px;
            height: 100vh;
            background: linear-gradient(145deg, #667eea 0%, #764ba2 100%); /* Purple gradient */
            color: white;
            z-index: 3000; /* Above everything else */
            display: flex;
            flex-direction: column;
            box-shadow: -8px 0 32px rgba(0,0,0,0.4); /* Left shadow */
            transform: translateX(100%); /* Hidden by default */
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1); /* Smooth slide */
        }

        /* Panel visible state */
        .training-panel.active {
            transform: translateX(0); /* Slide in from right */
        }

        /* Training panel header */
        .training-header {
            background: rgba(0,0,0,0.25); /* Semi-transparent overlay */
            padding: 24px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            backdrop-filter: blur(5px); /* Blur effect */
        }

        .training-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3); /* Text shadow for depth */
        }

        .training-subtitle {
            font-size: 14px;
            opacity: 0.9;
            font-weight: 300;
        }

        /* Progress tracking section */
        .progress-container {
            padding: 24px;
            border-bottom: 1px solid rgba(255,255,255,0.15);
        }

        /* Progress bar background */
        .progress-bar {
            background: rgba(255,255,255,0.2);
            height: 8px;
            border-radius: 4px;
            margin-bottom: 12px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }

        /* Progress bar fill */
        .progress-fill {
            background: linear-gradient(90deg, #4CAF50, #66BB6A); /* Green gradient */
            height: 100%;
            width: 0%; /* Starts empty */
            border-radius: 4px;
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1); /* Smooth width animation */
            box-shadow: 0 2px 8px rgba(76,175,80,0.4);
        }

        .progress-text {
            font-size: 13px;
            opacity: 0.95;
            font-weight: 500;
            text-align: center;
        }

        /* Container for all training steps */
        .steps-container {
            flex: 1; /* Take remaining space */
            overflow-y: auto; /* Scrollable if too many steps */
            padding: 0 24px 24px;
        }

        /* ===== INDIVIDUAL TRAINING STEPS ===== */
        /* Individual step styling */
        .step {
            background: rgba(255,255,255,0.08); /* Semi-transparent white */
            margin-bottom: 20px;
            border-radius: 16px;
            padding: 24px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(255,255,255,0.1);
            position: relative;
            overflow: hidden;
        }

        /* Top accent line for steps */
        .step::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: transparent; /* Hidden by default */
            transition: all 0.3s ease;
        }

        /* Active step styling */
        .step.active {
            background: rgba(255,255,255,0.18); /* More opaque */
            box-shadow: 0 12px 32px rgba(0,0,0,0.3); /* Larger shadow */
            border-color: rgba(255,255,255,0.25);
            transform: translateY(-4px); /* Slight lift effect */
        }

        /* Orange accent for active step */
        .step.active::before {
            background: linear-gradient(90deg, #ff9800, #ffb74d);
        }

        /* Completed step styling */
        .step.completed {
            background: rgba(76, 175, 80, 0.25); /* Green tint */
            border-color: rgba(76, 175, 80, 0.4);
        }

        /* Green accent for completed steps */
        .step.completed::before {
            background: #4CAF50;
        }

        /* Waiting/future steps are dimmed */
        .step.waiting {
            opacity: 0.6;
        }

        /* Step header with number and title */
        .step-header {
            display: flex;
            align-items: center;
            gap: 18px;
            margin-bottom: 16px;
        }

        /* Circular step number */
        .step-number {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        /* Completed step number (shows checkmark) */
        .step-number.completed {
            background: #4CAF50;
            box-shadow: 0 4px 16px rgba(76,175,80,0.4);
            animation: completePulse 0.6s ease-out; /* Pulse when completed */
        }

        /* Active step number */
        .step-number.active {
            background: #ff9800; /* Orange */
            box-shadow: 0 4px 16px rgba(255,152,0,0.4);
            animation: activePulse 2s infinite; /* Continuous gentle pulse */
        }

        /* Animation for completing a step */
        @keyframes completePulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        /* Animation for active step */
        @keyframes activePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); } /* Very gentle pulse */
        }

        .step-title {
            font-size: 18px;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        /* Step description text */
        .step-description {
            font-size: 14px;
            line-height: 1.5;
            opacity: 0.92;
            margin-bottom: 16px;
        }

        /* Instruction box for current step */
        .step-instruction {
            background: rgba(255,255,255,0.15);
            padding: 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            border-left: 4px solid #ff9800; /* Orange accent */
            margin-bottom: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        /* Action button for steps that require button clicks */
        .step-action {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(76,175,80,0.3);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .step-action:hover:not(:disabled) {
            background: linear-gradient(135deg, #45a049, #388e3c);
            transform: translateY(-2px); /* Lift on hover */
            box-shadow: 0 6px 20px rgba(76,175,80,0.4);
        }

        .step-action:disabled {
            background: rgba(255,255,255,0.2);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Status messages for steps */
        .status-message {
            margin-top: 16px;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            display: none; /* Hidden by default */
            animation: slideIn 0.3s ease-out;
        }

        /* Slide in animation for status messages */
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Success message styling */
        .status-message.success {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid rgba(76, 175, 80, 0.5);
            color: #e8f5e8;
            display: block;
        }

        /* Waiting message styling */
        .status-message.waiting {
            background: rgba(255, 193, 7, 0.2);
            border: 1px solid rgba(255, 193, 7, 0.5);
            color: #fff8e1;
            display: block;
        }

        /* ===== TOGGLE BUTTON FOR TRAINING PANEL ===== */
        /* Button to show/hide training panel */
        .toggle-panel {
            position: fixed;
            right: 20px;
            top: 50%;
            transform: translateY(-50%); /* Vertical center */
            background: linear-gradient(145deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 20px 14px;
            border-radius: 12px 0 0 12px; /* Rounded left edge only */
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            writing-mode: vertical-lr; /* Vertical text */
            z-index: 2500;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: -4px 0 20px rgba(0,0,0,0.3);
            letter-spacing: 1px;
        }

        .toggle-panel:hover {
            transform: translateY(-50%) translateX(-6px); /* Slide left on hover */
            box-shadow: -6px 0 24px rgba(0,0,0,0.4);
            background: linear-gradient(145deg, #5a6fd8, #6a42a0);
        }

        /* Position when panel is open */
        .toggle-panel.panel-open {
            right: 500px; /* Move left when panel is visible */
        }

        /* ===== EXCEL CONTAINER ADJUSTMENT ===== */
        /* Main Excel area that adjusts when panel opens */
        .excel-container {
            transition: margin-right 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Shrink Excel area when panel is open */
        .excel-container.panel-open {
            margin-right: 480px;
        }

        /* ===== INSTRUCTION POINTER (GREEN ARROW) ===== */
        /* Animated green arrow that points to cells */
        .instruction-pointer {
            position: absolute;
            width: 0;
            height: 0;
            /* CSS triangle pointing down */
            border-left: 18px solid transparent;
            border-right: 18px solid transparent;
            border-bottom: 25px solid #4CAF50;
            z-index: 1000;
            animation: gentleBounce 2s infinite; /* Gentle bounce */
            pointer-events: none; /* Don't interfere with clicking */
            filter: drop-shadow(0 4px 8px rgba(76, 175, 80, 0.4)); /* Shadow */
        }

        /* Arrow tail */
        .instruction-pointer::after {
            content: '';
            position: absolute;
            top: 25px;
            left: -8px;
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 10px solid #4CAF50;
        }

        /* Gentle bounce animation for instruction pointer */
        @keyframes gentleBounce {
            0%, 85%, 100% { 
                transform: translateY(0);
                filter: drop-shadow(0 4px 8px rgba(76, 175, 80, 0.4));
            }
            42% { 
                transform: translateY(-3px); /* Small bounce movement */
                filter: drop-shadow(0 5px 10px rgba(76, 175, 80, 0.45));
            }
        }

        /* ===== CUSTOM SCROLLBAR ===== */
        /* Styled scrollbar for steps container */
        .steps-container::-webkit-scrollbar {
            width: 8px;
        }

        .steps-container::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
        }

        .steps-container::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.3);
            border-radius: 4px;
        }

        .steps-container::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,0.4);
        }

        /* Better Mobile Space Utilization - Larger Elements */
        @media (max-width: 768px) {
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                background: #f8f9fa;
                margin: 0;
                padding: 0;
                font-size: 12px; /* Larger base font for readability */
                line-height: 1.3;
            }
            
            /* Better space utilization */
            .vlookup-container {
                grid-template-columns: 1fr;
                grid-template-rows: 1fr auto;
                height: 100vh;
                overflow: hidden;
                background: #ffffff;
            }
            
            /* Larger Excel window - use more space */
            .excel-window {
                grid-column: 1;
                grid-row: 1;
                margin: 0;
                border-radius: 0;
                max-height: 65vh; /* Better space allocation */
                overflow: hidden;
                background: #ffffff;
                border-bottom: 2px solid #1a73e8;
            }
            
            .excel-titlebar {
                padding: 6px 10px; /* Better padding */
                min-height: 28px; /* Better height */
                background: linear-gradient(135deg, #1a73e8, #1557b0);
                color: white;
                display: flex;
                align-items: center;
                justify-content: space-between;
                font-size: 11px; /* Readable text */
            }
            
            .window-title {
                font-size: 12px; /* More readable title */
                font-weight: 600;
            }
            
            .excel-icon {
                width: 16px; /* Better icon size */
                height: 16px;
            }
            
            .control-btn {
                width: 24px; /* Better button size */
                height: 24px;
                font-size: 10px;
                background: rgba(255,255,255,0.2);
                border: 1px solid rgba(255,255,255,0.3);
                color: white;
                border-radius: 4px;
                cursor: pointer;
                transition: all 0.2s ease;
            }
            
            .control-btn:hover {
                background: rgba(255,255,255,0.3);
            }
            
            /* Hide ribbon but show essential tools */
            .excel-ribbon {
                display: none; /* Keep hidden to maximize Excel space */
            }
            
            /* Better formula bar */
            .formula-bar-container {
                padding: 4px 8px; /* Better padding */
                gap: 6px;
                background: #f8f9fa;
                border-bottom: 1px solid #e0e0e0;
                display: flex;
                align-items: center;
                min-height: 32px; /* Better height */
            }
            
            .name-box {
                width: 40px; /* Better width */
                font-size: 11px; /* Readable font */
                padding: 4px 6px;
                border: 1px solid #dadce0;
                border-radius: 4px;
                background: #ffffff;
                text-align: center;
                font-weight: 600;
                font-family: 'Courier New', monospace;
            }
            
            .fx-icon {
                width: 28px; /* Better size */
                height: 28px;
                font-size: 10px;
                background: #1a73e8;
                color: white;
                border: none;
                border-radius: 4px;
                font-weight: 700;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .formula-bar {
                flex: 1;
                font-size: 11px; /* Better font size */
                padding: 4px 8px;
                min-height: 24px;
                border: 1px solid #dadce0;
                border-radius: 4px;
                background: #ffffff;
                font-family: 'Courier New', monospace;
                line-height: 1.2;
            }
            
            .formula-bar:focus {
                outline: none;
                border-color: #1a73e8;
                box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
            }
            
            /* Better Excel grid - larger cells */
            .excel-grid-container {
                max-height: calc(65vh - 80px); /* Better space usage */
                overflow: auto;
                -webkit-overflow-scrolling: touch;
                background: #ffffff;
            }
            
            .excel-grid {
                font-size: 11px; /* Better font size */
                min-width: 400px; /* Better minimum width */
                border-collapse: collapse;
            }
            
            .col-header,
            .row-header {
                padding: 4px 2px; /* Better padding */
                font-size: 10px; /* Readable font */
                min-width: 40px; /* Better column width */
                height: 24px; /* Better height */
                background: #f8f9fa;
                border: 1px solid #dadce0;
                text-align: center;
                font-weight: 600;
                color: #5f6368;
            }
            
            .excel-cell {
                padding: 2px 4px; /* Better padding */
                font-size: 11px; /* Better font size */
                min-width: 40px; /* Better cell width */
                height: 24px; /* Better height */
                border: 1px solid #dadce0;
                line-height: 1.2;
                background: #ffffff;
                text-align: left;
                vertical-align: middle;
                cursor: cell;
                transition: all 0.1s ease;
            }
            
            .excel-cell:hover {
                background: #f8f9fa;
            }
            
            .excel-cell.selected {
                border: 2px solid #1a73e8;
                background: rgba(26, 115, 232, 0.1);
                box-shadow: 0 0 0 1px #1a73e8;
            }
            
            .excel-cell.editing {
                padding: 1px 4px;
                font-size: 12px;
                background: #ffffff;
                border: 2px solid #34a853;
                box-shadow: 0 0 0 2px rgba(52, 168, 83, 0.2);
            }
            
            /* Better training panel - more space */
            .training-panel {
                grid-column: 1;
                grid-row: 2;
                width: 100%;
                height: auto;
                max-height: 35vh; /* Better space allocation */
                right: auto;
                transform: none;
                border-radius: 12px 12px 0 0;
                border-top: 2px solid #1a73e8;
                position: relative;
                overflow-y: auto;
                background: linear-gradient(135deg, #f8f9fa, #ffffff);
                box-shadow: 0 -3px 12px rgba(0,0,0,0.15);
            }
            
            .training-panel.active {
                transform: none;
                display: block;
            }
            
            .training-header {
                padding: 10px 15px; /* Better padding */
                border-bottom: 1px solid rgba(26, 115, 232, 0.2);
                position: sticky;
                top: 0;
                background: linear-gradient(135deg, #1a73e8, #1557b0);
                color: white;
                z-index: 10;
                border-radius: 12px 12px 0 0;
            }
            
            .training-title {
                font-size: 16px; /* Better title size */
                margin-bottom: 4px;
                font-weight: 700;
                text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            }
            
            .training-subtitle {
                font-size: 12px; /* Better subtitle */
                margin: 0;
                opacity: 0.95;
            }
            
            .progress-container {
                padding: 8px 15px; /* Better padding */
                border-bottom: 1px solid rgba(26, 115, 232, 0.1);
                background: rgba(255, 255, 255, 0.95);
                position: sticky;
                top: 54px; /* Below header */
                z-index: 9;
            }
            
            .progress-bar {
                height: 6px; /* Better progress bar */
                margin-bottom: 6px;
                border-radius: 3px;
                background: #e9ecef;
                overflow: hidden;
                box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
            }
            
            .progress-fill {
                height: 100%;
                background: linear-gradient(135deg, #34a853, #0f9d58);
                transition: width 0.5s ease;
                border-radius: 3px;
            }
            
            .progress-text {
                font-size: 10px; /* Better progress text */
                color: #5f6368;
                text-align: center;
                font-weight: 600;
            }
            
            /* Better steps container */
            .steps-container {
                padding: 10px 15px 20px; /* Better padding */
                max-height: none;
            }
            
            .step {
                margin-bottom: 12px; /* Better spacing */
                padding: 10px; /* Better padding */
                border-radius: 8px;
                background: #ffffff;
                border: 2px solid #e9ecef;
                box-shadow: 0 2px 6px rgba(0,0,0,0.1);
                transition: all 0.3s ease;
            }
            
            .step:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                border-color: #1a73e8;
            }
            
            .step-header {
                margin-bottom: 6px;
                display: flex;
                align-items: center;
                gap: 8px;
            }
            
            .step-number {
                width: 24px; /* Better step numbers */
                height: 24px;
                font-size: 12px;
                margin-right: 0;
                background: linear-gradient(135deg, #1a73e8, #1557b0);
                color: white;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: 700;
                flex-shrink: 0;
                box-shadow: 0 2px 4px rgba(26, 115, 232, 0.3);
            }
            
            .step-title {
                font-size: 13px; /* Better title size */
                line-height: 1.3;
                color: #202124;
                font-weight: 600;
                margin: 0;
                flex: 1;
            }
            
            .step-description {
                font-size: 11px; /* Better description */
                line-height: 1.4;
                margin-bottom: 6px;
                color: #5f6368;
            }
            
            .step-instruction {
                font-size: 11px; /* Better instruction */
                padding: 6px 10px;
                border-radius: 6px;
                margin-top: 6px;
                background: linear-gradient(135deg, #e8f0fe, #f3e5f5);
                border: 1px solid #d2e3fc;
                color: #1967d2;
                font-weight: 500;
                line-height: 1.3;
            }
            
            .step-action {
                padding: 8px 16px; /* Better button */
                font-size: 12px;
                border-radius: 20px;
                margin-top: 8px;
                width: 100%;
                background: linear-gradient(135deg, #34a853, #0f9d58);
                color: white;
                border: none;
                font-weight: 600;
                cursor: pointer;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                min-height: 36px;
                transition: all 0.3s ease;
                box-shadow: 0 2px 6px rgba(52, 168, 83, 0.3);
            }
            
            .step-action:hover {
                background: linear-gradient(135deg, #0f9d58, #34a853);
                transform: translateY(-1px);
                box-shadow: 0 4px 10px rgba(52, 168, 83, 0.4);
            }
            
            /* Hide toggle button on mobile - not needed */
            .toggle-panel {
                display: none;
            }
            
            /* Very small screens - adjust proportions */
            @media (max-width: 480px) {
                .excel-window {
                    max-height: 60vh; /* Smaller Excel area */
                }
                
                .training-panel {
                    max-height: 40vh; /* Larger training area */
                }
                
                .excel-grid {
                    font-size: 10px; /* Smaller font */
                    min-width: 360px;
                }
                
                .excel-cell, .col-header, .row-header {
                    min-width: 36px; /* Smaller cells */
                    height: 22px;
                    font-size: 10px;
                }
                
                .formula-bar-container {
                    min-height: 28px;
                    padding: 3px 6px;
                }
                
                .name-box {
                    width: 36px;
                    font-size: 10px;
                }
                
                .fx-icon {
                    width: 24px;
                    height: 24px;
                    font-size: 9px;
                }
                
                .formula-bar {
                    font-size: 10px;
                    min-height: 20px;
                }
                
                .training-title {
                    font-size: 14px;
                }
                
                .step-title {
                    font-size: 12px;
                }
                
                .step-description, 
                .step-instruction {
                    font-size: 10px;
                }
                
                .step-action {
                    font-size: 11px;
                    min-height: 32px;
                    padding: 6px 12px;
                }
            }
        }
    </style>
</head>
<body>
    <!-- ===== MAIN EXCEL APPLICATION CONTAINER ===== -->
    <!-- Main container for the Excel simulation, adjusts width when training panel is open -->
    <div class="excel-container panel-open" id="excelContainer">
        
        <!-- ===== EXCEL WINDOW HEADER ===== -->
        <!-- Simulates the actual Excel window title bar with icon and controls -->
        <div class="excel-window-header">
            <div class="window-title">
                <div class="excel-icon"></div> <!-- Green Excel icon -->
                <span>Book1 - Excel</span> <!-- Workbook name -->
                <span style="margin-left: 24px; color: #aaa; font-size: 11px;">AutoSave Off</span>
            </div>
            <div class="window-controls">
                <!-- Window control buttons (non-functional, for visual authenticity) -->
                <button class="control-btn" title="Minimize">−</button>
                <button class="control-btn" title="Maximize">□</button>
                <button class="control-btn" title="Close">×</button>
            </div>
        </div>

        <!-- ===== EXCEL RIBBON INTERFACE ===== -->
        <!-- Simulates Excel's ribbon with tabs and tool groups -->
        <div class="excel-ribbon">
            <!-- Ribbon tabs (File, Home, Insert, etc.) -->
            <div class="ribbon-tabs">
                <div class="ribbon-tab">File</div>
                <div class="ribbon-tab active">Home</div> <!-- Active tab highlighted -->
                <div class="ribbon-tab">Insert</div>
                <div class="ribbon-tab">Page Layout</div>
                <div class="ribbon-tab">Formulas</div>
                <div class="ribbon-tab">Data</div>
                <div class="ribbon-tab">Review</div>
                <div class="ribbon-tab">View</div>
            </div>
            <!-- Ribbon content area with tool groups -->
            <div class="ribbon-content">
                <div class="ribbon-group">Clipboard</div>
                <div class="ribbon-group">Font</div>
                <div class="ribbon-group">Alignment</div>
                <div class="ribbon-group">Number</div>
                <div class="ribbon-group">Styles</div>
                <div class="ribbon-group">Cells</div>
                <div class="ribbon-group">Editing</div>
            </div>
        </div>

        <!-- ===== FORMULA BAR ===== -->
        <!-- Contains name box (cell address), fx button, and formula input bar -->
        <div class="formula-bar-container">
            <div class="name-box" id="nameBox">A1</div> <!-- Shows current cell address -->
            <div class="fx-icon" title="Insert Function">fx</div> <!-- Function button -->
            <!-- Main formula input bar - shows formulas when editing, results when not -->
            <input class="formula-bar" id="formulaBar" placeholder="Click on a cell and start typing..." readonly>
        </div>

        <!-- ===== EXCEL SPREADSHEET GRID ===== -->
        <!-- Container for the main Excel grid -->
        <div class="excel-grid-container">
            <!-- Table element that will be populated with cells by JavaScript -->
            <table class="excel-grid" id="excelGrid">
                <!-- Grid structure (headers and cells) generated dynamically by JavaScript -->
            </table>
        </div>
    </div>

    <!-- ===== TRAINING PANEL (RIGHT SIDEBAR) ===== -->
    <!-- Interactive training guide that slides in from the right -->
    <div class="training-panel active" id="trainingPanel">
        
        <!-- Panel header with title and subtitle -->
        <div class="training-header">
            <div class="training-title">🎯 Excel VLOOKUP Training</div>
            <div class="training-subtitle">Follow the steps and interact with Excel directly</div>
        </div>

        <!-- Progress tracking section -->
        <div class="progress-container">
            <!-- Visual progress bar -->
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div> <!-- Animated fill -->
            </div>
            <!-- Progress text (e.g., "Step 2 of 8 • 25% Complete") -->
            <div class="progress-text" id="progressText">Ready to begin your VLOOKUP journey</div>
        </div>

        <!-- Container for all training steps -->
        <div class="steps-container" id="stepsContainer">
            <!-- Training steps are generated dynamically by JavaScript -->
            <!-- Each step includes: title, description, instructions, and status -->
        </div>
    </div>

    <!-- ===== TOGGLE BUTTON ===== -->
    <!-- Button to show/hide the training panel -->
    <button class="toggle-panel panel-open" id="toggleBtn" onclick="training.toggleTrainingPanel()">
        📚 VLOOKUP Training
    </button>

    <!-- ===== INSTRUCTION POINTER ===== -->
    <!-- Animated green arrow that points to specific cells during training -->
    <div class="instruction-pointer" id="instructionPointer" style="display: none;"></div>

    <!-- ===== MAIN JAVASCRIPT APPLICATION ===== -->

    <script>
        /**
         * ===== VLOOKUP TRAINING CLASS =====
         * Main class that handles the Excel VLOOKUP training simulation
         * Manages the entire training experience including:
         * - Excel grid creation and interaction
         * - Step-by-step training progression
         * - Formula validation and calculation
         * - Visual feedback and animations
         */
        class VLookupTraining {
            constructor() {
                // ===== CORE APPLICATION STATE =====
                this.selectedCell = null;           // Currently selected Excel cell
                this.isEditing = false;             // Whether user is currently editing a cell
                this.panelOpen = true;              // Training panel visibility state
                this.currentStep = 0;               // Current training step (0-7)
                this.completedSteps = new Set();    // Set of completed step indices
                this.isProgressingStep = false;     // Flag to prevent concurrent step progressions
                
                // ===== DATA STORAGE =====
                this.cellFormulas = {};             // Stores formulas (e.g., "E2": "=VLOOKUP(D2,A2:B6,2,FALSE)")
                this.cellValues = {};               // Stores display values (e.g., "E2": "Alice Johnson")
                this.trainingSteps = [];            // Array of step definitions
                
                // ===== UI ELEMENT REFERENCES =====
                this.instructionPointer = document.getElementById('instructionPointer'); // Green arrow pointer
                
                // ===== SAMPLE DATA FOR TRAINING =====
                // Pre-defined data that gets populated in Step 1
                this.sampleData = {
                    // Headers
                    A1: 'Employee ID', B1: 'Employee Name', D1: 'Search ID', E1: 'Result',
                    // Employee data for lookup table
                    A2: '101', B2: 'John Smith',
                    A3: '102', B3: 'Sarah Davis', 
                    A4: '103', B4: 'Alice Johnson',
                    A5: '104', B5: 'Michael Brown',
                    A6: '105', B6: 'Emily Wilson',
                    // Lookup value (what we're searching for)
                    D2: '103'
                };

                // ===== EMPLOYEE LOOKUP DATA =====
                // Used by VLOOKUP calculation engine to return correct results
                this.employeeData = {
                    '101': 'John Smith',
                    '102': 'Sarah Davis',
                    '103': 'Alice Johnson', 
                    '104': 'Michael Brown',
                    '105': 'Emily Wilson'
                };

                // Initialize the application
                this.init();
            }

            /**
             * ===== APPLICATION INITIALIZATION =====
             * Sets up the entire training environment
             */
            async init() {
                console.log('🚀 Initializing VLOOKUP Training...');
                this.createExcelGrid();           // Build the Excel spreadsheet grid
                this.setupEventListeners();      // Attach event handlers
                this.initializeTrainingSteps();  // Define training step progression
                this.selectCell(document.querySelector('[data-address="A1"]')); // Start with A1 selected
                this.startTraining();            // Begin the training sequence
            }

            /**
             * ===== EXCEL GRID CREATION =====
             * Dynamically creates the Excel spreadsheet grid with headers and cells
             */
            createExcelGrid() {
                const grid = document.getElementById('excelGrid');
                
                // ===== CREATE HEADER ROW =====
                // First row contains column letters (A, B, C, etc.)
                const headerRow = document.createElement('tr');
                headerRow.appendChild(document.createElement('td')); // Empty corner cell (top-left)
                
                // Generate column headers A through J (10 columns)
                for (let col = 0; col < 10; col++) {
                    const header = document.createElement('td');
                    header.className = 'col-header';
                    header.textContent = String.fromCharCode(65 + col); // A=65, B=66, etc.
                    headerRow.appendChild(header);
                }
                grid.appendChild(headerRow);

                // ===== CREATE DATA ROWS =====
                // Generate 30 rows of data cells
                for (let row = 1; row <= 30; row++) {
                    const tr = document.createElement('tr');
                    
                    // ===== ROW HEADER =====
                    // First cell in each row shows the row number
                    const rowHeader = document.createElement('td');
                    rowHeader.className = 'row-header';
                    rowHeader.textContent = row; // Row numbers 1, 2, 3, etc.
                    tr.appendChild(rowHeader);
                    
                    // ===== DATA CELLS =====
                    // Create 10 data cells per row (A1-J1, A2-J2, etc.)
                    for (let col = 0; col < 10; col++) {
                        const cell = document.createElement('td');
                        cell.className = 'excel-cell';
                        
                        // Generate cell address (A1, B1, C1, etc.)
                        const address = String.fromCharCode(65 + col) + row;
                        cell.dataset.address = address; // Store address for later reference
                        
                        // Attach event handlers for Excel-like interaction
                        this.setupCellEvents(cell);
                        tr.appendChild(cell);
                    }
                    grid.appendChild(tr);
                }
            }

            /**
             * ===== CELL EVENT HANDLERS =====
             * Sets up Excel-like behavior for individual cells
             * Handles: clicking, double-clicking, keyboard input, focus/blur
             */
            setupCellEvents(cell) {
                // ===== SINGLE CLICK TO SELECT =====
                cell.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent event bubbling
                    if (!this.isEditing) { // Only select if not currently editing another cell
                        this.selectCell(cell);
                    }
                });

                // ===== DOUBLE CLICK TO START EDITING =====
                cell.addEventListener('dblclick', (e) => {
                    e.stopPropagation(); // Prevent event bubbling
                    this.startEditing(cell); // Enter edit mode for this cell
                });

                // Keyboard handling
                cell.addEventListener('keydown', (e) => {
                    this.handleCellKeydown(e, cell);
                });

                // Input handling during editing
                cell.addEventListener('input', () => {
                    if (this.isEditing) {
                        // Remove any browser-applied text decorations
                        cell.style.textDecoration = 'none';
                        cell.style.webkitTextDecorationLine = 'none';
                        
                        this.updateFormulaBar();
                        this.checkProgress();
                    }
                });

                // Focus handling
                cell.addEventListener('focus', () => {
                    this.selectCell(cell);
                });

                // Blur handling to finish editing
                cell.addEventListener('blur', () => {
                    if (this.isEditing) {
                        setTimeout(() => this.finishEditing(), 100);
                    }
                });
            }

            setupEventListeners() {
                const formulaBar = document.getElementById('formulaBar');
                
                // Make formula bar show formulas only, not editable
                formulaBar.addEventListener('focus', () => {
                    formulaBar.blur(); // Don't allow direct editing
                });

                // Global keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    // F2 to edit selected cell
                    if (e.key === 'F2' && this.selectedCell && !this.isEditing) {
                        e.preventDefault();
                        this.startEditing(this.selectedCell);
                    }
                });

                // Click outside to hide highlights
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.excel-cell') && !e.target.closest('.training-panel')) {
                        this.hideInstructionPointer();
                    }
                });
            }

            selectCell(cell) {
                if (!cell) return;

                // Remove previous selection
                if (this.selectedCell) {
                    this.selectedCell.classList.remove('selected');
                }

                // Set new selection
                this.selectedCell = cell;
                cell.classList.add('selected');

                // Update name box
                document.getElementById('nameBox').textContent = cell.dataset.address;
                
                // Update formula bar with formula (if exists) or value
                const address = cell.dataset.address;
                const formulaBar = document.getElementById('formulaBar');
                formulaBar.value = this.cellFormulas[address] || cell.textContent || '';

                // Hide instruction pointer when user selects a cell
                this.hideInstructionPointer();

                // Check progress after selection
                this.checkProgress();
            }

            startEditing(cell) {
                if (this.isEditing) return;

                this.isEditing = true;
                cell.classList.add('editing');
                
                const address = cell.dataset.address;
                const originalContent = this.cellFormulas[address] || cell.textContent || '';
                
                // Set cell content to original formula for editing
                cell.textContent = originalContent;
                cell.setAttribute('contenteditable', 'true');
                
                // Disable spell-check and grammar check completely
                cell.setAttribute('spellcheck', 'false');
                cell.setAttribute('autocorrect', 'off');
                cell.setAttribute('autocapitalize', 'off');
                cell.setAttribute('data-gramm', 'false'); // Disable Grammarly
                cell.style.textDecoration = 'none';
                cell.style.webkitTextDecorationLine = 'none';
                
                cell.focus();

                // Update formula bar
                document.getElementById('formulaBar').value = originalContent;

                // Select all content for easy replacement
                setTimeout(() => {
                    const range = document.createRange();
                    range.selectNodeContents(cell);
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(range);
                }, 10);
            }



            handleCellKeydown(e, cell) {
                if (this.isEditing) {
                    // Handle editing mode keys
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.finishEditing();
                        this.navigateCell('down');
                    } else if (e.key === 'Escape') {
                        e.preventDefault();
                        // Restore original value
                        const address = cell.dataset.address;
                        cell.textContent = this.cellValues[address] || '';
                        this.isEditing = false;
                        cell.classList.remove('editing');
                        cell.setAttribute('contenteditable', 'false');
                    } else if (e.key === 'Tab') {
                        e.preventDefault();
                        this.finishEditing();
                        this.navigateCell('right');
                    }
                } else {
                    // Handle navigation mode keys
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.navigateCell('down');
                    } else if (e.key === 'Tab') {
                        e.preventDefault();
                        this.navigateCell('right');
                    } else if (e.key === 'Delete' || e.key === 'Backspace') {
                        e.preventDefault();
                        this.clearCell(cell);
                    } else if (e.key.length === 1 || e.key === '=') {
                        // Start typing - begin editing
                        this.startEditing(cell);
                        cell.textContent = e.key;
                    } else if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
                        e.preventDefault();
                        const direction = e.key.replace('Arrow', '').toLowerCase();
                        this.navigateCell(direction);
                    }
                }
            }

            navigateCell(direction) {
                if (!this.selectedCell) return;

                const address = this.selectedCell.dataset.address;
                const col = address.charCodeAt(0) - 65;
                const row = parseInt(address.slice(1));

                let newCol = col;
                let newRow = row;

                switch(direction) {
                    case 'up': newRow = Math.max(1, row - 1); break;
                    case 'down': newRow = Math.min(30, row + 1); break;
                    case 'left': newCol = Math.max(0, col - 1); break;
                    case 'right': newCol = Math.min(9, col + 1); break;
                }

                const newAddress = String.fromCharCode(65 + newCol) + newRow;
                const nextCell = document.querySelector(`[data-address="${newAddress}"]`);
                if (nextCell) {
                    this.selectCell(nextCell);
                }
            }

            clearCell(cell) {
                const address = cell.dataset.address;
                cell.textContent = '';
                cell.classList.remove('has-formula');
                delete this.cellFormulas[address];
                delete this.cellValues[address];
                document.getElementById('formulaBar').value = '';
                this.checkProgress();
            }

            updateFormulaBar() {
                if (this.selectedCell && this.isEditing) {
                    document.getElementById('formulaBar').value = this.selectedCell.textContent;
                }
            }

            // Method to recalculate formulas when referenced cells change
            recalculateFormulas() {
                Object.keys(this.cellFormulas).forEach(address => {
                    const formula = this.cellFormulas[address];
                    const cell = document.querySelector(`[data-address="${address}"]`);
                    if (cell && formula) {
                        const result = this.calculateFormula(formula);
                        this.cellValues[address] = result;
                        cell.textContent = result;
                        console.log(`Recalculated ${address}: ${formula} = ${result}`);
                    }
                });
                
                // Check progress after recalculation
                setTimeout(() => this.checkProgress(), 100);
            }

            // Override finishEditing to trigger recalculation when cells change
            finishEditing() {
                if (!this.isEditing || !this.selectedCell) return;

                this.isEditing = false;
                this.selectedCell.classList.remove('editing');
                this.selectedCell.setAttribute('contenteditable', 'false');

                const address = this.selectedCell.dataset.address;
                const content = this.selectedCell.textContent.trim();

                if (content.startsWith('=')) {
                    // It's a formula - store it and calculate result
                    this.cellFormulas[address] = content;
                    const result = this.calculateFormula(content);
                    this.cellValues[address] = result;
                    this.selectedCell.textContent = result;
                    this.selectedCell.classList.add('has-formula');
                    
                    console.log(`Formula stored: ${content}, Result: ${result}`);
                } else {
                    // Regular value
                    delete this.cellFormulas[address];
                    this.cellValues[address] = content;
                    this.selectedCell.classList.remove('has-formula');
                }

                // Update formula bar to show the formula
                document.getElementById('formulaBar').value = this.cellFormulas[address] || content;

                // Recalculate all formulas that might reference this cell
                this.recalculateFormulas();
            }

            calculateFormula(formula) {
                try {
                    if (formula.toUpperCase().includes('VLOOKUP')) {
                        return this.calculateVLOOKUP(formula);
                    }
                    // Add other formula types here as needed
                    return formula; // Return as-is if we can't calculate
                } catch (e) {
                    return '#ERROR!';
                }
            }

            calculateVLOOKUP(formula) {
                // Parse VLOOKUP formula: =VLOOKUP(lookup_value, table_array, column_index, range_lookup)
                const match = formula.match(/=VLOOKUP\s*\(\s*([^,]+)\s*,\s*([^,]+)\s*,\s*([^,]+)\s*,\s*([^)]+)\s*\)/i);
                if (!match) return '#ERROR!';

                const [, lookupValue, tableArray, columnIndex, rangeLookup] = match;
                
                // Get the lookup value
                let searchValue = lookupValue.trim();
                if (searchValue.match(/^[A-Z]+\d+$/)) {
                    // It's a cell reference - get the value
                    const refCell = document.querySelector(`[data-address="${searchValue}"]`);
                    searchValue = refCell ? (this.cellValues[searchValue] || refCell.textContent) : '';
                }

                // Use our employee data for lookup
                return this.employeeData[searchValue] || '#N/A';
            }

            // Training System
            initializeTrainingSteps() {
                // ===== TRAINING STEPS DEFINITION =====
                // Array of 8 training steps with validation logic to prevent step skipping
                this.trainingSteps = [
                    // ===== STEP 1: ADD SAMPLE DATA =====
                    {
                        title: "Add Sample Data",
                        description: "Let's start by adding employee data to work with. This creates our lookup table that VLOOKUP will search through.",
                        instruction: "👇 Click the button below to populate the spreadsheet",
                        type: "action",
                        // Validation: Check if header data exists
                        check: () => document.querySelector('[data-address="A1"]')?.textContent === 'Employee ID'
                    },
                    // ===== STEP 2: SELECT RESULT CELL =====
                    {
                        title: "Select Result Cell",
                        description: "Choose where our VLOOKUP result will appear. We'll look up the employee name for the ID in D2.",
                        instruction: "👆 Click on cell E2 in the Excel grid above",
                        target: "E2", // Green arrow points to this cell
                        type: "selection",
                        // Validation: Check if E2 is selected
                        check: () => this.selectedCell?.dataset.address === 'E2'
                    },
                    // ===== STEP 3: START VLOOKUP FORMULA =====
                    {
                        title: "Start VLOOKUP Formula",
                        description: "VLOOKUP is Excel's most powerful lookup function. It searches the first column of a table for a value.",
                        instruction: "💡 Double-click cell E2, then type: =VLOOKUP(",
                        target: "E2",
                        type: "input",
                        // Validation: Only VLOOKUP opening, not complete formula
                        // Prevents step skipping by ensuring formula isn't too advanced
                        check: () => {
                            const e2 = document.querySelector('[data-address="E2"]');
                            const content = e2?.textContent?.toUpperCase() || '';
                            // Must start with =VLOOKUP( but not contain D2 yet
                            return content.startsWith('=VLOOKUP(') && content.length >= 9 && content.length <= 12 && !content.includes('D2');
                        }
                    },
                    // ===== STEP 4: ENTER LOOKUP VALUE =====
                    {
                        title: "Enter Lookup Value",
                        description: "The first argument is what we're looking for. We want to find the name for the employee ID in cell D2.",
                        instruction: "⌨️ Continue typing: D2,",
                        target: "E2",
                        highlightCells: ["D2"], // Highlight the lookup value cell
                        highlightType: "lookup",
                        type: "input",
                        // Validation: Must have VLOOKUP opening AND D2, but not table array yet
                        check: () => {
                            const e2 = document.querySelector('[data-address="E2"]');
                            const content = e2?.textContent?.toUpperCase() || '';
                            // Ensures sequential progression by requiring previous steps
                            return content.includes('=VLOOKUP(') && content.includes('D2,') && !content.includes('A2:B6');
                        }
                    },
                    // ===== STEP 5: DEFINE TABLE ARRAY =====
                    {
                        title: "Define Table Array",
                        description: "The table array tells VLOOKUP where to search. Our employee data is in columns A:B, rows 2-6.",
                        instruction: "⌨️ Continue typing: A2:B6,",
                        target: "E2",
                        highlightCells: ["A2", "A3", "A4", "A5", "A6", "B2", "B3", "B4", "B5", "B6"], // Highlight table range
                        highlightType: "range",
                        type: "input",
                        // Validation: Must have all previous parts but not column index yet
                        check: () => {
                            const e2 = document.querySelector('[data-address="E2"]');
                            const content = e2?.textContent?.toUpperCase() || '';
                            // Sequential validation prevents skipping by requiring all previous components
                            return content.includes('=VLOOKUP(') && content.includes('D2,') && content.includes('A2:B6,') && !content.includes(',2,');
                        }
                    },
                    {
                        title: "Set Column Index",
                        description: "Column index specifies which column to return. Column A=1, Column B=2. We want names from column B.",
                        instruction: "⌨️ Continue typing: 2,",
                        target: "E2",
                        highlightCells: ["B2", "B3", "B4", "B5", "B6"],
                        highlightType: "range",
                        type: "input",
                        check: () => {
                            const e2 = document.querySelector('[data-address="E2"]');
                            const content = e2?.textContent || '';
                            // Check for column index but not FALSE yet
                            return (content.includes(',2,') || content.includes(', 2,')) && !content.includes('FALSE');
                        }
                    },
                    {
                        title: "Set Exact Match",
                        description: "The last argument controls match type. FALSE means exact match - safer for most lookups.",
                        instruction: "⌨️ Finish typing: FALSE)",
                        target: "E2",
                        type: "input",
                        check: () => {
                            // If we're at step 7, and the user has completed the full formula,
                            // we should allow completion even if previous steps weren't individually validated
                            const e2 = document.querySelector('[data-address="E2"]');
                            const content = e2?.textContent?.toUpperCase() || '';
                            const storedFormula = this.cellFormulas['E2']?.toUpperCase() || '';
                            
                            // Check for complete VLOOKUP formula
                            const fullFormulaPattern = /=VLOOKUP\s*\(\s*D2\s*,\s*A2:B6\s*,\s*2\s*,\s*FALSE\s*\)/i;
                            const hasCompleteFormula = fullFormulaPattern.test(content) || fullFormulaPattern.test(storedFormula);
                            
                            // Alternative: Check for the key components
                            const hasVlookup = (content.includes('=VLOOKUP(') || storedFormula.includes('=VLOOKUP('));
                            const hasD2 = (content.includes('D2') || storedFormula.includes('D2'));
                            const hasTableRange = (content.includes('A2:B6') || storedFormula.includes('A2:B6'));
                            const hasColumn2 = (content.includes(',2,') || storedFormula.includes(',2,'));
                            const hasFalse = (content.includes('FALSE)') || storedFormula.includes('FALSE)'));
                            
                            const hasAllComponents = hasVlookup && hasD2 && hasTableRange && hasColumn2 && hasFalse;
                            
                            // Make sure it's not executed yet (shouldn't show employee name as result)
                            const d2Value = this.cellValues['D2'] || document.querySelector('[data-address="D2"]')?.textContent || '103';
                            const isExecuted = this.cellValues['E2'] && this.employeeData[d2Value] === this.cellValues['E2'];
                            
                            // If formula is complete, auto-complete previous steps to allow progression
                            if ((hasCompleteFormula || hasAllComponents) && !isExecuted) {
                                // Auto-complete steps 2-6 if not already completed
                                for (let i = 1; i < 7; i++) {
                                    if (!this.completedSteps.has(i)) {
                                        this.completedSteps.add(i);
                                        console.log(`🔧 Auto-completed step ${i + 1} due to complete formula`);
                                    }
                                }
                            }
                            
                            console.log('Step 7 check:', { 
                                content, 
                                storedFormula, 
                                hasCompleteFormula,
                                hasAllComponents,
                                isExecuted, 
                                d2Value,
                                e2Value: this.cellValues['E2']
                            });
                            
                            return (hasCompleteFormula || hasAllComponents) && !isExecuted;
                        }
                    },
                    {
                        title: "Execute the Formula",
                        description: "Perfect! Your VLOOKUP is complete. Press Enter to execute it and see the magic happen!",
                        instruction: "⏎ Press Enter to run your VLOOKUP formula",
                        target: "E2",
                        highlightCells: ["D2", "E2"],
                        highlightType: "lookup",
                        type: "execution",
                        check: () => {
                            const e2 = document.querySelector('[data-address="E2"]');
                            const d2 = document.querySelector('[data-address="D2"]');
                            if (!e2 || !d2) return false;
                            
                            const searchValue = this.cellValues['D2'] || d2.textContent;
                            const result = this.cellValues['E2'] || e2.textContent;
                            const hasFormula = !!this.cellFormulas['E2'];
                            
                            // Check if we have a formula and the result matches
                            const isComplete = hasFormula && this.employeeData[searchValue] === result;
                            console.log('Step 8 check:', { searchValue, result, hasFormula, expected: this.employeeData[searchValue], isComplete });
                            return isComplete;
                        }
                    },
                    // ===== STEP 9: UNDERSTAND THE RESULT =====
                    {
                        title: "Understand the Result",
                        description: "Excellent! VLOOKUP searched for ID '103' in column A and returned 'Alice Johnson' from column B. This is how data lookup works!",
                        instruction: "🧠 Notice how VLOOKUP found the exact match and returned the corresponding value from the second column",
                        type: "understanding",
                        highlightCells: ["D2", "E2", "A4", "B4"], // Highlight the lookup path
                        highlightType: "lookup",
                        check: () => {
                            // This step is completed when user acknowledges understanding
                            return true; // Will be manually completed via button
                        }
                    },
                    // ===== STEP 10: TRY DIFFERENT VALUES =====
                    {
                        title: "Try Different Lookup Values",
                        description: "Let's test your VLOOKUP with a different employee ID! We'll change D2 to '101' to see John Smith's information.",
                        instruction: "🔄 The system will automatically change D2 to '101' to demonstrate how VLOOKUP adapts to different lookup values",
                        target: "D2",
                        highlightCells: ["D2"],
                        highlightType: "lookup",
                        type: "understanding",
                        check: () => {
                            const d2 = document.querySelector('[data-address="D2"]');
                            const e2 = document.querySelector('[data-address="E2"]');
                            if (!d2 || !e2) return false;
                            
                            const searchValue = this.cellValues['D2'] || d2.textContent;
                            const result = this.cellValues['E2'] || e2.textContent;
                            const hasFormula = !!this.cellFormulas['E2'];
                            
                            // Check if they've tried "101" or any different value than the original '103'
                            return hasFormula && (searchValue === '101' || (searchValue !== '103' && this.employeeData[searchValue] === result));
                        }
                    },
                    // ===== STEP 11: TEST EDGE CASES =====
                    {
                        title: "Test Edge Cases",
                        description: "Let's see what happens when VLOOKUP can't find a match. Try entering an ID that doesn't exist in our data.",
                        instruction: "❌ Try changing D2 to '999' (a non-existent ID) to see VLOOKUP's error handling",
                        target: "D2",
                        highlightCells: ["D2", "E2"],
                        highlightType: "lookup",
                        type: "understanding", // Changed to understanding so it gets a button
                        check: () => {
                            const d2 = document.querySelector('[data-address="D2"]');
                            const e2 = document.querySelector('[data-address="E2"]');
                            if (!d2 || !e2) return false;
                            
                            const searchValue = this.cellValues['D2'] || d2.textContent;
                            const result = this.cellValues['E2'] || e2.textContent;
                            const hasFormula = !!this.cellFormulas['E2'];
                            
                            // Check if they've entered a non-existent ID and got #N/A
                            return hasFormula && !this.employeeData[searchValue] && result === '#N/A';
                        }
                    },
                    // ===== STEP 12: VLOOKUP MASTER =====
                    {
                        title: "🎉 VLOOKUP Master!",
                        description: "Congratulations! You've mastered VLOOKUP - one of Excel's most powerful functions. You can now build complex lookup formulas with confidence!",
                        instruction: "🏆 You've learned: formula syntax, table arrays, column indexes, exact matching, error handling, and practical applications!",
                        type: "completion",
                        check: () => {
                            // Final step is always complete once reached
                            return true;
                        }
                    }
                ];

                this.renderSteps();
            }

            startTraining() {
                this.currentStep = 0;
                this.updateActiveStep();
                
                // Initial scroll to top of training panel
                const stepsContainer = document.getElementById('stepsContainer');
                if (stepsContainer) {
                    stepsContainer.scrollTop = 0;
                }
                
                console.log('📚 Training started!');
            }

            renderSteps() {
                const container = document.getElementById('stepsContainer');
                container.innerHTML = '';

                this.trainingSteps.forEach((step, index) => {
                    const stepDiv = document.createElement('div');
                    stepDiv.className = 'step';
                    
                    // Set step state classes
                    if (index === this.currentStep) {
                        stepDiv.classList.add('active');
                    } else if (this.completedSteps.has(index)) {
                        stepDiv.classList.add('completed');
                    } else if (index > this.currentStep) {
                        stepDiv.classList.add('waiting');
                    }

                    let content = `
                        <div class="step-header">
                            <div class="step-number ${this.getStepNumberClass(index)}">${this.getStepNumberContent(index)}</div>
                            <div class="step-title">${step.title}</div>
                        </div>
                        <div class="step-description">${step.description}</div>
                    `;

                    // Add instruction for current step
                    if (index === this.currentStep) {
                        content += `<div class="step-instruction">${step.instruction}</div>`;
                    }

                    // Add action buttons based on step type
                    if (step.type === 'action' && (index === this.currentStep || index === 0)) {
                        content += `<button class="step-action" onclick="training.addSampleData()">Add Sample Data</button>`;
                    } else if (step.type === 'understanding' && (index === this.currentStep || this.completedSteps.has(index - 1) || index === 8 || index === 10)) {
                        // Show "I Understand" button for understanding steps (including step 9 and step 11)
                        content += `<button class="step-action" onclick="training.acknowledgeUnderstanding(${index})">I Understand!</button>`;
                    } else if (step.type === 'completion' && (index === this.currentStep || index === 11)) {
                        content += `<button class="step-action" onclick="training.completeMasterTraining()">Start Over</button>`;
                    }

                    content += `<div class="status-message" id="status${index}"></div>`;
                    stepDiv.innerHTML = content;

                    container.appendChild(stepDiv);
                });
            }

            getStepNumberClass(index) {
                if (this.completedSteps.has(index)) return 'completed';
                if (index === this.currentStep) return 'active';
                return '';
            }

            getStepNumberContent(index) {
                return this.completedSteps.has(index) ? '✓' : (index + 1);
            }

            updateActiveStep() {
                this.renderSteps();
                
                // Auto-scroll to active step in sidebar
                this.scrollToActiveStep();
                
                // Show instruction pointer and highlight cells for current step
                const currentStepData = this.trainingSteps[this.currentStep];
                if (currentStepData) {
                    // Show pointer for target cell
                    if (currentStepData.target) {
                        this.showInstructionPointer(currentStepData.target);
                    } else {
                        this.hideInstructionPointer();
                    }
                    
                    // Show visual highlights for what we're referencing
                    if (currentStepData.highlightCells) {
                        this.highlightCells(currentStepData.highlightCells, currentStepData.highlightType);
                    } else if (!currentStepData.target) {
                        // Only clear highlights if we're not showing a target pointer
                        this.clearAllHighlights();
                    }
                    
                    // Auto-demonstrate for Step 11 (Test Edge Cases)
                    if (this.currentStep === 10) { // Step 11 is index 10
                        setTimeout(() => {
                            this.demonstrateEdgeCase();
                        }, 1000);
                    }
                }
            }

            scrollToActiveStep() {
                const activeStep = document.querySelector('.step.active');
                const stepsContainer = document.getElementById('stepsContainer');
                
                if (activeStep && stepsContainer) {
                    // Calculate the position to scroll to
                    const stepRect = activeStep.getBoundingClientRect();
                    const containerRect = stepsContainer.getBoundingClientRect();
                    const stepOffsetTop = activeStep.offsetTop;
                    const containerHeight = stepsContainer.clientHeight;
                    const stepHeight = activeStep.offsetHeight;
                    
                    // Calculate scroll position to center the active step
                    const scrollPosition = stepOffsetTop - (containerHeight / 2) + (stepHeight / 2);
                    
                    // Smooth scroll to the active step
                    stepsContainer.scrollTo({
                        top: Math.max(0, scrollPosition),
                        behavior: 'smooth'
                    });
                }
            }

            showInstructionPointer(cellAddress) {
                const cell = document.querySelector(`[data-address="${cellAddress}"]`);
                if (!cell || !this.instructionPointer) return;

                const rect = cell.getBoundingClientRect();
                const containerRect = document.getElementById('excelContainer').getBoundingClientRect();
                
                // Position arrow to point directly at the center of the cell
                this.instructionPointer.style.left = (rect.left - containerRect.left + rect.width/2 - 18) + 'px';
                this.instructionPointer.style.top = (rect.top - containerRect.top - 35) + 'px';
                this.instructionPointer.style.display = 'block';
                
                // Highlight the target cell with green
                this.clearAllHighlights();
                cell.classList.add('highlighted');
                
                // Override the yellow highlight with green for the pointed cell
                cell.style.background = '#c8e6c9 !important';
                cell.style.borderColor = '#4CAF50 !important';
                cell.style.boxShadow = '0 0 15px rgba(76, 175, 80, 0.6) !important';
            }

            hideInstructionPointer() {
                if (this.instructionPointer) {
                    this.instructionPointer.style.display = 'none';
                }
                // Clear all highlights including any inline styles
                this.clearAllHighlights();
            }

            highlightCells(cellAddresses, highlightType = 'range') {
                // Clear previous highlights
                this.clearAllHighlights();
                
                // Apply new highlights
                cellAddresses.forEach(address => {
                    const cell = document.querySelector(`[data-address="${address}"]`);
                    if (cell) {
                        if (highlightType === 'lookup') {
                            cell.classList.add('lookup-highlighted');
                        } else {
                            cell.classList.add('range-highlighted');
                        }
                    }
                });
            }

            clearAllHighlights() {
                document.querySelectorAll('.excel-cell').forEach(cell => {
                    cell.classList.remove('highlighted', 'range-highlighted', 'lookup-highlighted');
                    // Clear any inline styles applied by the pointer
                    cell.style.background = '';
                    cell.style.borderColor = '';
                    cell.style.boxShadow = '';
                });
            }

            addSampleData() {
                console.log('📊 Adding sample data...');
                
                Object.keys(this.sampleData).forEach((address, index) => {
                    const cell = document.querySelector(`[data-address="${address}"]`);
                    if (cell) {
                        // Add with slight delay for animation effect
                        setTimeout(() => {
                            cell.textContent = this.sampleData[address];
                            this.cellValues[address] = this.sampleData[address];
                            
                            // Add temporary glow effect
                            cell.style.animation = 'resultGlow 0.6s ease-out';
                            setTimeout(() => {
                                cell.style.animation = '';
                            }, 600);
                        }, index * 50);
                    }
                });
                
                this.showStatusMessage(0, 'success', '✅ Sample data added! Now select cell E2.');
                setTimeout(() => this.checkProgress(), 800);
            }

            /**
             * ===== NEW STEP METHODS FOR EXTENDED TRAINING =====
             */
            acknowledgeUnderstanding(stepIndex) {
                console.log(`🔧 Acknowledging understanding for step ${stepIndex + 1}`);
                
                // Force complete all previous steps if not already completed
                for (let i = 0; i <= stepIndex; i++) {
                    if (!this.completedSteps.has(i)) {
                        this.completedSteps.add(i);
                        console.log(`🔧 Auto-completed step ${i + 1}`);
                    }
                }
                
                // Mark this step as completed
                this.completedSteps.add(stepIndex);
                
                if (stepIndex === 8) {
                    // Step 9 (index 8) - Understand the Result
                    this.showStatusMessage(stepIndex, 'success', '✅ Understanding confirmed! Now let\'s try a different lookup value.');
                    
                    // Progress to step 10 and automatically demonstrate
                    setTimeout(() => {
                        this.currentStep = stepIndex + 1;
                        this.updateProgress();
                        this.updateActiveStep();
                        
                        // Automatically demonstrate different value after a delay
                        setTimeout(() => this.demonstrateDifferentValue(), 1000);
                    }, 500);
                } else if (stepIndex === 9) {
                    // Step 10 (index 9) - Try Different Values  
                    this.showStatusMessage(stepIndex, 'success', '✅ Great! You see how VLOOKUP adapts to different lookup values.');
                    
                    setTimeout(() => {
                        this.currentStep = stepIndex + 1;
                        this.updateProgress();
                        this.updateActiveStep();
                    }, 500);
                } else if (stepIndex === 10) {
                    // Step 11 (index 10) - Test Edge Cases
                    this.showStatusMessage(stepIndex, 'success', '✅ Perfect! You\'ve seen how VLOOKUP handles errors.');
                    
                    setTimeout(() => {
                        this.currentStep = stepIndex + 1;
                        this.updateProgress();
                        this.updateActiveStep();
                    }, 500);
                } else {
                    // Other understanding steps
                    this.showStatusMessage(stepIndex, 'success', '✅ Understanding confirmed! Ready for next challenge.');
                    
                    setTimeout(() => {
                        this.currentStep = stepIndex + 1;
                        this.updateProgress();
                        this.updateActiveStep();
                    }, 500);
                }
            }

            demonstrateDifferentValue() {
                // Change D2 to "101" and update the result
                const d2Cell = document.querySelector('[data-address="D2"]');
                const e2Cell = document.querySelector('[data-address="E2"]');
                
                if (d2Cell && e2Cell) {
                    // Update D2 value
                    d2Cell.textContent = '101';
                    this.cellValues['D2'] = '101';
                    
                    // Update E2 with new result
                    const newResult = this.employeeData['101'];
                    e2Cell.textContent = newResult;
                    this.cellValues['E2'] = newResult;
                    
                    // Add visual feedback
                    d2Cell.style.background = '#e0f2fe';
                    d2Cell.style.border = '2px solid #1a73e8';
                    e2Cell.style.background = '#dcfce7';
                    
                    this.showStatusMessage(10, 'success', '✅ VLOOKUP automatically updated! D2 changed to "101" shows "John Smith".');
                    
                    // Mark step complete after demonstration
                    setTimeout(() => {
                        this.completedSteps.add(9);
                        this.checkProgress();
                    }, 1500);
                }
            }

            demonstrateEdgeCase() {
                console.log('🔴 Demonstrating edge case for Step 11...');
                
                // Change D2 to "999" and show #N/A error
                const d2Cell = document.querySelector('[data-address="D2"]');
                const e2Cell = document.querySelector('[data-address="E2"]');
                
                if (d2Cell && e2Cell) {
                    // Update D2 value to non-existent ID
                    d2Cell.textContent = '999';
                    this.cellValues['D2'] = '999';
                    
                    // Recalculate the formula with new lookup value
                    if (this.cellFormulas['E2']) {
                        const result = this.calculateFormula(this.cellFormulas['E2']);
                        e2Cell.textContent = result;
                        this.cellValues['E2'] = result;
                        
                        console.log('✅ Edge case result:', result);
                    }
                    
                    // Add visual feedback
                    d2Cell.style.background = '#fee2e2';
                    d2Cell.style.border = '2px solid #dc2626';
                    e2Cell.style.background = '#fee2e2';
                    e2Cell.style.color = '#dc2626';
                    e2Cell.style.fontWeight = 'bold';
                    
                    this.showStatusMessage(10, 'success', '✅ Demo complete! D2="999" shows #N/A error - this is how VLOOKUP handles missing data.');
                    
                    console.log('🎯 Step 11 demo completed. Current step:', this.currentStep + 1);
                }
            }

            completeMasterTraining() {
                // Reset to beginning
                this.currentStep = 0;
                this.completedSteps.clear();
                this.panelOpen = true;
                
                // Clear all cell data
                document.querySelectorAll('.excel-cell').forEach(cell => {
                    cell.textContent = '';
                    cell.classList.remove('has-formula', 'highlighted', 'range-highlighted', 'lookup-highlighted');
                    cell.style.removeProperty('background');
                    cell.style.removeProperty('border-color');
                });
                
                // Reset internal data
                this.cellFormulas = {};
                this.cellValues = {};
                
                this.updateProgress();
                this.updateActiveStep();
                
                console.log('🔄 Training restarted!');
            }

            // Method to manually advance steps for testing/debugging
            forceCompleteStep(stepIndex) {
                if (stepIndex < this.trainingSteps.length) {
                    this.completedSteps.add(stepIndex);
                    this.currentStep = Math.max(this.currentStep, stepIndex + 1);
                    this.updateProgress();
                    this.updateActiveStep();
                    console.log(`🔧 Manually completed step ${stepIndex + 1}`);
                }
            }

            // Method to complete multiple steps at once
            forceCompleteSteps(upToStep) {
                for (let i = 0; i <= upToStep && i < this.trainingSteps.length; i++) {
                    this.completedSteps.add(i);
                }
                this.currentStep = Math.min(upToStep + 1, this.trainingSteps.length);
                this.updateProgress();
                this.updateActiveStep();
                console.log(`🔧 Manually completed steps 1-${upToStep + 1}`);
            }

            // Test method for step 7 specifically
            testStep7Completion() {
                console.log('🧪 Testing Step 7 completion...');
                
                // Set up the scenario: complete steps 1-6 first
                this.forceCompleteSteps(5); // Complete steps 1-6 (indices 0-5)
                
                // Set up the formula in E2
                const e2 = document.querySelector('[data-address="E2"]');
                const d2 = document.querySelector('[data-address="D2"]');
                
                if (e2 && d2) {
                    // Make sure we have sample data
                    d2.textContent = '103';
                    this.cellValues['D2'] = '103';
                    
                    // Set the complete formula
                    e2.textContent = '=VLOOKUP(D2,A2:B6,2,FALSE)';
                    
                    // Don't execute it yet - just have the formula
                    console.log('📝 Formula set:', e2.textContent);
                    console.log('📊 Current step before check:', this.currentStep);
                    console.log('✅ Completed steps before check:', Array.from(this.completedSteps));
                    
                    // Now check if step 7 validation passes
                    setTimeout(() => {
                        this.checkProgress();
                        
                        console.log('📊 Current step after check:', this.currentStep);
                        console.log('✅ Completed steps after check:', Array.from(this.completedSteps));
                        
                        if (this.completedSteps.has(6)) {
                            console.log('🎉 Step 7 completed successfully!');
                        } else {
                            console.log('❌ Step 7 did not complete - debugging...');
                            
                            // Debug the validation
                            const stepData = this.trainingSteps[6];
                            if (stepData && stepData.check) {
                                const result = stepData.check();
                                console.log('🔍 Step 7 validation result:', result);
                            }
                        }
                        
                        this.updateActiveStep();
                    }, 100);
                }
            }

            // Quick method to get to step 9 "I Understand" for testing
            quickTestStep9() {
                console.log('🚀 Quick setup for Step 9 testing...');
                
                // Complete all steps up to 8 (Execute Formula)
                for (let i = 0; i < 8; i++) {
                    this.completedSteps.add(i);
                }
                
                // Set up the scenario with executed formula
                const e2 = document.querySelector('[data-address="E2"]');
                const d2 = document.querySelector('[data-address="D2"]');
                
                if (e2 && d2) {
                    // Set sample data
                    d2.textContent = '103';
                    this.cellValues['D2'] = '103';
                    
                    // Set executed result
                    e2.textContent = 'Alice Johnson';
                    this.cellValues['E2'] = 'Alice Johnson';
                    this.cellFormulas['E2'] = '=VLOOKUP(D2,A2:B6,2,FALSE)';
                    
                    // Set current step to 8 (Understand Result)
                    this.currentStep = 8;
                    this.updateProgress();
                    this.updateActiveStep();
                    
                    console.log('✅ Setup complete! You should now see Step 9 active with "I Understand" button enabled.');
                }
            }

            // Emergency fix - just show step 9 with working button
            enableStep9Button() {
                console.log('🆘 Emergency: Enabling Step 9 button...');
                
                // Force complete everything up to step 8
                for (let i = 0; i <= 7; i++) {
                    this.completedSteps.add(i);
                }
                
                // Set current step to 8 (step 9 in 1-based counting)
                this.currentStep = 8;
                
                // Force re-render
                this.updateProgress();
                this.updateActiveStep();
                
                console.log('✅ Step 9 should now be active with "I Understand" button!');
                console.log('Current step:', this.currentStep + 1);
                console.log('Completed steps:', Array.from(this.completedSteps));
            }

            // Quick method to test Step 11 directly
            enableStep11Button() {
                console.log('🆘 Emergency: Enabling Step 11 button...');
                
                // Force complete everything up to step 10
                for (let i = 0; i <= 9; i++) {
                    this.completedSteps.add(i);
                }
                
                // Set current step to 10 (step 11 in 1-based counting)
                this.currentStep = 10;
                
                // Set up sample data and formula first
                const d2Cell = document.querySelector('[data-address="D2"]');
                const e2Cell = document.querySelector('[data-address="E2"]');
                if (d2Cell && e2Cell) {
                    d2Cell.textContent = '103';
                    this.cellValues['D2'] = '103';
                    this.cellFormulas['E2'] = '=VLOOKUP(D2,A2:B6,2,FALSE)';
                    e2Cell.textContent = 'Alice Johnson';
                    this.cellValues['E2'] = 'Alice Johnson';
                }
                
                // Force re-render
                this.updateProgress();
                this.updateActiveStep();
                
                console.log('✅ Step 11 should now be active with demo and "I Understand" button!');
                console.log('Current step:', this.currentStep + 1);
                console.log('Completed steps:', Array.from(this.completedSteps));
            }

            /**
             * ===== STEP PROGRESS CHECKING =====
             * Critical method that validates current step completion and advances to next step
             * Includes race condition prevention to avoid skipping steps
             */
            checkProgress() {
                const currentStepData = this.trainingSteps[this.currentStep];
                if (!currentStepData) return; // No step to check

                // ===== RACE CONDITION PREVENTION =====
                // Prevent multiple simultaneous step progressions that could cause skipping
                if (this.isProgressingStep) {
                    console.log('Step progression already in progress, skipping...');
                    return;
                }

                // ===== STEP VALIDATION =====
                // Check the current step validation
                let stepPassed = false;
                try {
                    stepPassed = currentStepData.check();
                } catch (error) {
                    console.log('Step validation error:', error);
                    stepPassed = false;
                }

                // ===== SPECIAL HANDLING FOR FORMULA STEPS =====
                // If we're at a formula step and the user has a complete formula, auto-advance
                if (!stepPassed && this.currentStep >= 2 && this.currentStep <= 7) {
                    const e2 = document.querySelector('[data-address="E2"]');
                    const content = e2?.textContent?.toUpperCase() || '';
                    const storedFormula = this.cellFormulas['E2']?.toUpperCase() || '';
                    
                    // Check for complete formula
                    const hasCompleteFormula = (content.includes('=VLOOKUP(') && content.includes('D2') && 
                                              content.includes('A2:B6') && content.includes('2,') && 
                                              content.includes('FALSE)')) ||
                                             (storedFormula.includes('=VLOOKUP(') && storedFormula.includes('D2') && 
                                              storedFormula.includes('A2:B6') && storedFormula.includes('2,') && 
                                              storedFormula.includes('FALSE)'));
                    
                    if (hasCompleteFormula) {
                        // Auto-complete all formula steps (2-7)
                        console.log('🔧 Complete formula detected, auto-completing steps 3-7');
                        for (let i = 2; i <= 7; i++) {
                            if (!this.completedSteps.has(i)) {
                                this.completedSteps.add(i);
                            }
                        }
                        // Jump to step 8 (Execute)
                        this.currentStep = 7;
                        stepPassed = true;
                    }
                }

                if (stepPassed) {
                    // Lock step progression to prevent concurrent advances
                    this.isProgressingStep = true;
                    
                    // Mark current step as completed
                    this.completedSteps.add(this.currentStep);
                    this.showStatusMessage(this.currentStep, 'success', '✅ Perfect! Step completed.');
                    
                    console.log(`✅ Step ${this.currentStep + 1} completed!`);
                    
                    // Clear visual highlights when step completes
                    this.clearAllHighlights();
                    
                    // ===== ADVANCE TO NEXT STEP =====
                    // Brief pause allows user to see completion feedback before advancing
                    setTimeout(() => {
                        this.currentStep++; // Move to next step
                        this.updateProgress(); // Update progress bar and text
                        
                        if (this.currentStep < this.trainingSteps.length) {
                            // More steps remaining - activate next step
                            this.updateActiveStep();
                            this.showStatusMessage(this.currentStep, 'waiting', '👆 Follow the instruction above');
                        } else {
                            // All steps completed - finish training
                            this.completeTraining();
                        }
                        
                        // Unlock step progression for next advancement
                        this.isProgressingStep = false;
                    }, 1200); // 1.2 second delay for visual feedback
                }
            }

            completeTraining() {
                this.hideInstructionPointer();
                
                // Make sure step 8 shows as completed with green checkmark
                this.completedSteps.add(7); // Step 8 is index 7
                this.renderSteps(); // Re-render to show the checkmark
                
                this.showStatusMessage(7, 'success', '🎉 Congratulations! You are now a VLOOKUP master!');
                console.log('🎉 Training completed successfully!');
                
                // Update progress text
                document.getElementById('progressText').textContent = '🏆 VLOOKUP Master! Training Complete!';
                
                // Update progress bar to 100%
                document.getElementById('progressFill').style.width = '100%';
            }

            showStatusMessage(stepIndex, type, message) {
                const statusEl = document.getElementById(`status${stepIndex}`);
                if (statusEl) {
                    statusEl.className = `status-message ${type}`;
                    statusEl.textContent = message;
                    
                    // Auto-hide success messages after delay
                    if (type === 'success' && stepIndex < this.currentStep) {
                        setTimeout(() => {
                            statusEl.style.display = 'none';
                        }, 3000);
                    }
                }
            }

            updateProgress() {
                const progress = (this.completedSteps.size / this.trainingSteps.length) * 100;
                document.getElementById('progressFill').style.width = `${progress}%`;
                
                if (this.completedSteps.size >= this.trainingSteps.length) {
                    document.getElementById('progressText').textContent = '🏆 VLOOKUP Master! Training Complete!';
                } else {
                    const stepText = `Step ${this.currentStep + 1} of ${this.trainingSteps.length}`;
                    const progressText = `${Math.round(progress)}% Complete`;
                    document.getElementById('progressText').textContent = `${stepText} • ${progressText}`;
                }
            }

            /**
             * ===== TRAINING PANEL TOGGLE =====
             * Shows/hides the training panel and adjusts Excel container width
             */
            toggleTrainingPanel() {
                this.panelOpen = !this.panelOpen; // Toggle panel state
                
                // Get DOM elements
                const panel = document.getElementById('trainingPanel');
                const container = document.getElementById('excelContainer');
                const toggleBtn = document.getElementById('toggleBtn');

                if (this.panelOpen) {
                    // Show panel - slide in from right, shrink Excel area
                    panel.classList.add('active');
                    container.classList.add('panel-open');
                    toggleBtn.classList.add('panel-open');
                } else {
                    // Hide panel - slide out to right, expand Excel area
                    panel.classList.remove('active');
                    container.classList.remove('panel-open');
                    toggleBtn.classList.remove('panel-open');
                    this.hideInstructionPointer(); // Hide pointer when panel closes
                }
            }
        }

        // ===== APPLICATION INITIALIZATION =====
        // Global variable to hold training instance
        let training;
        
        // Start the training application when DOM is fully loaded
        document.addEventListener('DOMContentLoaded', () => {
            training = new VLookupTraining(); // Create and initialize the training system
        });
    </script>
</body>
</html>
