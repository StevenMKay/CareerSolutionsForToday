<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Email Signature Builder - Career Solutions for Today</title>
  <meta name="color-scheme" content="light dark" />
  <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/StevenMKay/CareerSolutionsForToday/24f41fc0ba84fa65c8b2fad5155b6b32c824486e/icons/CareerIcon.png">
  <style>
    /* ===== Base / Layout ===== */
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: 
        linear-gradient(135deg, rgba(11, 79, 108, 0.85) 0%, rgba(25, 118, 210, 0.75) 100%),
        url('https://raw.githubusercontent.com/StevenMKay/CareerSolutionsForToday/a7428db3a8f6cf75d7db276be55b3a4499f8b1c6/photos/Signature%20Builder%20Background.jpg');
      background-size: cover;
      background-attachment: fixed;
      background-position: center;
      min-height: 100vh; margin: 0; padding: 100px 20px 40px; color: #0f172a;
    }
    .container { max-width: 1400px; margin: 0 auto; }
    .header { text-align: center; margin-bottom: 32px; }
    .header h1 { 
      margin: 0 0 8px; 
      color: #ffffff; 
      font-size: 2.5rem; 
      font-weight: 700;
      text-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    .header p {
      color: rgba(255,255,255,0.95);
      font-size: 1.1rem;
      margin: 0;
      text-shadow: 0 1px 4px rgba(0,0,0,0.2);
    }
    .attribution {
      text-align: center;
      color: rgba(255,255,255,0.7);
      font-size: 0.75rem;
      margin-top: 30px;
      text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }
    .attribution a {
      color: rgba(255,255,255,0.9);
      text-decoration: none;
    }
    .attribution a:hover {
      text-decoration: underline;
    }

    .main-grid { 
      display: grid; 
      grid-template-columns: 1fr 1fr; 
      gap: 24px; 
      align-items: start; 
    }
    .card {
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 24px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2);
    }
    .card h2 { 
      display:flex; 
      align-items:center; 
      justify-content:space-between; 
      margin:0 0 18px; 
      font-size: 1.3rem; 
      color: #0b4f6c;
      font-weight: 600;
    }

    label { display:block; font-size:.95rem; margin: 8px 0 6px; font-weight: 500; color: #374151; }
    input[type="text"], input[type="email"], input[type="tel"], input[type="url"] {
      width: 100%; padding: 12px 14px; border: 2px solid #e5e7eb; border-radius: 8px;
      background: #ffffff; color:#111827;
      font-size: 0.95rem;
      transition: all 0.3s ease;
    }
    input::placeholder{ color:#9ca3af; }
    input:focus { 
      outline: none; 
      border-color: #0b4f6c; 
      box-shadow: 0 0 0 4px rgba(11, 79, 108, 0.1);
      transform: translateY(-1px);
    }

    .btn { 
      border:0; 
      border-radius:10px; 
      padding:10px 18px; 
      cursor:pointer; 
      display:inline-flex; 
      align-items:center; 
      gap:8px; 
      transition: all 0.3s ease;
      font-weight: 600;
      font-size: 0.95rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .btn-primary{ 
      background: linear-gradient(135deg, #0b4f6c 0%, #1976d2 100%); 
      color:#fff; 
    }
    .btn-primary:hover{ 
      background: linear-gradient(135deg, #1976d2 0%, #0b4f6c 100%); 
      transform: translateY(-2px); 
      box-shadow: 0 4px 12px rgba(11, 79, 108, 0.3);
    }
    .btn-success{ 
      background: linear-gradient(135deg, #10b981 0%, #059669 100%); 
      color:#fff; 
    }
    .btn-success:hover{ 
      background: linear-gradient(135deg, #059669 0%, #10b981 100%); 
      transform: translateY(-2px); 
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }
    .btn-ghost { 
      background:#e5e7eb; 
      color: #374151;
    }
    .btn-ghost:hover {
      background: #d1d5db;
      transform: translateY(-1px);
    }

    .form-row { display:grid; grid-template-columns: 1fr 2fr auto; gap:10px; align-items:end; }
    .btn-remove { background:#ef4444; color:#fff; width:36px; height:36px; border-radius:8px; display:flex; align-items:center; justify-content:center; }

    .upload-area { 
      border:2px dashed #d1d5db; 
      border-radius:12px; 
      padding:20px; 
      text-align:center; 
      cursor:pointer;
      transition: all 0.3s ease;
      background: #f9fafb;
    }
    .upload-area:hover {
      border-color: #0b4f6c;
      background: rgba(11, 79, 108, 0.05);
      transform: translateY(-2px);
    }
    .upload-area.has-image{ 
      border-color:#10b981; 
      background: rgba(16,185,129,.08); 
    }
    .image-preview { 
      max-width:120px; 
      max-height:120px; 
      border-radius:12px; 
      display:block; 
      margin:10px auto;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    /* Social inputs laid out clearly */
    .soc-row { display:grid; grid-template-columns: 28px 100px 1fr; align-items:center; gap:10px; margin:8px 0; }
    .social-icon { width:20px; height:20px; object-fit:contain; }
    
    /* Icon style selector */
    .icon-style-selector { margin: 12px 0; padding: 12px; background: #f8f9fa; border-radius: 8px; }
    .icon-style-selector label { display: inline-flex; align-items: center; gap: 8px; margin-right: 20px; cursor: pointer; font-size: 0.95rem; }
    .icon-style-selector input[type="radio"] { cursor: pointer; width: 18px; height: 18px; }
    .icon-style-selector input[type="checkbox"] { cursor: pointer; width: 18px; height: 18px; }
    
    /* Icon position styles */
    .social-bottom { display: flex; gap: 12px; margin-top: 12px; justify-content: flex-start; flex-wrap: wrap; }
    .social-bottom .social-item { width: 36px; height: 36px; display: inline-block; }
    
    /* Photo size control */
    .photo-size-control { margin-top: 12px; padding: 12px; background: #f8f9fa; border-radius: 8px; }
    .photo-size-control label { display: block; font-size: 0.9rem; margin-bottom: 8px; font-weight: 500; }
    .photo-size-slider { width: 100%; cursor: pointer; }
    
    /* Crop Modal */
    .crop-modal { 
      display: none; 
      position: fixed; 
      inset: 0; 
      background: rgba(0,0,0,0.9); 
      z-index: 9999; 
      align-items: center; 
      justify-content: center;
      backdrop-filter: blur(4px);
    }
    .crop-modal.active { display: flex; }
    .crop-container { 
      background: white; 
      border-radius: 20px; 
      padding: 30px; 
      max-width: 650px; 
      width: 95%; 
      max-height: 95vh; 
      overflow: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.4);
    }
    .crop-container h3 { 
      margin: 0 0 10px; 
      color: #0b4f6c;
      font-size: 1.5rem;
      font-weight: 600;
    }
    .crop-canvas-wrapper { 
      position: relative; 
      max-width: 550px; 
      margin: 0 auto 20px; 
      background: #1a1a1a; 
      border: 3px solid #0b4f6c; 
      border-radius: 12px; 
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }
    .crop-canvas { display: block; max-width: 100%; cursor: move; touch-action: none; }
    .crop-buttons { display: flex; gap: 12px; justify-content: center; margin-top: 20px; }
    .crop-preview { margin: 20px 0; text-align: center; }
    .crop-preview canvas { 
      max-width: 160px; 
      max-height: 160px; 
      border: 3px solid #e5e7eb; 
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .zoom-controls { 
      display: flex; 
      gap: 15px; 
      align-items: center; 
      margin: 20px 0;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 12px;
    }
    .zoom-slider-wrapper {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .zoom-slider {
      flex: 1;
      height: 6px;
      border-radius: 3px;
      background: #e5e7eb;
      outline: none;
      cursor: pointer;
      -webkit-appearance: none;
    }
    .zoom-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: linear-gradient(135deg, #0b4f6c, #1976d2);
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      transition: transform 0.2s ease;
    }
    .zoom-slider::-webkit-slider-thumb:hover {
      transform: scale(1.2);
    }
    .zoom-slider::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: linear-gradient(135deg, #0b4f6c, #1976d2);
      cursor: pointer;
      border: none;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    .zoom-label { 
      font-size: 0.9rem; 
      color: #374151;
      font-weight: 600;
      min-width: 50px;
    }
    .zoom-icon {
      color: #0b4f6c;
      font-size: 1.2rem;
    }

    /* ===== Signature preview ===== */
    .signature-preview { background: #ffffff; border-radius:10px; border:1px solid #e5e7eb; padding:18px; }
    .signature-layout { display:flex; gap:18px; align-items:center; min-height:140px; width:400px; }
    .signature-content { flex:1; max-width: 350px; }
    .signature-name { font-size: 1.8rem; font-weight: 700; margin: 0 0 2px; color:#111827; }
    .signature-title { font-size: 1.05rem; margin: 0 0 6px; color:#374151; }
    .signature-contact { font-size:.95rem; color:#374151; }
    .signature-contact a { color: inherit; text-decoration:none; }
    .signature-contact a:hover { color:#2563eb; }
    .signature-logo { height: 48px; margin: 0 0 8px; display:block; }
    .signature-photo { border-radius:8px; object-fit:cover; border:2px solid #e5e7eb; }

    .social-sidebar { display:flex; flex-direction:column; gap:8px; border-radius:8px; padding:8px; }
    .social-item { width:36px; height:36px; border-radius:6px; display:inline-block; text-decoration:none; line-height:0; font-size:0; }
    .social-item img { width:20px; height:20px; display:block; margin:8px auto 0; }
    
    /* Border styles (applied when showIconBorders is true) */
    .social-sidebar.with-borders { background:#f8fafb; border:1px solid #e5e7eb; }
    .social-item.with-border { background:#ffffff; border:1px solid #d1d5db; }

    /* ===== Dark mode (preview only) ===== */
    .dark body, .dark { background: #1a1a2e; color:#e5e7eb; }
    .dark .card { background: rgba(30,30,50,.9); border-color: rgba(255,255,255,.08); }
    .dark .signature-preview { background: #0b1220; border-color:#1f2937; }
    .dark .signature-name{ color:#f9fafb; }
    .dark .signature-title, .dark .signature-contact { color:#d1d5db; }
    .dark input[type="text"], .dark input[type="email"], .dark input[type="tel"], .dark input[type="url"]{ background:#111827; color:#f9fafb; border-color:#374151; }
    .dark .signature-photo{ border-color:#1f2937; }
    .dark .social-sidebar.with-borders{ background:#0f172a; border-color:#1f2937; }
    .dark .social-item.with-border { background:#1a1a2e; border-color:#374151; }
    .dark .icon-style-selector { background: #1f2937; }
    .dark .card h2 { color: #60a5fa; }
    .dark .photo-size-control { background: #1f2937; }

    /* ===== Mobile Responsiveness ===== */
    @media (max-width: 900px){ 
      .main-grid{ 
        grid-template-columns:1fr; 
      }
      body {
        padding: 80px 15px 30px;
      }
      .header h1 {
        font-size: 1.8rem;
      }
      .header p {
        font-size: 0.95rem;
      }
      .card {
        padding: 20px;
      }
      .card h2 {
        font-size: 1.15rem;
      }
    }
    
    @media (max-width: 600px) {
      body {
        padding: 70px 10px 20px;
      }
      .header h1 {
        font-size: 1.5rem;
      }
      .card {
        padding: 16px;
        border-radius: 12px;
      }
      .form-row {
        grid-template-columns: 1fr;
        gap: 8px;
      }
      .btn {
        width: 100%;
        justify-content: center;
      }
      .crop-container {
        padding: 20px;
        width: 98%;
      }
      .crop-container h3 {
        font-size: 1.2rem;
      }
      .zoom-controls {
        flex-direction: column;
        gap: 10px;
      }
      .zoom-slider-wrapper {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>‚úâÔ∏è Email Signature Builder</h1>
      <p>Create professional email signatures in minutes</p>
      <div style="margin-top:15px; display:flex; gap:15px; justify-content:center; flex-wrap:wrap;">
        <label style="display:inline-flex; align-items:center; gap:8px; cursor:pointer; color: rgba(255,255,255,0.95); font-size: 0.95rem;">
          <input type="checkbox" id="chkDark" style="width: 18px; height: 18px; cursor: pointer;" /> Dark mode (preview)
        </label>
        <label style="display:inline-flex; align-items:center; gap:8px; cursor:pointer; color: rgba(255,255,255,0.95); font-size: 0.95rem;">
          <input type="checkbox" id="chkMobile" style="width: 18px; height: 18px; cursor: pointer;" /> Mobile preview
        </label>
        <label style="display:inline-flex; align-items:center; gap:8px; cursor:pointer; color: rgba(255,255,255,0.95); font-size: 0.95rem;">
          <input type="checkbox" id="chkNoBorders" style="width: 18px; height: 18px; cursor: pointer;" /> Remove borders (signature)
        </label>
      </div>
    </div>

    <div class="main-grid">
      <div class="builder-panel">
        <div class="card">
          <h2>Text Information <button class="btn btn-primary" id="btnAddField">‚ûï Add Field</button></h2>
          <div id="textFields"></div>
        </div>

        <div class="card">
          <h2>Images</h2>
          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:16px;">
            <div>
              <label>Profile Photo</label>
              <div class="upload-area" id="uaProfile"><div id="profilePreview">üì∑<br/>Click to upload photo</div></div>
              <input type="file" id="profilePhoto" accept="image/*" hidden />
              <div class="photo-size-control" id="photoSizeControl" style="display:none;">
                <label>Photo Size: <span id="photoSizeValue">120</span>px</label>
                <input type="range" class="photo-size-slider" id="photoSizeSlider" min="80" max="200" value="120" step="10">
              </div>
            </div>
            <div>
              <label>Company Logo</label>
              <div class="upload-area" id="uaLogo"><div id="logoPreview">üè¢<br/>Click to upload logo</div></div>
              <input type="file" id="companyLogo" accept="image/*" hidden />
            </div>
          </div>
        </div>

        <div class="card">
          <h2>Social Media Links</h2>
          <div class="icon-style-selector">
            <div style="margin-bottom: 8px;">
              <strong>Icon Style:</strong>
              <label>
                <input type="radio" name="iconStyle" value="square" checked onchange="updateIconStyle(this.value)">
                Square Icons
              </label>
              <label>
                <input type="radio" name="iconStyle" value="circle" onchange="updateIconStyle(this.value)">
                Circular Icons
              </label>
            </div>
            <div style="margin-bottom: 8px;">
              <strong>Icon Position:</strong>
              <label>
                <input type="radio" name="iconPosition" value="side" checked onchange="updateIconPosition(this.value)">
                Side
              </label>
              <label>
                <input type="radio" name="iconPosition" value="bottom" onchange="updateIconPosition(this.value)">
                Bottom
              </label>
            </div>
            <div>
              <label>
                <input type="checkbox" id="chkIconBorders" onchange="updateIconBorders(this.checked)">
                Show icon borders
              </label>
            </div>
          </div>
          <div id="socialMediaFields"></div>
        </div>
      </div>

      <div class="preview-panel">
        <div class="card">
          <h2>Live Preview</h2>
          <div class="signature-preview"><div id="signaturePreview" class="signature-layout"></div></div>
          <div style="text-align:center; display:flex; gap:10px; justify-content:center; margin-top:10px; flex-wrap:wrap;">
            <button class="btn btn-success" id="btnCopySig">üìã Copy Signature</button>
            <button class="btn btn-primary" id="btnCopyHTML">üîó Copy HTML Code</button>
          </div>
        </div>
      </div>
    </div>
    
    <div class="attribution">
      Background photo by <a href="https://unsplash.com/@signaturepro" target="_blank" rel="noopener">Signature Pro</a> on Unsplash
    </div>
  </div>

  <!-- Tiny toast -->
  <div id="toast" style="position:fixed; right:20px; top:20px; background:#10b981; color:#fff; padding:10px 14px; border-radius:8px; opacity:0; transform:translateY(-10px); transition:all .25s;">copied</div>

  <!-- Crop Modal -->
  <div id="cropModal" class="crop-modal">
    <div class="crop-container">
      <h3>‚úÇÔ∏è Crop & Adjust Image</h3>
      <p style="font-size: 0.9rem; color: #666; margin: 0 0 15px; line-height: 1.5;">
        <strong>üí° Tips:</strong> Drag to reposition ‚Ä¢ Hover edges to resize ‚Ä¢ Use slider to zoom
      </p>
      <div class="crop-canvas-wrapper" id="cropCanvasWrapper">
        <canvas id="cropCanvas" class="crop-canvas"></canvas>
      </div>
      <div class="zoom-controls">
        <span class="zoom-icon">üîç</span>
        <div class="zoom-slider-wrapper">
          <span class="zoom-label">Zoom</span>
          <input type="range" class="zoom-slider" id="zoomSlider" min="50" max="100" value="80" step="1">
        </div>
      </div>
      <div class="crop-preview">
        <label style="font-size: 1rem; font-weight: 600; display: block; margin-bottom: 10px; color: #0b4f6c;">Preview:</label>
        <canvas id="cropPreviewCanvas"></canvas>
      </div>
      <div class="crop-buttons">
        <button class="btn btn-ghost" onclick="cancelCrop()">‚úï Cancel</button>
        <button class="btn btn-success" onclick="applyCrop()">‚úì Apply Crop</button>
      </div>
    </div>
  </div>

  <script>
    // ===== State =====
    let textFields = [
      { id: '1', label: 'Full Name', value: 'John Doe', type: 'text' },
      { id: '2', label: 'Job Title', value: 'Senior Developer', type: 'text' },
      { id: '3', label: 'Phone', value: '+1 (555) 123-4567', type: 'tel' },
      { id: '4', label: 'Email', value: 'john.doe@techcorp.com', type: 'email' }
    ];

    let iconStyle = 'square'; // default to square icons
    
    const socialIconsSquare = {
      instagram: 'Signature Icons/Instagram Icon Square.png',
      facebook : 'Signature Icons/Facebook Icon Square.png',
      linkedin : 'Signature Icons/LinkedIn Icon Square.png',
      website  : 'Signature Icons/Website Icon Square.png',
      youtube  : 'Signature Icons/YouTube Icon Square.png',
      github   : 'Signature Icons/GitHub Icon Square.png',
      tiktok   : 'Signature Icons/TikTok Icon Square.png'
    };
    
    const socialIconsCircle = {
      instagram: 'Signature Icons/Instagram Icon Circle.png',
      facebook : 'Signature Icons/Facebook Icon Circle.png',
      linkedin : 'Signature Icons/LinkedIn Icon Circle.png',
      website  : 'Signature Icons/Website Icon Circle.png',
      youtube  : 'Signature Icons/YouTube Icon Circle.png',
      github   : 'Signature Icons/GitHub Icon Circle.png',
      tiktok   : 'Signature Icons/TikTok Icon Circle.png'
    };
    
    function getSocialIcons() {
      return iconStyle === 'circle' ? socialIconsCircle : socialIconsSquare;
    }

    let socialLinks = { instagram:'', facebook:'', linkedin:'', website:'', youtube:'', github:'', tiktok:'' };
    let images = { profile:null, logo:null };
    let photoSize = 120; // default photo size in pixels
    let iconPosition = 'side'; // 'side' or 'bottom'
    let showIconBorders = false; // default to no borders

    let removeBorders = false; // checkbox controls this
    
    function updateIconStyle(style) {
      iconStyle = style;
      renderSocialFields();
      updatePreview();
    }
    
    function updatePhotoSize(size) {
      photoSize = parseInt(size);
      $('#photoSizeValue').textContent = photoSize;
      updatePreview();
    }
    
    function updateIconPosition(position) {
      iconPosition = position;
      updatePreview();
    }
    
    function updateIconBorders(show) {
      showIconBorders = show;
      updatePreview();
    }

    // ===== Helpers =====
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    function toast(msg){ const t=$('#toast'); t.textContent=msg; t.style.opacity='1'; t.style.transform='translateY(0)'; setTimeout(()=>{t.style.opacity='0'; t.style.transform='translateY(-10px)';}, 2200); }

    // ===== UI builders =====
    function renderTextFields(){
      const c = $('#textFields');
      c.innerHTML = textFields.map(f => `
        <div class="form-row">
          <div><label>Field Name</label><input type="text" value="${f.label}" onchange="updateTextField('${f.id}','label',this.value)"></div>
          <div><label>Value</label><input type="${f.type}" value="${f.value}" onchange="updateTextField('${f.id}','value',this.value)"></div>
          <button class="btn btn-remove" onclick="removeTextField('${f.id}')">‚úñ</button>
        </div>`).join('');
    }
    function updateTextField(id, key, val){ const i=textFields.findIndex(x=>x.id===id); if(i>-1){ textFields[i][key]=val; updatePreview(); } }
    function removeTextField(id){ if(textFields.length>1){ textFields = textFields.filter(x=>x.id!==id); updatePreview(); renderTextFields(); } }

    function renderSocialFields(){
      const list = [
        {key:'instagram', name:'Instagram', ph:'https://instagram.com/username'},
        {key:'facebook' , name:'Facebook' , ph:'https://facebook.com/username'},
        {key:'linkedin' , name:'LinkedIn' , ph:'https://linkedin.com/in/username'},
        {key:'website'  , name:'Website'  , ph:'https://yourwebsite.com'},
        {key:'youtube'  , name:'YouTube'  , ph:'https://youtube.com/@username'},
        {key:'github'   , name:'GitHub'   , ph:'https://github.com/username'},
        {key:'tiktok'   , name:'TikTok'   , ph:'https://tiktok.com/@username'}
      ];
      const c = $('#socialMediaFields');
      const icons = getSocialIcons();
      c.innerHTML = list.map(p=>`
        <div class="soc-row">
          <img class="social-icon" src="${icons[p.key]}" alt="" />
          <div style="font-size:.9rem; color:#374151;">${p.name}</div>
          <input type="url" placeholder="${p.ph}" value="${socialLinks[p.key]}" oninput="socialLinks['${p.key}']=this.value; updatePreview();" />
        </div>`).join('');
    }

    // ===== Crop Modal State =====
    let cropState = {
      image: null,
      canvas: null,
      ctx: null,
      cropX: 0,
      cropY: 0,
      cropSize: 0,
      scale: 1,
      isDragging: false,
      isResizing: false,
      resizeEdge: null,
      dragStartX: 0,
      dragStartY: 0,
      currentKey: null,
      previewId: null,
      boxId: null,
      minSize: 50,
      maxSize: 0
    };

    // ===== Image uploads (with interactive cropping) =====
    function wireUpload(boxId, inputId, previewId, imagesKey){
      $(boxId).addEventListener('click', ()=> $(inputId).click());
      $(inputId).addEventListener('change', e=>{
        const f=e.target.files[0]; if(!f) return; const reader=new FileReader();
        reader.onload=ev=>{ 
          const img = new Image();
          img.onload = function() {
            openCropModal(img, imagesKey, previewId, boxId);
          };
          img.src = ev.target.result;
        };
        reader.readAsDataURL(f);
      });
    }
    
    function openCropModal(img, imagesKey, previewId, boxId) {
      cropState.image = img;
      cropState.currentKey = imagesKey;
      cropState.previewId = previewId;
      cropState.boxId = boxId;
      
      const modal = $('#cropModal');
      const canvas = $('#cropCanvas');
      const ctx = canvas.getContext('2d');
      
      // Calculate canvas size to fit image
      const maxSize = 500;
      let canvasWidth = img.width;
      let canvasHeight = img.height;
      
      if (canvasWidth > maxSize || canvasHeight > maxSize) {
        const scale = Math.min(maxSize / canvasWidth, maxSize / canvasHeight);
        canvasWidth *= scale;
        canvasHeight *= scale;
        cropState.scale = scale;
      } else {
        cropState.scale = 1;
      }
      
      canvas.width = canvasWidth;
      canvas.height = canvasHeight;
      ctx.drawImage(img, 0, 0, canvasWidth, canvasHeight);
      
      // Initialize crop area (centered square)
      const cropSize = Math.min(canvasWidth, canvasHeight) * 0.8;
      cropState.cropX = (canvasWidth - cropSize) / 2;
      cropState.cropY = (canvasHeight - cropSize) / 2;
      cropState.cropSize = cropSize;
      cropState.maxSize = Math.min(canvasWidth, canvasHeight);
      
      // Set slider initial value
      const slider = $('#zoomSlider');
      slider.min = 50;
      slider.max = 100;
      slider.value = 80;
      
      // Show modal and draw initial crop
      modal.classList.add('active');
      drawCropOverlay();
      updateCropPreview();
      
      // Add mouse events
      canvas.onmousedown = handleMouseDown;
      canvas.onmousemove = handleMouseMove;
      canvas.onmouseup = handleMouseUp;
      canvas.onmouseleave = handleMouseUp;
      
      // Add touch events for mobile
      canvas.ontouchstart = handleTouchStart;
      canvas.ontouchmove = handleTouchMove;
      canvas.ontouchend = handleMouseUp;
      
      // Add scroll zoom
      canvas.onwheel = (e) => {
        e.preventDefault();
        const delta = e.deltaY > 0 ? -2 : 2;
        const currentPercent = (cropState.cropSize / cropState.maxSize) * 100;
        const newPercent = Math.max(50, Math.min(100, currentPercent + delta));
        slider.value = newPercent;
        handleZoomSlider({ target: slider });
      };
      
      // Add slider event
      slider.oninput = handleZoomSlider;
    }
    
    function handleZoomSlider(e) {
      const percent = parseFloat(e.target.value);
      const newSize = (percent / 100) * cropState.maxSize;
      
      // Adjust position to keep crop centered
      const centerX = cropState.cropX + cropState.cropSize / 2;
      const centerY = cropState.cropY + cropState.cropSize / 2;
      
      cropState.cropSize = newSize;
      
      const canvas = $('#cropCanvas');
      cropState.cropX = Math.max(0, Math.min(centerX - newSize / 2, canvas.width - newSize));
      cropState.cropY = Math.max(0, Math.min(centerY - newSize / 2, canvas.height - newSize));
      
      drawCropOverlay();
      updateCropPreview();
    }
    
    function updateSliderFromCropSize() {
      const percent = (cropState.cropSize / cropState.maxSize) * 100;
      $('#zoomSlider').value = percent;
    }
    
    function drawCropOverlay() {
      const canvas = $('#cropCanvas');
      const ctx = canvas.getContext('2d');
      
      // Redraw image
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(cropState.image, 0, 0, canvas.width, canvas.height);
      
      // Draw dimmed overlay
      ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      // Clear crop area
      ctx.clearRect(cropState.cropX, cropState.cropY, cropState.cropSize, cropState.cropSize);
      ctx.drawImage(
        cropState.image,
        cropState.cropX / cropState.scale, cropState.cropY / cropState.scale,
        cropState.cropSize / cropState.scale, cropState.cropSize / cropState.scale,
        cropState.cropX, cropState.cropY, cropState.cropSize, cropState.cropSize
      );
      
      // Draw crop border
      ctx.strokeStyle = '#0b4f6c';
      ctx.lineWidth = 2;
      ctx.setLineDash([5, 5]);
      ctx.strokeRect(cropState.cropX, cropState.cropY, cropState.cropSize, cropState.cropSize);
      ctx.setLineDash([]);
    }
    
    function updateCropPreview() {
      const previewCanvas = $('#cropPreviewCanvas');
      const previewSize = 150;
      previewCanvas.width = previewSize;
      previewCanvas.height = previewSize;
      const previewCtx = previewCanvas.getContext('2d');
      
      previewCtx.drawImage(
        cropState.image,
        cropState.cropX / cropState.scale, cropState.cropY / cropState.scale,
        cropState.cropSize / cropState.scale, cropState.cropSize / cropState.scale,
        0, 0, previewSize, previewSize
      );
    }
    
    function getEdgeAt(x, y) {
      const threshold = 10;
      const left = cropState.cropX;
      const right = cropState.cropX + cropState.cropSize;
      const top = cropState.cropY;
      const bottom = cropState.cropY + cropState.cropSize;
      
      if (Math.abs(x - left) < threshold && y >= top && y <= bottom) return 'left';
      if (Math.abs(x - right) < threshold && y >= top && y <= bottom) return 'right';
      if (Math.abs(y - top) < threshold && x >= left && x <= right) return 'top';
      if (Math.abs(y - bottom) < threshold && x >= left && x <= right) return 'bottom';
      
      return null;
    }
    
    function handleMouseDown(e) {
      const rect = $('#cropCanvas').getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      
      const edge = getEdgeAt(x, y);
      
      if (edge) {
        cropState.isResizing = true;
        cropState.resizeEdge = edge;
        cropState.dragStartX = x;
        cropState.dragStartY = y;
      } else if (x >= cropState.cropX && x <= cropState.cropX + cropState.cropSize &&
                 y >= cropState.cropY && y <= cropState.cropY + cropState.cropSize) {
        cropState.isDragging = true;
        cropState.dragStartX = x - cropState.cropX;
        cropState.dragStartY = y - cropState.cropY;
      }
    }
    
    function handleMouseMove(e) {
      const rect = $('#cropCanvas').getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      const canvas = $('#cropCanvas');
      
      if (cropState.isResizing) {
        const deltaX = x - cropState.dragStartX;
        const deltaY = y - cropState.dragStartY;
        
        if (cropState.resizeEdge === 'left') {
          const newX = cropState.cropX + deltaX;
          const newSize = cropState.cropSize - deltaX;
          if (newX >= 0 && newSize >= cropState.minSize && newSize <= cropState.maxSize) {
            cropState.cropX = newX;
            cropState.cropSize = newSize;
            cropState.dragStartX = x;
          }
        } else if (cropState.resizeEdge === 'right') {
          const newSize = cropState.cropSize + deltaX;
          if (cropState.cropX + newSize <= canvas.width && newSize >= cropState.minSize && newSize <= cropState.maxSize) {
            cropState.cropSize = newSize;
            cropState.dragStartX = x;
          }
        } else if (cropState.resizeEdge === 'top') {
          const newY = cropState.cropY + deltaY;
          const newSize = cropState.cropSize - deltaY;
          if (newY >= 0 && newSize >= cropState.minSize && newSize <= cropState.maxSize) {
            cropState.cropY = newY;
            cropState.cropSize = newSize;
            cropState.dragStartY = y;
          }
        } else if (cropState.resizeEdge === 'bottom') {
          const newSize = cropState.cropSize + deltaY;
          if (cropState.cropY + newSize <= canvas.height && newSize >= cropState.minSize && newSize <= cropState.maxSize) {
            cropState.cropSize = newSize;
            cropState.dragStartY = y;
          }
        }
        
        updateSliderFromCropSize();
        drawCropOverlay();
        updateCropPreview();
      } else if (cropState.isDragging) {
        let newX = x - cropState.dragStartX;
        let newY = y - cropState.dragStartY;
        
        newX = Math.max(0, Math.min(newX, canvas.width - cropState.cropSize));
        newY = Math.max(0, Math.min(newY, canvas.height - cropState.cropSize));
        
        cropState.cropX = newX;
        cropState.cropY = newY;
        
        drawCropOverlay();
        updateCropPreview();
      } else {
        // Update cursor based on edge proximity
        const edge = getEdgeAt(x, y);
        if (edge === 'left' || edge === 'right') {
          canvas.style.cursor = 'ew-resize';
        } else if (edge === 'top' || edge === 'bottom') {
          canvas.style.cursor = 'ns-resize';
        } else if (x >= cropState.cropX && x <= cropState.cropX + cropState.cropSize &&
                   y >= cropState.cropY && y <= cropState.cropY + cropState.cropSize) {
          canvas.style.cursor = 'move';
        } else {
          canvas.style.cursor = 'default';
        }
      }
    }
    
    function handleMouseUp() {
      cropState.isDragging = false;
      cropState.isResizing = false;
      cropState.resizeEdge = null;
    }
    
    function handleTouchStart(e) {
      e.preventDefault();
      const touch = e.touches[0];
      const rect = $('#cropCanvas').getBoundingClientRect();
      const x = touch.clientX - rect.left;
      const y = touch.clientY - rect.top;
      
      handleMouseDown({ clientX: touch.clientX, clientY: touch.clientY });
    }
    
    function handleTouchMove(e) {
      e.preventDefault();
      const touch = e.touches[0];
      handleMouseMove({ clientX: touch.clientX, clientY: touch.clientY });
    }
    
    function applyCrop() {
      const outputCanvas = document.createElement('canvas');
      const outputSize = 800; // High quality output
      outputCanvas.width = outputSize;
      outputCanvas.height = outputSize;
      const outputCtx = outputCanvas.getContext('2d', { alpha: true });
      
      // Draw cropped area with transparency support
      outputCtx.drawImage(
        cropState.image,
        cropState.cropX / cropState.scale, cropState.cropY / cropState.scale,
        cropState.cropSize / cropState.scale, cropState.cropSize / cropState.scale,
        0, 0, outputSize, outputSize
      );
      
      // Convert to PNG to preserve transparency
      images[cropState.currentKey] = outputCanvas.toDataURL('image/png', 1.0);
      $(cropState.previewId).innerHTML = `<img src="${images[cropState.currentKey]}" class="image-preview" alt=""/>`;
      $(cropState.boxId).classList.add('has-image');
      
      // Show photo size control for profile photo
      if(cropState.currentKey === 'profile') {
        $('#photoSizeControl').style.display = 'block';
      }
      
      updatePreview();
      closeCropModal();
    }
    
    function cancelCrop() {
      closeCropModal();
    }
    
    function closeCropModal() {
      $('#cropModal').classList.remove('active');
      cropState = { 
        image: null, canvas: null, ctx: null, cropX: 0, cropY: 0, cropSize: 0, scale: 1, 
        isDragging: false, isResizing: false, resizeEdge: null, dragStartX: 0, dragStartY: 0, 
        currentKey: null, previewId: null, boxId: null, minSize: 50, maxSize: 0 
      };
    }

    // ===== Preview =====
    function updatePreview(){
      const wrap = $('#signaturePreview');
      const activeSocial = Object.entries(socialLinks).filter(([,u])=>u && u.trim());

      const borderColor = removeBorders ? 'transparent' : '#e5e7eb';
      const icons = getSocialIcons();
      
      // Border classes and styles
      const sidebarClass = showIconBorders ? 'social-sidebar with-borders' : 'social-sidebar';
      const itemClass = showIconBorders ? 'social-item with-border' : 'social-item';
      const itemStyle = showIconBorders ? 'background:#ffffff; border:1px solid #d1d5db;' : 'background:transparent; border:none;';
      const sidebarStyle = showIconBorders ? 'background:#f8fafb; border:1px solid #e5e7eb;' : 'background:transparent; border:none;';

      let socialHTML = '';
      let socialBottomHTML = '';
      
      if(activeSocial.length){
        if(iconPosition === 'side') {
          socialHTML = `<div class="${sidebarClass}" style="${sidebarStyle}">`
            + activeSocial.map(([p,u])=>`
               <a href="${u}" class="${itemClass}" target="_blank" rel="noopener noreferrer" title="${p}" style="${itemStyle}">
                 <img src="${icons[p]}" alt="" role="presentation" aria-hidden="true" />
               </a>`).join('') + `</div>`;
        } else {
          socialBottomHTML = `<div class="social-bottom">`
            + activeSocial.map(([p,u])=>`
               <a href="${u}" class="${itemClass}" target="_blank" rel="noopener noreferrer" title="${p}" style="${itemStyle}">
                 <img src="${icons[p]}" alt="" role="presentation" aria-hidden="true" />
               </a>`).join('') + `</div>`;
        }
      }

      let content = `<div class="signature-content">`;
      if(images.logo){ content += `<img src="${images.logo}" class="signature-logo" alt="" />`; }

      textFields.forEach(f=>{
        if(!f.value.trim()) return;
        const l = f.label.toLowerCase();
        const isName = l.includes('name');
        const isTitle = l.includes('title') || l.includes('position');
        const isEmail = f.type==='email' || l.includes('email');
        const isPhone = f.type==='tel' || l.includes('phone');
        if(isName) content += `<div class="signature-name">${f.value}</div>`;
        else if(isTitle) content += `<div class="signature-title">${f.value}</div>`;
        else if(isPhone) content += `<div class="signature-contact"><a href="tel:${f.value}">${f.value}</a></div>`;
        else if(isEmail) content += `<div class="signature-contact"><a href="mailto:${f.value}">${f.value}</a></div>`;
        else content += `<div class="signature-contact"><strong>${f.label}:</strong> ${f.value}</div>`;
      });
      // Add social icons at bottom if that position is selected
      if(socialBottomHTML) {
        content += socialBottomHTML;
      }
      content += `</div>`;

      const photo = images.profile ? `<img src="${images.profile}" class="signature-photo" alt="" style="width:${photoSize}px; height:${photoSize}px; border-color:${borderColor};"/>` : '';
      
      if(iconPosition === 'bottom') {
        wrap.innerHTML = content + photo;
      } else {
        wrap.innerHTML = socialHTML + content + photo;
      }
    }

    // ===== Copy functions (robust, email-safe) =====
    function buildTables(forHtml){
      const activeSocial = Object.entries(socialLinks).filter(([,u])=>u && u.trim());
      const borderColor = removeBorders ? 'transparent' : '#dee2e6';
      const icons = getSocialIcons();
      
      // Border styles based on showIconBorders
      const sidebarBg = showIconBorders ? '#f8f9fa' : 'transparent';
      const sidebarBorder = showIconBorders ? `1px solid ${borderColor}` : 'none';
      const itemBg = showIconBorders ? '#ffffff' : 'transparent';
      const itemBorder = showIconBorders ? `1px solid ${borderColor}` : 'none';

      // Social column for SIDE position (font-size:0 hides any fallback text if icons are blocked)
      let socialCol = '';
      if(activeSocial.length && iconPosition === 'side'){
        socialCol = `
          <td style=\"vertical-align:middle; padding-right:15px; width:60px; font-size:0; line-height:0;\">
            <table cellpadding=\"0\" cellspacing=\"0\" border=\"0\" style=\"background:${sidebarBg}; border:${sidebarBorder}; border-collapse:collapse;\">
              ${activeSocial.map(([p,u])=>`
                <tr>
                  <td style=\"padding:3px 0; text-align:center; font-size:0; line-height:0;\">
                    <a href=\"${u}\" target=\"_blank\" rel=\"noopener\" style=\"display:inline-block; width:32px; height:32px; background:${itemBg}; border:${itemBorder}; border-radius:4px; text-decoration:none; line-height:0; font-size:0;\">
                      <img src=\"${icons[p]}\" alt=\"\" border=\"0\" role=\"presentation\" aria-hidden=\"true\" style=\"width:18px; height:18px; display:block; margin:7px auto 0;\" />
                    </a>
                  </td>
                </tr>`).join('')}
            </table>
          </td>`;
      }
      
      // Social row for BOTTOM position
      let socialBottomRow = '';
      if(activeSocial.length && iconPosition === 'bottom'){
        socialBottomRow = `<tr><td style=\"padding-top:12px; font-size:0; line-height:0;\">`
          + activeSocial.map(([p,u])=>`
            <a href=\"${u}\" target=\"_blank\" rel=\"noopener\" style=\"display:inline-block; width:32px; height:32px; background:${itemBg}; border:${itemBorder}; border-radius:4px; text-decoration:none; line-height:0; font-size:0; margin-right:8px;\">
              <img src=\"${icons[p]}\" alt=\"\" border=\"0\" role=\"presentation\" aria-hidden=\"true\" style=\"width:18px; height:18px; display:block; margin:7px auto 0;\" />
            </a>`).join('')
          + `</td></tr>`;
      }

      // Main content
      let content = '';
      if(images.logo){ content += `<tr><td style=\"padding-bottom:10px;\"><img src=\"${images.logo}\" alt=\"\" border=\"0\" style=\"height:50px; display:block; max-width:200px;\"></td></tr>`; }
      textFields.forEach(f=>{
        if(!f.value.trim()) return; const l=f.label.toLowerCase();
        const isName=l.includes('name'); const isTitle=l.includes('title')||l.includes('position'); const isEmail=f.type==='email'||l.includes('email'); const isPhone=f.type==='tel'||l.includes('phone');
        if(isName) content += `<tr><td style=\"font-family:Arial, sans-serif; font-size:24px; font-weight:bold; color:#000000; padding-bottom:2px; line-height:1.2;\">${f.value}</td></tr>`;
        else if(isTitle) content += `<tr><td style=\"font-family:Arial, sans-serif; font-size:16px; color:#333333; padding-bottom:4px; line-height:1.2;\">${f.value}</td></tr>`;
        else if(isPhone) content += `<tr><td style=\"font-family:Arial, sans-serif; font-size:14px; color:#333333; padding-bottom:2px; line-height:1.3;\"><a href=\"tel:${f.value}\" style=\"color:#333333; text-decoration:none;\">${f.value}</a></td></tr>`;
        else if(isEmail) content += `<tr><td style=\"font-family:Arial, sans-serif; font-size:14px; color:#333333; padding-bottom:2px; line-height:1.3;\"><a href=\"mailto:${f.value}\" style=\"color:#333333; text-decoration:none;\">${f.value}</a></td></tr>`;
        else content += `<tr><td style=\"font-family:Arial, sans-serif; font-size:12px; color:#333333; padding-bottom:1px;\"><strong>${f.label}:</strong> ${f.value}</td></tr>`;
      });
      
      // Add social icons at bottom if that position is selected
      content += socialBottomRow;

      const photo = images.profile ? `<td style=\"vertical-align:middle; text-align:center; width:${photoSize + 20}px;\"><img src=\"${images.profile}\" alt=\"\" border=\"0\" style=\"width:${photoSize}px; height:${photoSize}px; border-radius:6px; border:2px solid ${borderColor}; display:block;\"></td>` : '';

      // Calculate dynamic widths based on photo size and icon position
      const totalWidth = 550;
      const socialWidth = (activeSocial.length && iconPosition === 'side') ? 60 : 0;
      const photoWidth = images.profile ? photoSize + 20 : 0;
      const contentWidth = totalWidth - socialWidth - photoWidth - 30; // 30px for padding

      const table = `
        <!--[if mso]><table role=\"presentation\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\" width=\"${totalWidth}\"><tr><td><![endif]-->
        <table cellpadding=\"0\" cellspacing=\"0\" border=\"0\" width=\"${totalWidth}\" style=\"width:${totalWidth}px; font-family:Arial, sans-serif; font-size:14px; line-height:1.4; border-collapse:collapse; mso-table-lspace:0pt; mso-table-rspace:0pt; table-layout:auto;\">
          <tr>
            ${socialCol}
            <td style=\"vertical-align:middle; padding-right:15px; width:${contentWidth}px;\">
              <table cellpadding=\"0\" cellspacing=\"0\" border=\"0\" width=\"100%\" style=\"border-collapse:collapse; mso-table-lspace:0pt; mso-table-rspace:0pt;\">${content}</table>
            </td>
            ${photo}
          </tr>
        </table>
        <!--[if mso]></td></tr></table><![endif]-->`;

      return table.trim();
    }

    function copySignature(){
      const html = buildTables(true);
      if (window.ClipboardItem && navigator.clipboard && navigator.clipboard.write) {
        const blob = new Blob([html], { type: 'text/html' });
        const item = new ClipboardItem({ 'text/html': blob, 'text/plain': new Blob([html], {type:'text/plain'}) });
        navigator.clipboard.write([item]).then(()=>toast('Signature copied (HTML). Paste into Outlook signature.'))
        .catch(()=>fallbackCopy(html));
      } else { fallbackCopy(html); }
    }
    function fallbackCopy(html){
      const temp = document.createElement('div');
      temp.contentEditable = 'true';
      temp.style.position='fixed'; temp.style.opacity='0'; temp.innerHTML = html;
      document.body.appendChild(temp);
      const r = document.createRange(); r.selectNodeContents(temp); const s = window.getSelection(); s.removeAllRanges(); s.addRange(r);
      document.execCommand('copy');
      s.removeAllRanges(); document.body.removeChild(temp);
      toast('Signature copied!');
    }{
      const temp = document.createElement('div');
      temp.innerHTML = buildTables(false);
      document.body.appendChild(temp);
      const r = document.createRange(); r.selectNode(temp); const s = window.getSelection(); s.removeAllRanges(); s.addRange(r);
      document.execCommand('copy');
      s.removeAllRanges(); document.body.removeChild(temp);
      toast('Signature copied! Paste into Outlook signature.');
    }

    function copyHTML(){
      const html = buildTables(true);
      navigator.clipboard.writeText(html).then(()=>toast('HTML code copied!'));
    }

    // ===== Event wiring =====
    document.getElementById('btnAddField').addEventListener('click', ()=>{
      textFields.push({ id:Date.now().toString(), label:'New Field', value:'', type:'text' });
      renderTextFields(); updatePreview();
    });
    document.getElementById('btnCopySig').addEventListener('click', copySignature);
    document.getElementById('btnCopyHTML').addEventListener('click', copyHTML);

    // toggles
    document.getElementById('chkDark').addEventListener('change', e=>{ document.documentElement.classList.toggle('dark', e.target.checked); });
    document.getElementById('chkNoBorders').addEventListener('change', e=>{ removeBorders = e.target.checked; updatePreview(); });
    document.getElementById('chkMobile').addEventListener('change', e=>{
      const p = document.getElementById('signaturePreview');
      if(e.target.checked){ p.parentElement.style.maxWidth='340px'; p.style.fontSize='12px'; }
      else { p.parentElement.style.maxWidth=''; p.style.fontSize=''; }
    });
    
    // photo size slider
    document.getElementById('photoSizeSlider').addEventListener('input', e=>{ updatePhotoSize(e.target.value); });

    // uploads
    function init(){
      renderTextFields(); renderSocialFields(); updatePreview();
      wireUpload('#uaProfile', '#profilePhoto', '#profilePreview', 'profile');
      wireUpload('#uaLogo', '#companyLogo', '#logoPreview', 'logo');
    }
    init();
  </script>
</body>
</html>
